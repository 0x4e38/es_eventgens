"use strict";define(["jquery","underscore","backbone","module","views/Base","splunk.util","sa-threatintelligence/js/components/incident_review/eventsviewer/IREventViewerUtils","views/shared/eventsviewer/shared/WorkflowActions","sa-threatintelligence/js/components/incident_review/eventsviewer/CustomWorkflowActionsView","sa-threatintelligence/js/components/incident_review/eventsviewer/table/body/row/PrimaryWorkflowActions"],function(a,b,c,d,e,f,g,h,i,j){return e.extend({moduleId:d.id,tagName:"tr",initialize:function(){e.prototype.initialize.apply(this,arguments),this.interaction="i"+this.options.idx,this.rowExpanded="r"+this.options.idx,this.showAllLines="s"+this.options.idx,this.primaryRowFields=this.options.primaryRowFields,this.model.state.unset(this.showAllLines),this.model.renderer=this.collection.eventRenderers.getRenderer(this.model.event.get("eventtype"))},startListening:function(){this.listenTo(this.model.state,this.interaction,function(){this.isExpanded()||this.expand()}),this.listenTo(this.model.state,"change:"+this.rowExpanded,function(a,b,c){b||this.collapseState()}),this.listenTo(this.model.report.entry.content,"change:display.prefs.events.offset",this.collapseState),this.listenTo(this.model.state,"intentions-fetch",this.collapseState),this.listenTo(this.options.backboneEventMediator,"ir-remove-all-selected-row",function(){this.toggleCheckBox(!1,!0)}.bind(this)),this.listenTo(this.options.backboneEventMediator,"ir-select-all-row",function(){this.toggleCheckBox(!0,!1)}.bind(this)),this.listenTo(this.model.result.results,"reset",this.collapseState)},events:{"click td.expands":function(a){this.expand(),a.preventDefault()},"click td.col-visibility label.checkbox a.btn.show":function(a){this.toggleCheckBox(!0,!0)},"click ._time":function(b){b.preventDefault(),this.drilldown(a(b.currentTarget),b)},"keyup ._time":function(b){b.preventDefault(),13===b.which&&this.drilldown(a(b.currentTarget),b)},"click .ir-event-actions":function(a){a.preventDefault()},"mousedown .ir-event-actions":function(a){this.openEventActions(a,this.options.idx)},"keydown .ir-event-actions":function(a){13===a.keyCode&&this.openEventActions(a,this.options.idx)},"click .ir-row-field-actions":function(a){a.preventDefault()},"mousedown .ir-row-field-actions":"openRowFieldActions","keydown .ir-row-field-actions":function(a){13===a.keyCode&&this.openRowFieldActions(a)}},openRowFieldActions:function(b){var c=a(b.currentTarget),d=c.attr("data-field-name"),e=c.attr("data-field-value");return!(!this.children.fieldActions||!this.children.fieldActions.shown||(this.children.fieldActions.hide(),this.lastMenu!==d+"-row-field-actions"))||(this.children.fieldActions=new h({model:this.model,collection:this.collection.workflowActions,field:{name:d,value:e},mode:"menu",fieldName:d,fieldValue:e}),this.lastMenu=d+"-row-field-actions",this.children.fieldActions.render().appendTo(a("body")).show(c),b.preventDefault(),!1)},openEventActions:function(b,c){var d=a(b.currentTarget);return!(!this.children.rowActions||!this.children.rowActions.shown||(this.children.rowActions.hide(),this.lastMenu!==c+"-event-actions"))||(this.children.rowActions=new i({model:this.model,collection:this.collection.workflowActions,notableEventSuppressions:this.collection.notableEventSuppressions,mode:"menu",hactions:j}),this.lastMenu=c+"-event-actions",this.children.rowActions.render().appendTo(a("body")).show(d),b.preventDefault(),!1)},drilldown:function(a,b){var c,d,e=a.data();e.timeIso&&(c=e.timeIso,d=f.getEpochTimeFromISO(c),this.model.state.trigger("drilldown",{noFetch:!0,data:{"dispatch.earliest_time":d,"dispatch.latest_time":""+(parseFloat(d)+1)},event:b,_time:c,idx:this.options.idx}))},expand:function(a){this.options.allowRowExpand&&(this.isExpanded()?this.collapseState():this.expandState())},expandState:function(){return this.model.searchJob.isRunning()&&this.model.searchJob.isRealtime()?void alert(b("The search is still running; please finalize it first in order to view the details").t()):this.model.searchJob.isRunning()?void alert(b("The search is still running; please finalize it or wait for it to complete in order to view the details").t()):(this.model.state.set(this.rowExpanded,!0),this.toggleArrow(!0),this.$el.addClass("ir-splunk-offwhite-color"),void this.$el.addClass("ir-hide-bottom-border"))},collapseState:function(){this.model.state.set(this.rowExpanded,!1),this.toggleArrow(!1),this.$el.removeClass("ir-splunk-offwhite-color"),this.$el.removeClass("ir-hide-bottom-border")},isExpanded:function(){return this.model.state.get(this.rowExpanded)},toggleArrow:function(a){var b=this.$("td.expands > a > i").removeClass("icon-triangle-right-small icon-triangle-down-small");b.addClass(a?"icon-triangle-down-small":"icon-triangle-right-small")},toggleCheckBox:function(b,c){var d='<i class="icon-check ir-selected"></i>',e=this.$("td.col-visibility > label > a > i"),f=this.$("td.col-visibility > label > a"),g=a.trim(f.attr("data-ruleid")),h=a.trim(f.attr("data-status"));e.length>=1?c&&(f.empty(),this.collection.selectedRows.remove(this.collection.selectedRows.find(function(a){return a.has("id")&&a.get("id")===g},this)),this.options.backboneEventMediator.trigger("ir-remove-select-all-checkbox")):(b&&(this.collection.selectedRows.push({id:g,status:h}),f.append(d)),a("td.col-visibility .ir-selected").length===a("td.col-visibility .ir-label-checkbox").length&&this.options.backboneEventMediator.trigger("ir-add-select-all-checkbox"))},render:function(){var c=b.find(this.collection.selectedRows.models,function(a){return a.has("id")&&a.get("id")===f.fieldListToString(this.model.event.get("rule_id"))},this);return this.$el.html(this.compiledTemplate({$:a,event:this.model.event,application:this.model.application,expanded:this.isExpanded(),formattedTime:this.model.event.formattedTime(),_:b,primaryRowFields:this.options.primaryRowFields||[],getFieldValue:g.getFieldValue,convertFirstCharToUpperCase:g.convertFirstCharToUpperCase,splunkUtil:f,iconVisible:c,filedNameReplacementForActions:this.options.filedNameReplacementForActions,fieldFormating:this.options.fieldFormating})),this},close:function(){this.unbind(),this.remove(),this.stopListening()},template:'                    <td class="expands ir-veritcal-align">                        <a><i class="icon-triangle-<%- expanded ? "down" : "right" %>-small"></i></a>                    </td>                    <td class="col-visibility ir-check-limited-width ir-veritcal-align">                         <label class="checkbox ir-label-checkbox">                            <a data-ruleid="<%-splunkUtil.fieldListToString(event.get("rule_id"))%>"  data-status="<%-splunkUtil.fieldListToString(event.get("status"))%>" class="btn show">                                <% if (iconVisible) { %>                                    <i class="icon-check ir-selected"></i>                                 <%}%>                             </a>                        </label>                    </td>                    <% _(primaryRowFields).each(function(field, i) { %>                        <% if (field === "_time") { %>                            <td class="_time ir-veritcal-align">                        <% } else { %>                            <td class="ir-veritcal-align">                        <%}%>                            <% var fieldlist = [];                             if(event.has(field)){                                 fieldlist = event.get(field);                             } %>                             <% if(fieldlist.length > 0) { %>                                <%  _(fieldlist).each(function(mv_field, j) { %>                                    <% if (field === "_time") { %>                                        <%- formattedTime %>                                    <% } else { %>                                        <%if(field === "urgency") { %>                                                <% var value = getFieldValue(event, mv_field, field)%>                                                <% if(value==="info" || value==="informational") { %>                                                    <div class="icon-info-circle ir-icon-info-circle-style ir-row-hover-field ir-row-float-left">                                                <%} else if(value==="low") { %>                                                    <div class="icon-circle-filled ir-icon-circle-style ir-row-hover-field ir-row-float-left">                                                <%} else if(value==="medium") {%>                                                    <div class="icon-warning ir-icon-alert-circle-med-style ir-row-hover-field ir-row-float-left">                                                <%} else if(value==="high") {%>                                                    <div class="icon-warning ir-icon-alert-circle-high-style ir-row-hover-field ir-row-float-left">                                                <%} else if(value==="critical") {%>                                                    <div class="icon-alert ir-icon-alert-style ir-row-hover-field ir-row-float-left">                                                <%}%>                                                <% var urgencyTooltip = getFieldValue(event, event.get("priority"), "priority") + " priority and " + getFieldValue(event,  event.get("severity"), "severity") + " severity"%>                                                <span title="<%-urgencyTooltip%>" class="ir-urgency-default-text-style"><%-convertFirstCharToUpperCase(value)%></span>                                                </div>                                      <% } else if(field === "security_domain") { %>                                            <div class="ir-row-hover-field ir-row-float-left"><%-convertFirstCharToUpperCase(getFieldValue(event, mv_field, field))%> </div>                                        <%} else { %>                                            <div class="ir-row-hover-field ir-row-float-left"><%- getFieldValue(event, mv_field, field) %></div>                                        <%}%>                                            <% var field_name = filedNameReplacementForActions.hasOwnProperty(field) ? filedNameReplacementForActions[field] : field %>                                            <% var field_value = filedNameReplacementForActions.hasOwnProperty(field) ? getFieldValue(event, event.get(filedNameReplacementForActions[field]), filedNameReplacementForActions[field]) : getFieldValue(event, mv_field, field) %>                                            <div class="ir-row-show-on-hover ir-row-float-inherit">                                                <a class="ir-row-popdown-toggle ir-row-field-actions" data-field-name="<%- field_name %>" data-field-value="<%- field_value %>">                                                    <span class="caret"></span>                                                </a>                                            </div>                                    <%}%>                                <% }); %>                             <% } %>                         </td>                    <% });%>                    <td class="actions popdown ir-veritcal-align">                        <a class="ir-popdown-toggle ir-event-actions ir-btn-pill">                            <span class="caret"></span>                        </a>                    </td>'})});