"use strict";define(["jquery","underscore","splunkjs/mvc","splunkjs/mvc/utils","sa-utils/js/util/Utils","splunkjs/mvc/dropdownview","splunkjs/mvc/simpleform/input/text","splunkjs/mvc/searchmanager","module","views/shared/Modal","app-ess/js/util/InvestigativeCanvas","app-ess/js/views/CreateNewInvestigationView","css!./css/InvestigationDialog.css"],function(a,b,c,d,e,f,g,h,i,j,k,l){var m=j.extend({moduleId:i.id,initialize:function(){j.prototype.initialize.apply(this,arguments)},events:{"hide #event_action_create_new_investigation_modal":"showInvestigationModal","shown #event_action_create_new_investigation_modal":"focusView","click #event_action_create_new_investigation":"showCreateNewInvestigationModal","click #close_new_investigation_modal":"closeNewInvestigationModal","click #event_action_cancel_new_investigation":"closeNewInvestigationModal","click #event_action_inv_save":"saveToInvestigation","click #event_action_save_new_investigation":"saveNewInvestigation","click #event_action_back":"goBackForm"},showInvestigationModal:function(b){a(".add-event-to-investigation",this.$el).show()},closeNewInvestigationModal:function(){a("#event_action_create_new_investigation_modal",this.$el).modal("hide"),this.clearInputs()},focusView:function(){a("#event_action_text_input > .splunk-textinput > input",this.$el).focus()},showCreateNewInvestigationModal:function(b){a(".add-event-to-investigation",this.$el).hide(),a("#event_action_create_new_investigation_modal",this.$el).modal("show")},saveNewInvestigation:function(){var b=this;console.log("Saving new investigation...");var d=c.Components.get("event_action_text_input").val()||"";if(""==d.trim())a("#event_action_new_investigation_modal_message",this.$el).show();else{var e=a("#event_action_new_investigation_description_input",this.$el).val()||"",f={title:d,description:e},g=k.buildCanvasRecord(f);a.ajax({url:k.routes.create.canvas,type:"POST",data:g,success:function(a,d,e){if(b.closeNewInvestigationModal(),a.success){console.log("New investigation saved successfully.");var f=c.Components.get("event_action_investigations_input");f.settings.set("selectFirstChoice",!1),f.manager.startSearch(),f.val(a._key)}else console.error("There was a backend issue, attempting to save the new investigation.")},error:function(a,c,d){b.closeNewInvestigationModal(),console.error("There was an issue attempting to save the new investigation: "+d)}})}},clearInputs:function(){c.Components.get("event_action_text_input").val(""),a("#event_action_new_investigation_description_input",this.$el).val("")},saveToInvestigation:function(d){var e=this;console.log("Saving event to investigation..."),a("#event_action_inv_save",this.$el).text("Saving..."),a("#event_action_inv_save",this.$el).attr("disabled",!0);var f=this.model.event,g=c.Components.getInstance("event_action_investigations_input").val(),h={canvas_id:g,data:{type:"splunk_event.notable",content:{}},description:"",title:"Notable Event (Host: "+(f.get("orig_host")||"")+" | Sourcetype: "+(f.get("sourcetype")||"")+")",start_time:new Date(f.get("_time")).getTime()/1e3};b.each(f.keys(),function(a){h.data.content[a]=f.get(a)}),h.data=JSON.stringify(h.data),h=k.buildCanvasEntryRecord(h),a.ajax({url:k.routes.create.canvas_entry,type:"POST",data:h,success:function(b,c,d){b?(console.log("Event successfully saved to investigation."),e.showActionSuccessfulContent(!0),a("#event_action_inv_save",e.$el).text("Save"),a("#event_action_inv_save",e.$el).attr("disabled",!1)):(console.log("There was an issue saving the event to the investigation"),alert("There was an issue saving the event to the investigation"))},error:function(a,b,c){console.log("There was an issue saving the event to the investigation: "+c),alert("There was an issue saving the event to the investigation")}})},goBackForm:function(){this.showActionSuccessfulContent(!1)},showActionSuccessfulContent:function(b){"undefined"==typeof b&&(b=!0),b?(a(".show_on_success").show(),a(".show_when_editing").hide()):(a(".show_on_success").hide(),a(".show_when_editing").show())},revokeInstances:function(){c.Components.revokeInstance("event_action_investigations_input"),c.Components.revokeInstance("event_action_text_input")},_render:function(){if(this.revokeInstances(),!c.Components.hasInstance("ea_investigation_search")){var b=e.getCurrentUser(),i=btoa(b);new h({id:"ea_investigation_search",search:"| inputlookup investigative_canvas_lookup | where isnotnull('collaborators."+b+".has_write') OR owner=\""+b+"\" OR isnotnull('collaborators."+i+".has_write') | rename _key as key | eval canvas = title | fields key, canvas | sort + canvas",app:d.getCurrentApp()},{tokens:!0,tokenNamespace:"submitted"})}var j=new f({id:"event_action_investigations_input",selectFirstChoice:!0,showClearButton:!0,labelField:"canvas",valueField:"key",managerid:"ea_investigation_search",el:a("#event_action_investigations",this.$el)},{tokens:!0});j.render();var k=new g({id:"event_action_text_input",searchWhenChanged:!1,el:a("#event_action_text_input",this.$el)},{tokens:!0});return k.render(),this},render:function(){var b=this;return this.$el.html(this.template),a.when(e.hasCapability("edit_timeline"),e.hasCapability("admin_all_objects")).then(function(c,d){(c||d)&&(a("#event_action_create_new_investigation",b.$el).attr("disabled",!1),a("#event_action_inv_save",b.$el).attr("disabled",!1)),b._render()}),this},template:'<div class="modal-header add-event-to-investigation">             <button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>             <h3>Add Selected to Investigation</h3>         </div>         <div class="modal-body add-event-to-investigation">             <div class="hide show_on_success">                 <div class="alert alert-info">                     <i class="icon-alert"></i>Event was successfully added to the investigation                     <div id="close">                         <a data-dismiss="modal" aria-hidden="true" href="#">Close this dialog</a>                     </div>                 </div>             </div>             <div class="event_action_investigation_container show_when_editing">                 <div id="event_action_investigation_label" align="right" style="vertical-align: middle;">                     <label>Select an Investigation </label>                 </div>                 <div id="event_action_investigations" align="left"></div>             </div>         </div>         <div class="modal-footer add-event-to-investigation">             <button id="event_action_inv_cancel" class="btn pull-left" data-dismiss="modal" aria-hidden="true">Cancel</button>             <div class="pull-right">                 <div id=event_action_saved class="show_when_editing">                     <button id="event_action_create_new_investigation" disabled="disabled" class="btn btn-secondary">Create new investigation</button>                     <button id="event_action_inv_save" disabled="disabled" class="btn btn-primary">Save</button>                 </div>                 <div id="event_action_back" class="show_on_success pull-right" style="display:none;">                     <a id="back" href="#" class="btn">Add event to another investigation</a>                 </div>             </div>         </div>         <div id="event_action_new_investigation_modal"></div>         <!-- Create new Investigative Timeline Modal -->         <div tabindex="-1" id="event_action_create_new_investigation_modal" class="modal fade in hide">             <div class="modal-header new_investigation_modal-header">                 <button id="close_new_investigation_modal" type="button" class="close">&times;</button>                 <h3 class="text-dialog-title">Create New Investigation</h3>             </div>             <div class="modal-body modal-body-scrolling new_investigation_modal-body">                 <!-- No Title Error -->                 <div id="event_action_new_investigation_modal_message" class="alert alert-error hide">                     <div class="icon-alert"></div>                     <span id="message_text">Please enter a title</span>                 </div>                 <!-- Title -->                 <div class="new_investigation_modal_container">                     <div class="new_investigation_modal_label" align="right">                         <label class="required_field">Title </label>                     </div>                     <div id="event_action_text_input"></div>                 </div>                 <!-- Description -->                 <div class="new_investigation_modal_container">                     <div class="new_investigation_modal_label" align="right" style="vertical-align: top;">                         <label>Description </label>                     </div>                     <div>                         <textarea id="event_action_new_investigation_description_input" placeholder="Optional" style="height: 70px;"></textarea>                     </div>                 </div>             </div>             <div class="modal-footer new_investigation_modal-footer">                 <div style="float: left;">                     <a href="#" id="event_action_cancel_new_investigation" class="btn btn-dialog-cancel">Cancel</a>                 </div>                 <div>                     <a href="#" id="event_action_save_new_investigation" class="btn btn-primary">Save</a>                 </div>             </div>         </div>'});return m});