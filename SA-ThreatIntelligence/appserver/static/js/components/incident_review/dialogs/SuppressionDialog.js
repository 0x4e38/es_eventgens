"use strict";define(["jquery","underscore","backbone","views/Base","splunkjs/mvc/sharedmodels","views/shared/controls/Control","views/shared/controls/ControlGroup","sa-threatintelligence/js/models/CorrelationSearch","views/shared/controls/DateControl","models/shared/DateInput","./EventFields","views/shared/controls/LabelControl","views/shared/controls/LinkList","views/shared/Modal","views/shared/MultiStepModal","sa-threatintelligence/js/models/NotableEventSuppression","views/shared/controls/SyntheticCheckboxControl","views/shared/controls/TextControl","uri/route","util/splunkd_utils","module","css!./css/SuppressionDialog.css"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u){function v(a){return a.replace(/"/g,'\\"')}var w="notable_suppression-",x=e.get("user").entry.content.get("capabilities");e.get("user").dfd.done(function(){x=e.get("user").entry.content.get("capabilities")});var y=m.extend({events:{},setValue:function(a,b,c){f.prototype.setValue.apply(this,arguments)},render:function(){return this.$el.empty(),this.$el.append(a("<fieldset class='splunk-linklist-choices'/>")),this.options&&0!==this.options.length||(this.options=[{value:"",label:b("N/A").t()}]),b.each(this.options.items,function(c,d){var e=c.value?c.value:"",f=b.escape(c.label),g=a('<a href="#" class="btn-pill active" data-toggle="tooltip" data-placement="top" title="'+e+'">'+f+"</a>").attr({"data-value":e}).attr({"data-original-title":f});a(g).tooltip({delay:{show:500,hide:0}}),this.$el.append(g)},this),this.setValue(this._value,!1),this}}),z=c.Model.extend({defaults:function(){return{name:"",description:"",event:{},corsearch:new h,suppress_from:new j,errmsg:""}},initialize:function(a){if(c.Model.prototype.initialize.apply(this,arguments),this.suppressions=a.suppressions,b.isUndefined(this.suppress_to)){var d=new j;d.setFromJSDate(this.get("suppress_from").jsDate()),this.set("suppress_to",d)}this.populateSearch()},events:{"change:suppress_from change:suppress_to":"populateSearch","click #btn_change":function(){this.viewstack.setSelectedIndex(1)}},populateSearch:function(){var a=this.get("event"),c=this.toJSON(),d=Date.parse(c.suppress_from.jsDate().toDateString())/1e3,e=Date.parse(c.suppress_to.jsDate().toDateString())/1e3,f=this.get("selectedfields"),g="`get_notable_index`"+(a.has("source")?' source="'+v(a.get("source")[0])+'"':""),h=f.reduce(function(c,d){var e=d.get("name"),f="";return b.each(a.get(e),function(a){var c,d=a.toLowerCase();c="true"===d||"false"!==d&&(b.isNaN(Number(d))?'"'+v(a)+'"':Number(d)),f+=" "+e+"="+c}),c+f},g)+" _time>="+d;return e!==d&&(h+=" _time<="+e),this.set("search",h),h},_nameExists:function(a){var b=w+a,c=this.suppressions;return!(!c||c.indexOf(b)===-1)},validate:function(a,c){var d={},e=a.suppress_from.jsDate().valueOf(),f=a.suppress_to.jsDate().valueOf();this.suppressions;if("string"!=typeof a.name||0===a.name.length?d.name="Suppression name cannot be empty":a.name.search(/[^\w \-]/)!==-1?d.name="Suppression name can only have alpha-numeric characters, space, dash and underscore":this._nameExists(a.name)&&(d.name="A suppression of the same name already exists"),"string"==typeof a.search&&0!==a.search.length||(d.preview="Invalid search"),f<e&&(d.period="Suppression end time should be later than start time"),b.size(d))return d}}),A=d.extend({moduleId:u.id,events:{"click .btn-primary":"save","click #change_field":function(){this.trigger("switch")}},genSuppressionName:function(a,c){var d=a.replace(/ /g,"_"),e=new RegExp(w+d+"_(\\d+)");return c.indexOf(w+d)===-1?d:d+"_"+b.chain(c).map(function(a){var b=a.match(e);return null!==b?parseInt(b[1],10)+1:1}).max().value()},initialize:function(){d.prototype.initialize.apply(this,arguments);var a=this.model.event,c=this.collection.selectedFields,e=a.get("rule_name")[0],f=a.get("_time"),h=f&&f.length>0&&f[0],k=h?new Date(h):new Date,m=new j;m.setFromJSDate(k),this.allowSave=!1;var n=(this.suppression=new p,this.collection.notableEventSuppressions.map(function(a){return a.entry.get("name")})),o=this.genSuppressionName(e,n),q=this.data=new z({name:o,description:"",event:a,selectedfields:this.collection.selectedFields,suppressions:n,suppress_from:m});this.children.name=new g({label:b("Suppression Name").t(),required:!0,controlType:"Text",controlOptions:{model:q,modelAttribute:"name",className:"suppression-label"}}),this.children.description=new g({label:b("Description (optional)").t(),validate:!0,controlType:"Textarea",controlOptions:{model:q,modelAttribute:"description",className:"suppression-label"}}),this.children.period=new g({label:b("Suppress From").t(),help:b("Suppression will only happen during this period.").t(),controls:[new i({model:q.get("suppress_from"),validate:!0,forceUpdate:!0,className:"suppression-calendar suppress-from"}),new l({defaultValue:b("To").t(),className:"suppress-to-label"}),new i({model:q.get("suppress_to"),validate:!0,forceUpdate:!0,className:"suppression-calendar suppress-to"})]}),this.children.selected_fields=new g({label:b("Selected Fields").t(),controlType:"ModLinkList",help:b("Selected fields with this suppression. ").t()+'<a id="change_field">'+b("change").t()+"</a>",controlTypes:{ModLinkList:y},controlOptions:{items:b.map(c.toJSON(),function(b){var c=b.name;return{label:c,value:a.get(c)}}),placeholder:b("Choose groups").t(),collectionMethod:"getAllTags",className:"suppression-label"}}),this.children.preview=new g({label:b("Search Preview").t(),controlType:"Textarea",enabled:!1,controlOptions:{model:q,modelAttribute:"search",additionalClassNames:"suppression-label"}}),this.children.message=new g({label:"",controlType:"Label",error:!0,controlOptions:{model:q,modelAttribute:"errmsg"}})},startListening:function(){this.listenTo(this.data.get("suppress_from"),"change",function(){var a=this.children.period.$(".suppress-to input[type=text]").val();if(0===a.length&&this.data.has("suppress_to")){var b=this.data.get("suppress_to");b.setFromJSDate(this.data.get("suppress_from").jsDate(),{silent:!0})}this.updatePreview()}),this.listenTo(this.data.get("suppress_to"),"change",this.updatePreview),this.listenTo(this.collection.selectedFields,"reset add remove",function(){var a=this.model.event,c=b.map(this.collection.selectedFields.toJSON(),function(b){var c=b.name;return{label:c,value:a.get(c)}}),d=this.children.selected_fields.getAllControls()[0];d.options.items=c,d.render(),this.updatePreview()}),this.listenTo(this.data,"change:errmsg",function(){if(""!==this.data.get("errmsg")){var a=this.children.message,c=this.data;a.show(),b.delay(function(){c.unset("errmsg",{silent:!0}),a.$el.fadeOut(1e3)},5e3)}})},updatePreview:function(){this.data.populateSearch()},setError:function(a){this.data.set("errmsg",a)},save:function(a){var c={app:"SA-ThreatIntelligence",owner:this.model.application.get("owner"),sharing:"global"},d=new p,e=this.data,f=this.children;if(b.each(f,function(a){a.$el.hasClass("error")&&(a.setHelpText(a._helpText),delete a._helpText,a.error(!1,""))}),!e.isValid()){var g=e.validationError;return void b.each(g,function(a,c){if(b.has(f,c)){var d=f[c];d.error(!0,a),d._helpText=d.$(".help-block").text(),d.setHelpText(a)}else console.error("Unknown field",c)})}d.entry.content.set({name:w+e.get("name"),description:e.get("description"),search:e.get("search"),disabled:!1},{silent:!0});var h=d.save({},{data:c});h&&(this.$(".btn-primary").text("Saving"),h.done(function(a,c,e){this.collection.notableEventSuppressions.push(d),this.$(".btn-primary").text("Saved"),b.delay(b.bind(function(){this.trigger("saved")},this),1e3)}.bind(this)).fail(function(a){this.setError("Failed to save suppression: "+a.responseJSON.messages[0].text),this.$el.find(".modal-body").animate({scrollTop:0},"fast"),this.$(".btn-primary").text("Save")}.bind(this)))},disableSave:function(){this.allowSave=!1,this.$("a.btn-primary").addClass("disable")},enableSave:function(){this.allowSave=!0,this.$("a.btn-primary").removeClass("disable")},render:function(){var a=b.indexOf(x,"edit_suppressions")>-1,c=b("You do not have the necessary capabilities           required to edit Notable Event Suppressions. Please contact           your Splunk administrator.").t();if(this.$el.html(n.TEMPLATE).addClass("suppression_dialog"),this.$(n.HEADER_TITLE_SELECTOR).html(b("Suppress Notable Events").t()),!a)return this.$(n.BODY_SELECTOR).append(c),this;this.$(n.BODY_SELECTOR).append(n.FORM_HORIZONTAL_COMPLEX);var d='<span class="icon-calendar"></span>',e=this.$(n.BODY_FORM_SELECTOR);this.$(n.FOOTER_SELECTOR);return this.children.name.render().appendTo(e),this.children.description.render().appendTo(e),this.children.period.render().appendTo(e),this.children.period.$("span.suppression-calendar").after(d),e.append('<div class="suppression-divider"></div>'),this.children.selected_fields.render().appendTo(e),this.children.preview.render().appendTo(e),this.children.message.render().hide(),this.children.message.appendTo(e),this.$(n.FOOTER_SELECTOR).append(n.BUTTON_CANCEL),this.$(n.FOOTER_SELECTOR).append(n.BUTTON_SAVE),this.allowSave||this.$("a.btn-primary").addClass("disable"),this.children.period.$(".suppress-to input[type=text]").val(""),this}}),B=d.extend({events:{"click .modal-btn-back":function(a){this.trigger("switch")},"click a.control-clear":function(a){this.children.eventFields.setFilter(""),this.children.eventFields.render(),a.preventDefault()},"keyup input.search-query":function(a){var b=a.target.value;13!==a.keyCode&&0!==b.length||(this.children.eventFields.setFilter(b),this.children.eventFields.render(),a.preventDefault())}},initialize:function(){var a=this.data=new c.Model({setDefault:0});d.prototype.initialize.apply(this,arguments),this.children.filter=new g({label:b("Check a set of fields below you wish to suppress.").t(),className:"suppression-fields-select",controlType:"Text",controlOptions:{defaultValue:"",placeholder:"search",canClear:!0,inputClassName:"search-query"}}),this.children.eventFields=new k({model:{event:this.model.event,report:this.model.report,application:this.model.application},collection:{selectedFields:this.collection.selectedFields},selectableFields:!0,clickFocus:"tr.shared-eventsviewer-table-body-secondaryrow"}),this.children.setDefault=new q({model:a,modelAttribute:"setDefault",label:"set your selection as default",additionalClassNames:"pull-left modal-footer-note"})},startListening:function(){this.children.eventFields.startListening()},render:function(){var c='<a href="#" class="btn back modal-btn-back pull-left icon-arrow-left">'+b(" Back").t()+"</a>",d="Default fields will be automatically selected next time when you suppress the same type of events.",e=a('<a href="#" class="tooltip-link">'+b("?").t()+"</a>"),f=b.indexOf(x,"edit_correlationsearches")>-1;return this.$el.html(n.TEMPLATE),this.$(n.HEADER_TITLE_SELECTOR).html(b("Suppress Notable Events").t()),this.$(n.BODY_SELECTOR).append(n.FORM_HORIZONTAL),this.children.filter.render().appendTo(this.$(n.BODY_FORM_SELECTOR)),this.children.eventFields.render().appendTo(this.$(n.BODY_FORM_SELECTOR)),this.$(n.FOOTER_SELECTOR).append(c),f&&(this.children.setDefault.render(),e.appendTo(this.children.setDefault.$("label")),e.tooltip({animation:!1,title:d,container:"body"}),this.children.setDefault.appendTo(this.$(n.FOOTER_SELECTOR))),this}});return o.extend({className:n.CLASS_NAME+" "+n.CLASS_MODAL_WIDE,initialize:function(){o.prototype.initialize.apply(this,arguments),this.notableEventSuppressions=this.options.notableEventSuppressions;var a=this.model.event,d=a.has("source")?a.get("source")[0]:"",e=new h,f=new c.Collection;this.children.main=new A({model:this.model,collection:{selectedFields:f,notableEventSuppressions:this.notableEventSuppressions}}),this.children.change=new B({model:this.model,collection:{selectedFields:f}}),this.children.main.startListening(),this.children.change.startListening(),e.fetch({url:t.fullpath(e.url+"/"+d),success:b.bind(function(a,c,d){var g=e.entry.content,h=b.map(g.get("nes_fields").split(","),function(a){return{name:a}});this.children.main.enableSave(),f.reset(h)},this),error:b.bind(function(a,b,c){this.children.main.enableSave(),this.children.main.setError("Failed to fetch correlation search "+d)},this)}),this.stepViewStack.setSelectedIndex(0),this.listenTo(this.children.main,"switch",function(){this.stepViewStack.setSelectedIndex(1)}),this.listenTo(this.children.main,"saved",function(){this.hide()}),this.listenTo(this.children.change,"switch",function(){var a=this.children.change.data.get("setDefault");if(a){var c=f.pluck("name").sort().join(","),d=e.entry.content.get("rule_name"),g=this.children.main.$(".btn-primary");e.entry.content.clear(),e.entry.content.set({rule_name:d,nes_fields:c}),e.save({},{success:function(a,b,c){g.text("Save"),g.removeClass("disable")},error:b.bind(function(a,b,c){this.children.main.setError("Failed to set default fields"),g.text("Save"),g.removeClass("disable")},this)}),g.text("Saving default fields"),g.addClass("disable")}this.stepViewStack.setSelectedIndex(0)})},getStepViews:function(){return[this.children.main,this.children.change]}})});