"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function _inherits(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();define(["jquery","underscore","sa-threatintelligence/js/components/response/ModularAlertManager","views/shared/Modal"],function(a,b,c,d){var e=function(e){function f(){return _classCallCheck(this,f),_possibleConstructorReturn(this,(f.__proto__||Object.getPrototypeOf(f)).apply(this,arguments))}return _inherits(f,e),_createClass(f,[{key:"events",value:function(){return{"click #mld-execute":"executeAlerts","click .dropdown-menu":function(a){return a.preventDefault(),!1}}}},{key:"initialize",value:function(){var a=this;d.prototype.initialize.apply(this,arguments),this.mlm=new c({recommended_actions:this.model.event.get("recommended_actions")||[],filterAlerts:function(a){return"notable"===a.name||!a.supportsAdhoc()},onAlertAdd:function(){a.setButtonState(0!==a.mlm.getEnabledAlerts().length)},onAlertRemove:function(){a.setButtonState(0!==a.mlm.getEnabledAlerts().length)},attachDialogTo:this.$el})}},{key:"_modularAlertTemplate",value:function(){return'\n                <div class="alert-result">\n                    <ul style="list-style-type: none;"></ul>\n                </div>\n                <h3>Select actions to run.</h3>\n            '}},{key:"_executeAlert",value:function(c,d){var e=this,f=new a.Deferred,g=function(a,b){return e.model.event.get(a)&&e.model.event.get(a)[0]||b},h=parseInt(Splunk.util.getEpochTimeFromISO(g("_time","0")),10),i=g("source","*").replace('"','\\"'),j=g("event_id","*").replace('"','\\"'),k=b.extend({},{search:'`notable_adhoc_invocation("'+h+'", "'+i+'", "'+j+'")` | head 1',action_name:c},d);return a.ajax({url:Splunk.util.make_url("/splunkd/__raw/services/alerts/modaction_adhoc?output_mode=json"),type:"POST",async:!0,data:k,success:function(a){f.resolve(a)},error:function(a){f.reject(a.responseText)}}),f}},{key:"executeAlerts",value:function(c){var d=this;c.preventDefault();var e=this.mlm.getEnabledAlerts(),f=e.map(function(a){var b=d.mlm.getConfigByAlert(a);return delete b["action."+a],{name:a,label:d.mlm.alerts[a].label,icon:d.mlm.alerts[a].getIconUrl(),status:d._executeAlert(a,b)}});f.forEach(function(c){var e=new a(b.template('\n                    <li data-name="<%- alert.name %>">    \n                        <span class="status"></span>\n                    </li>',{alert:c}));d.$el.find(".alert-result ul").append(e),a.when(c.status).then(function(a){var f='\n                        <div class="alert alert-info" style="display: inline-block;">\n                            <i class="icon-alert"></i>\n                            <img src="<%= encodeURI(icon) %>" style="height: 20px;" /> \n                            &quot;<b><%- label %></b>&quot; <%- _(\'has been dispatched. Check the status of the action in the notable event details.\').t() %>\n                        <div/>';e.find(".status").html(b.template(f,{label:c.label,icon:c.icon})),d.mlm.removeAlert(c.name)}).fail(function(a){var d='\n                        <div class="alert alert-error" style="display: inline-block;">\n                            <i class="icon-alert"></i> \n                            <img src="<%= encodeURI(icon) %>" style="height: 20px;" /> \n                            &quot;<b><%- label %></b>&quot; <%- _(\'could not be dispatched\').t() %>: <br />\n                            <%- status %>\n                        </div>';e.find(".status").html(b.template(d,{status:a,label:c.label,icon:c.icon}))})})}},{key:"setButtonState",value:function(a){a?this.$el.find("#mld-execute").prop("disabled",!1).removeClass("disabled"):this.$el.find("#mld-execute").prop("disabled",!0).addClass("disabled")}},{key:"render",value:function(){var c=this;return d.prototype.render(this,arguments),this.$el.attr("id","adaptive-response-actions"),this.$el.html(d.TEMPLATE),this.$(d.HEADER_TITLE_SELECTOR).html(b("Adaptive Response Actions").t()),this.$el.find(d.BODY_SELECTOR).html(this._modularAlertTemplate()),this.$el.find(d.FOOTER_SELECTOR).html(b.template('<a href="#" id="mld-execute" class="btn btn-primary modal-btn-primary pull-right disabled"><%- _("Run").t() %></a>')),this.setButtonState(!1),a.when(this.mlm.render()).then(function(a){c.$el.find(d.BODY_SELECTOR).append(a.$el),c.options.hasOwnProperty("preselected")&&c.options.preselected.forEach(function(b){a.addAlert(b)})}),this.$el.css("width","750px"),this.$el.css("margin-left","-375px"),this}}]),f}(d);return e});