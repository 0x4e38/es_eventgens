"use strict";require.config({paths:{text:"../app/SA-Utils/js/lib/text",bootstrap_duallistbox:"../app/SA-ThreatIntelligence/contrib/bootstrap-duallistbox/jquery.bootstrap-duallistbox.min"},shim:{bootstrap_duallistbox:{deps:["jquery"]}}}),define(["underscore","backbone","jquery","sa-threatintelligence/js/components/response/ModularAlert","views/shared/controls/ControlGroup","splunk.util","text!sa-threatintelligence/js/components/response/ModularAlertActionRecommendations.html","css!sa-threatintelligence/contrib/bootstrap-duallistbox/bootstrap-duallistbox.min.css","bootstrap_duallistbox"],function(a,b,c,d,e,f,g){return d.extend({events:{"click .drilldown_earliset_offset":"setDrillDownEarliestOffset","click .drilldown_latest_offset":"setDrillDownLatestOffset","click .insert_next_step_action li > a":"insertNextStepAction"},initialize:function(){var c=this;d.prototype.initialize.apply(this,arguments),this.options=a.extend({},this.defaults,this.options),this.recommended_actions_duallistbox=null,this.model=new b.Model({}),this._nextSteps=new b.Model({version:1,text:""}),this.children={},this.allAlertActions=this.options.allAlertActions,this.model.on("change:action.notable.custom.next_steps",function(){var a=JSON.parse(c.model.get("action.notable.custom.next_steps"));1===a.version&&a.data!==c._nextSteps.get("text")&&c._nextSteps.set("text",a.data)}),this._nextSteps.on("change:text",function(){var a=JSON.stringify({version:c._nextSteps.get("version"),data:c._nextSteps.get("text")});a!==c.model.get("action.notable.custom.next_steps")&&c.model.set("action.notable.custom.next_steps",a)})},getConfig:function(){var a=this,b={domain:this.model.get("action.notable.custom.domain")};return this.configured&&(b["action."+this.name]=this.enabled?1:0,this.enabled&&(Object.keys(this.model.attributes).map(function(c){var d=c.split(".");"action"===d[0]&&"custom"===d[2]&&4===d.length?"drilldown_earliest_offset"===d[3]||"drilldown_latest_offset"===d[3]?b[d[3]]=a._convertDurationToSeconds(a.model.attributes[c]):b[d[3]]=a.model.attributes[c]:b[c]=a.model.attributes[c]}),b.recommended_actions=this._getSelectedRecommendedActions())),b},setConfig:function(a,b){var c=this,d=a.split(".");if("action"!==d[0]||d[1]!==this.name)throw"invalid argument";if(this.configured=!0,2===d.length&&d[1]===this.name){var e=this.enabled;this.enabled=1==b,e!==this.enabled&&this._onEnableChange(this.name,this.enabled)}else if("action.notable.custom.recommended_actions"===a)this._setSelectedRecommendedActions(b);else if("action.notable.custom.domain"===a){if(""!==b){var f=this.model.get("action.notable.custom.domains");f?f.forEach(function(d){d.toLowerCase()===b&&c.model.set(a,d)}):this.model.set(a,b)}}else"action.notable.custom.severity"===a?""!==b&&this.model.set(a,b):(this._setSelectControlItems(a,b),this.model.set(a,b))},_convertDurationToSeconds:function(a){if(null===a||void 0===a||0===a.length)return null;if("$info_min_time$"===a||"$info_max_time$"===a)return a;var b=/^([0-9]+)\s*(h|s|m|d|y|mon|w|)$/i,c=b.exec(a);if(!c)return a;var d=parseInt(c[1],10),e=c[2];if(null===e||0===e.length)return d;if(e=e.toLowerCase(),null===d||0===d.length)return 0;var f={s:1,m:60,h:3600,d:86400,w:604800,mon:2592e3,y:31536e3};return f.hasOwnProperty(e)?d*f[e]:d},getCustomKeys:function(){return["action.notable.custom.rule_title","action.notable.custom.rule_description","action.notable.custom.domains","action.notable.custom.domain","action.notable.custom.severities","action.notable.custom.severity","action.notable.custom.owners","action.notable.custom.default_owner","action.notable.custom.statuses","action.notable.custom.default_status","action.notable.custom.drilldown_name","action.notable.custom.drilldown_search","action.notable.custom.drilldown_earliest_offset","action.notable.custom.drilldown_latest_offset","action.notable.custom.next_steps","action.notable.custom.recommended_actions"]},setDrillDownEarliestOffset:function(){this.model.set("action.notable.custom.drilldown_earliest_offset","$info_min_time$")},setDrillDownLatestOffset:function(){this.model.set("action.notable.custom.drilldown_latest_offset","$info_max_time$")},insertNextStepAction:function(a){a.preventDefault();var b=c(a.currentTarget).data("name"),d=this._nextSteps.get("text")||"";this._nextSteps.set("text",d+"[[action|"+b+"]]")},render:function(){this.children.rule_title=new e({className:"control-group",controlType:"Text",controlClass:"controls-block",controlOptions:{modelAttribute:"action.notable.custom.rule_title",model:this.model},label:a("Title").t(),help:a("Notable events created by this search will have this title. Supports variable substitution.").t()}),this.children.rule_description=new e({className:"control-group",controlType:"Text",controlClass:"controls-block",controlOptions:{modelAttribute:"action.notable.custom.rule_description",model:this.model},label:a("Description").t(),help:a("Notable events created by this search will have this description. Supports variable substitution.").t()}),this.children.security_domains=new e({className:"control-group",controlType:"SyntheticSelect",controlClass:"controls-block",controlOptions:{modelAttribute:"action.notable.custom.domain",model:this.model,toggleClassName:"btn",popdownOptions:{attachDialogTo:".modal:visible",scrollContainer:".modal:visible .modal-body:visible"}},label:a("Security Domain").t()}),this.children.notable_severities=new e({className:"control-group",controlType:"SyntheticSelect",controlClass:"controls-block",controlOptions:{modelAttribute:"action.notable.custom.severity",model:this.model,toggleClassName:"btn",popdownOptions:{attachDialogTo:".modal:visible",scrollContainer:".modal:visible .modal-body:visible"}},label:a("Severity").t()}),this.children.notable_owners=new e({className:"control-group",controlType:"SyntheticSelect",controlClass:"controls-block",controlOptions:{modelAttribute:"action.notable.custom.default_owner",model:this.model,toggleClassName:"btn",popdownOptions:{attachDialogTo:".modal:visible",scrollContainer:".modal:visible .modal-body:visible"}},label:a("Default Owner").t()}),this.children.notable_statuses=new e({className:"control-group",controlType:"SyntheticSelect",controlClass:"controls-block",controlOptions:{modelAttribute:"action.notable.custom.default_status",model:this.model,toggleClassName:"btn",popdownOptions:{attachDialogTo:".modal:visible",scrollContainer:".modal:visible .modal-body:visible"}},label:a("Default Status").t()}),this.children.drilldownname=new e({className:"control-group",controlType:"Text",controlClass:"controls-block",controlOptions:{modelAttribute:"action.notable.custom.drilldown_name",model:this.model},label:a("Drill-down name").t(),help:a("Supports variable substitution with fields from the matching event.").t()}),this.children.drilldownsearch=new e({className:"control-group",controlType:"Text",controlClass:"controls-block",controlOptions:{modelAttribute:"action.notable.custom.drilldown_search",model:this.model},label:a("Drill-down search").t(),help:a("Supports variable substitution with fields from the matching event.").t()}),this.children.drilldown_earliest_offset=new e({className:"control-group",controlType:"Text",controlClass:"controls-block",controlOptions:{modelAttribute:"action.notable.custom.drilldown_earliest_offset",model:this.model},label:a("Drill-down earliest offset").t(),help:a('Set the amount of time before the triggering event to search for related events. For example, 2h. Use <a class="drilldown_earliset_offset">$info_min_time$</a> to set the drill-down time to match the earliest time of the search').t()}),this.children.drilldown_latest_offset=new e({className:"control-group",controlType:"Text",controlClass:"controls-block",controlOptions:{modelAttribute:"action.notable.custom.drilldown_latest_offset",model:this.model},label:a("Drill-down latest offset").t(),help:a('Set the amount of time after the triggering event to search for related events. For example, 1m. Use <a class="drilldown_latest_offset">$info_max_time$</a> to set the drill-down time to match the latest time of the search').t()}),this.children.next_steps=new e({className:"control-group",controlType:"Textarea",controlClass:"controls-block",controlOptions:{modelAttribute:"text",model:this._nextSteps,trimTrailingSpace:!1},label:a("Next Steps").t(),help:a("Describe next steps and response actions that an analyst could take to address this threat. Add a link to an action with the syntax: "+a.escape("[[action|nameOfAction]]")+".").t()}),this.$el.append('<form class="form-horizontal form-complex"></form>');var b=c("form",this.$el);this.children.rule_title.render().appendTo(b),this.children.rule_description.render().appendTo(b),this.children.security_domains.render().appendTo(b),this.children.notable_severities.render().appendTo(b),this.children.notable_owners.render().appendTo(b),this.children.notable_statuses.render().appendTo(b),this.children.drilldownname.render().appendTo(b),this.children.drilldownsearch.render().appendTo(b),this.children.drilldown_earliest_offset.render().appendTo(b),this.children.drilldown_latest_offset.render().appendTo(b),this.children.next_steps.render().appendTo(b);var d=this._getAllAlertActions(function(a){return"notable"!==a.name});b.append(a.template(g,{responses:d})),this.recommended_actions_duallistbox=c("#modalert_action_recommendations",this.$el).bootstrapDualListbox({bootstrap2Compatible:!0,nonSelectedListLabel:"All",selectedListLabel:"Recommended",infoText:!1}),this.children.next_steps.$el.find("textarea").css("height","150px");var f=this._getAllAlertActions(function(a){return"notable"!==a.name&&a.supportsAdhoc()});this.children.next_steps.$el.find(".controls").prepend(a.template('<div class="insert_next_step_action" style="padding-top: 5px; width: 60px;">\n                            <div class="btn-group dropdown-secondary">\n                                <a class="dropdown-toggle" data-toggle="dropdown" href="#">Insert Adaptive Response Action</a>\n                            <div class="dropdown-menu" style="width: 200px;">\n                                <div class="arrow" aria-hidden="true"></div>\n                                <ul>\n                                    <% actions.forEach(function(action) { %><li><a data-name="<%- action.name %>" href="#"><%- action.label %></a><li><% }) %>\n                                </ul>\n                            </div>\n                        </div>',{actions:f}))},_setSelectControlItems:function(a,b){if("action.notable.custom.domains"===a){var c=this._getItems(b,!1);void 0===this.model.get("action.notable.custom.domain")&&this.model.set("action.notable.custom.domain",c[0].value),this.children.security_domains.getAllControls()[0].setItems(c,{skipRender:!1})}else if("action.notable.custom.severities"===a){var d=this._getItems(b);void 0===this.model.get("action.notable.custom.severity")&&this.model.set("action.notable.custom.severity",d[0].value),this.children.notable_severities.getAllControls()[0].setItems(d,{skipRender:!1})}else"action.notable.custom.owners"===a?this.children.notable_owners.getAllControls()[0].setItems(this._getItems(b,!1,"(leave as system default)",!0),{skipRender:!1}):"action.notable.custom.statuses"===a&&this.children.notable_statuses.getAllControls()[0].setItems(this._getItems(b,!1,"(leave as system default)",!0),{skipRender:!1})},_getItems:function(a,b,c,d){var e=[];return c&&e.push({label:c,value:""}),a.forEach(function(a){b?e.push({label:a,value:a.toLowerCase()}):d?e.push({label:a.label,value:a.value}):e.push({label:a,value:a})}),e},_getAllAlertActions:function(){var a=this,b=arguments.length>0&&void 0!==arguments[0]?arguments[0]:function(){return!0};return Object.keys(this.allAlertActions).map(function(b){return a.allAlertActions[b]}).filter(b).map(function(a){return{label:a.label,name:a.name}})},_getSelectedRecommendedActions:function(){var a=c("#modalert_action_recommendations",this.$el).val();return a?a.join():""},_setSelectedRecommendedActions:function(a){void 0!==a?(c("#modalert_action_recommendations option:selected",this.$el).prop("selected",!1),selected_actions=a.split(","),c("#modalert_action_recommendations",this.$el).val(selected_actions),this.recommended_actions_duallistbox.bootstrapDualListbox("refresh")):console.log("modalert actions values not provided.")}})});