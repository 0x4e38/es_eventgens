"use strict";require.config({paths:{text:"../app/SA-Utils/js/lib/text"}}),define(["underscore","backbone","jquery","splunkjs/mvc/simplesplunkview","views/shared/controls/ControlGroup","sa-threatintelligence/js/components/response/ModularAlert","sa-threatintelligence/js/components/response/EmailModularAlert","sa-threatintelligence/js/components/response/ScriptModularAlert","sa-threatintelligence/js/components/response/NotableModularAlert","text!sa-threatintelligence/js/components/response/ModularAlertManager.html","text!sa-threatintelligence/js/components/response/ModularAlertManagerMenuEntry.html","text!sa-threatintelligence/js/components/response/DefaultModularAlert.html","css!sa-threatintelligence/js/components/response/ModularAlertManager.css","sa-utils/js/util/Console"],function(a,b,c,d,e,f,g,h,i,j,k,l){var m=d.extend({className:"ModularAlertManager",defaults:{recommended_actions:[],show_recom_act_chkbox:!0,addBultinAlerts:!0,filterAlerts:function(a){return!1},onAlertAdd:function(){},onAlertRemove:function(){}},events:{"click .remove-alert-action":"_removeAlert","click .alert-add-menu .dropdown-menu > ul.alert-dropdown-list > li > a":"_addAlert","click a.accordion-toggle":"_toggleAccorgion","click .dropdown-controls":function(a){return a.preventDefault(),!1},"click #response-action-dropdown-toggle":"adjustMinHeight"},initialize:function(){var c=this;this.options=a.extend({},this.defaults,this.options),this._rendered=!1,this._fetched=null,this.alerts={},this.unknownAlertConfig={},this.children={},this.model1=new b.Model({}),this.model1.on("change",function(){c._filterAlerts()}),this.height_adjusted=!1},adjustMinHeight:function(a){this.height_adjusted||(this.$el.css({"min-height":400}),this.height_adjusted=!0)},getAlertNames:function(){var a=this;return Object.keys(this.alerts).map(function(b){return a.alerts[b].name})},_filterAlerts:function(){var b=this,d=Splunk.util.normalizeBoolean(this.model1.get("recommendedonly"))||!1,e=this.model1.get("category")||"All",f=this.model1.get("search")||"";this.$el.find(".alert-menu-entry").each(function(g,h){var i=b.alerts[c(h).find("a[data-name]").data("name")],j=i.label.toLocaleLowerCase().indexOf(f.toLocaleLowerCase())!==-1,k=i.getCategories().indexOf(e)!==-1||e===a("All").t(),l=!0,m=i.name;d===!0&&(b.options.recommended_actions.length>0?(recommended_actions=b.options.recommended_actions[0].split(","),recommended_actions.includes(m)===!1&&(l=!1)):l=!1),k&&j&&l?c(h).show():c(h).hide()})},_addAlert:function(a){a.preventDefault(a),this.addAlert(c(a.currentTarget).data("name"))},addAlert:function(a){if(!this.alerts.hasOwnProperty(a))return!1;var b=this.alerts[a];return!b.enabled&&(b.setConfig("action."+a,1),this._toggleAccorgionByName(b.name),this._renderAddMenu(),this.options.onAlertAdd(a),!0)},_toggleAccorgion:function(a){a.preventDefault(),this._toggleAccorgionByName(a.currentTarget.dataset.name)},_toggleAccorgionByName:function(b){var d=this.$el.find("div#alert-"+a.escape(b)),e=function(a){a.removeClass("active"),c(".icon-accordion-toggle",a).addClass("icon-chevron-right"),c(".icon-accordion-toggle",a).removeClass("icon-chevron-down")},f=function(a){a.addClass("active"),c(".icon-accordion-toggle",a).addClass("icon-chevron-down"),c(".icon-accordion-toggle",a).removeClass("icon-chevron-right")};d.hasClass("active")?e(d):(e(c("div:not(#alert-"+a.escape(b)+")")),f(d))},_removeAlert:function(a){a.preventDefault(),this.removeAlert(c(a.currentTarget).data("name"))},removeAlert:function(a){if(!this.alerts.hasOwnProperty(a))return!1;var b=this.alerts[a];return!!b.enabled&&(b.setConfig("action."+a,0),this._renderAddMenu(),this.options.onAlertRemove(a),!0)},getDisabledAlerts:function(){var a=this;return Object.keys(this.alerts).filter(function(b){return!a.alerts[b].enabled})},getEnabledAlerts:function(){var a=this;return Object.keys(this.alerts).filter(function(b){return a.alerts[b].enabled})},setConfig:function(a){var b=this,c=!1;return Object.keys(a).map(function(d){var e=d.split(".");if(e.length<2||"action"!==e[0])console.log("ModularAlertManager: ignore config: "+d);else{var f=e[1];b.alerts.hasOwnProperty(f)?b.alerts[f].setConfig(d,a[d]):(b.unknownAlertConfig.hasOwnProperty(d)&&console.log("ModularAlertManager: doublicate unknown config; old entry will be overwritten: "+d),b.unknownAlertConfig[d]=a[d],c=!0)}}),this._renderAddMenu(),c},getConfig:function(){var b=a.extend({},this.unknownAlertConfig),c=this.alerts;return Object.keys(c).forEach(function(d){b=a.extend(b,c[d].getConfig())}),b},getConfigByAlert:function(a){return this.alerts[a].getConfig()},getCustomkeys:function(){var b=[],c=this.alerts;return Object.keys(c).forEach(function(d){b=a.union(b,c[d].getCustomKeys())}),b},_fetchModularAlertsViews:function(b){var d=this;return null!==this._fetched&&b!==!0?this._fetched:(this._fetched=new c.Deferred,c.when(this._getModularAlerts(),this._getModularAlertActions()).then(function(b,c){var e=function(b,c){var e=d.$el.find(".alert-container#alert-"+a.escape(b));c?(e.prependTo(d.$el.find(".alert-actions")),e.show()):(e.appendTo(d.$el.find(".alert-actions")),e.hide())};d.options.addBultinAlerts&&(d.alerts.email=new g({alert:{name:"email",acl:{app:"system"},content:{"eai:data":""}},action:c.find(function(a){return"email"===a.name}),onEnableChange:e}),d.alerts.script=new h({alert:{name:"script",acl:{app:"system"},content:{"eai:data":""}},action:c.find(function(a){return"script"===a.name}),onEnableChange:e}),d.alerts.notable=new i({alert:{name:"notable",acl:{app:"SA-ThreatIntelligence"},content:{"eai:data":""}},action:c.find(function(a){return"notable"===a.name}),content:d.options.content,onEnableChange:e,allAlertActions:d.alerts})),b.map(function(a){var b=c.find(function(b){return b.name===a.name});if(void 0!==b){var g=new f({alert:a,action:b,onEnableChange:e});d.alerts[g.name]=g}}),Object.keys(d.alerts).map(function(a){return d.alerts[a]}).filter(d.options.filterAlerts).forEach(function(a){delete d.alerts[a.name]}),d._fetched.resolve(!0)}),this._fetched)},_getModularAlerts:function(){var a=new c.Deferred,b=Splunk.util.make_url("/splunkd/__raw/servicesNS/nobody/SplunkEnterpriseSecuritySuite/data/ui/alerts?output_mode=json");return c.ajax({url:b,type:"GET",async:!0,success:function(b){a.resolve(b.entry)},error:function(b){a.reject(b)}}),a},_getModularAlertActions:function(){var a=new c.Deferred,b={search:'(is_custom=1 OR name="email" OR name="script") AND disabled!=1',output_mode:"json"},d=Splunk.util.make_url("/splunkd/__raw/servicesNS/nobody/SplunkEnterpriseSecuritySuite/alerts/alert_actions");return d+="?"+Splunk.util.propToQueryString(b),c.ajax({url:d,type:"GET",async:!0,success:function(b){a.resolve(b.entry)},error:function(b){a.reject(b)}}),a},_renderAddMenu:function(){var b=this,d=this.getDisabledAlerts().map(function(a){return b.alerts[a]});c(".alert-add-menu ul.alert-dropdown-list",this.$el).html(a.template(k,{alerts:d}));var e=a.intersection(a.flatten(d.map(function(a){return a.getCategories()})));e.unshift(a("All").t());var f=e.map(function(a){return{label:a,value:a}});this.children.categories.getAllControls()[0].setItems(f),0===d.length?c(".add-button",this.$el).hide():c(".add-button",this.$el).show(),this._filterAlerts()},render:function(){var b=this,d=new c.Deferred;return this.$el.html(a.template(j)),c.when(this._fetchModularAlertsViews()).then(function(){console.assert(!b._rendered),Object.keys(b.alerts).forEach(function(d){var e=b.alerts[d],f=c(a.template(l,{alert:e}));f.prependTo(b.$el.find(".alert-actions")),e.render(),b.$el.find(".alert-container#alert-"+a.escape(e.name)+" .alert-body").append(e.$el),c(".bootstrap-duallistbox-container").addClass("controls controls-block")}),b.children.categories=new e({el:c(".alert-action-inputs .categories-control",b.$el),label:a("Category").t(),controlType:"SyntheticSelect",controlOptions:{model:b.model1,modelAttribute:"category",items:[],popdownOptions:{attachDialogTo:b.options.attachDialogTo},additionalClassNames:"alert-action-categories"}}),b.children.search=new e({el:c(".alert-action-inputs .search-control",b.$el),controlType:"Text",controlOptions:{model:b.model1,modelAttribute:"search",placeholder:"search",canClear:!0,updateOnKeyUp:!0}}),b.children.show_recommended_only=new e({el:c(".alert-action-inputs .recommended-control",b.$el),label:a("").t(),controlType:"SyntheticCheckbox",controlOptions:{model:b.model1,modelAttribute:"recommendedonly",label:"Show only recommended actions"}}),b.children.categories.render(),b.children.search.render(),b.options.show_recom_act_chkbox===!0&&b.children.show_recommended_only.render(),b._renderAddMenu(),b._rendered=!0,d.resolve(b)}).fail(function(a){d.reject(a)}),d}});return m});