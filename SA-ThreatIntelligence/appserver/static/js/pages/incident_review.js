"use strict";require(["splunkjs/mvc","underscore","jquery","splunkjs/mvc/utils","splunkjs/mvc/searchmanager","splunkjs/mvc/timelineview","splunkjs/mvc/searchcontrolsview","splunkjs/mvc/postprocessmanager","sa-utils/js/util/FormUtils","splunkjs/mvc/simpleform/input/multiselect","splunkjs/mvc/simpleform/input/text","splunkjs/mvc/simpleform/input/timerange","splunkjs/mvc/simpleform/input/submit","sa-threatintelligence/js/components/incident_review/button_group/ButtonGroupView","sa-threatintelligence/js/components/incident_review/button_group/ButtonGroupInput","sa-threatintelligence/js/components/incident_review/eventsviewer/IREventsViewerView","sa-utils/js/util/autopause","css!sa-threatintelligence/css/incident_review","bootstrap.button","splunkjs/mvc/simplexml/ready!"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){function q(){i.submitForm({replaceState:t}),C.model.set({"dispatch.earliest_time":v.get("earliest"),"dispatch.latest_time":v.get("latest")})}function r(a,b){var c="";if(null!==a&&""!==a){tokenArr=a.split(" ");for(var d=0;d<tokenArr.length;d++)""===tokenArr[d]||"*"!==a&&"*"===tokenArr[d]||(c+=c.length<1?b+'="'+tokenArr[d]+'"':" OR "+b+'="'+tokenArr[d]+'"');c="("+c+")"}P.set(b,c)}function s(a){var b="";if(null!==a&&""!==a){urgencyArr=a.split(" ");for(var c=0;c<urgencyArr.length;c++)""!==urgencyArr[c]&&(b+=b.length<1?'NOT urgency="'+urgencyArr[c]+'"':' AND NOT urgency="'+urgencyArr[c]+'"');b="("+b+")"}P.set("new_urgency_token",b)}var t=!0,u=a.Components.get("url"),v=a.Components.get("default"),w=a.Components.get("submitted"),x=u.attributes["form.selected_urgency"],y=["unknown","informational","low","medium","high","critical"];x&&(console.log("selected_urgency:",x),y.splice(y.indexOf(x),1),u.attributes["form.new_urgency_count_form"]=y,v.set("form.new_urgency_count_form",y),u.attributes["form.selected_urgency"]=void 0),u.on("url:navigate",function(){v.set(u.toJSON()),b.isEmpty(u.toJSON())||b.all(u.toJSON(),b.isUndefined)?w.clear():q()});var z=new e({id:"id-main-search",earliest_time:"$earliest$",latest_time:"$latest$",search:'`notable` | search NOT `suppression` | search $new_urgency_token$ $status$ $owner$ $rule_name$ $security_domain$ $srch$ $tag$ | eventstats count(eval(urgency="critical")) as _***critical, count(eval(urgency="high")) as _***high, count(eval(urgency="medium")) as _***medium, count(eval(urgency="low")) as _***low, count(eval(urgency="informational")) as _***informational | fillnull value="unknown" governance | sort 0 -_time',cancelOnUnload:!0,status_buckets:300,autostart:!0,app:d.getCurrentApp(),auto_cancel:90,preview:!0},{tokens:!0,tokenNamespace:"submitted"}),A=new h({id:"id-post-process",managerid:"id-main-search",search:'head 1 | table _***critical, _***high, _***medium, _***low, _***informational | transpose | rename column as hidden_urgency, "row 1" as new_count | eval new_urgency_value=ltrim(hidden_urgency, "_***") | eval new_urgency_label=new_urgency_value.":".new_count'},{tokens:!0,tokenNamespace:"submitted"}),B=new f({id:"ir_timeline",managerid:"id-main-search",el:c("#timeline_div")}).render(),C=new p({id:"ir_events_viewer",managerid:"id-main-search",el:c("#event-viewer-body"),logReviewSettingsStanza:"incident_review"}).render();new g({id:"ir_search_controls",managerid:"id-main-search",el:c("#search_controls_div")}).render();B.on("change",function(){z.search.set(B.val())});var D=new j({label:b("Status").t(),id:"status_filter",choices:[{label:"All",value:"*"}],selectFirstChoice:!1,labelField:"status_label","default":"*",valueField:"status",value:"$form.status_form$",managerid:"search1",showClearButton:!0,el:c("#status_filter")},{tokens:!0}).render();D.on("change",function(a){i.handleValueChange(D)});var E=(new e({id:"search1",search:"|`reviewstatuses` | sort + status",earliest_time:"",status_buckets:0,cancelOnUnload:!0,latest_time:"+0s",app:d.getCurrentApp(),auto_cancel:90,preview:!0,runWhenTimeIsUndefined:!1},{tokens:!0}),new j({label:b("Owner").t(),id:"owner_filter",choices:[{label:"All",value:"*"}],selectFirstChoice:!1,labelField:"owner_realname","default":"*",valueField:"owner",value:"$form.owner_form$",managerid:"search2",showClearButton:!0,el:c("#owner_filter")},{tokens:!0}).render());E.on("change",function(a){i.handleValueChange(E)});var F=(new e({id:"search2",search:"| rest splunk_server=local count=0 /services/authentication/current-context | fields username,realname | rename username as owner | eval sort=100 | inputlookup append=T notable_owners_lookup | rename realname as owner_realname | eval owner_realname=if(isnull(owner_realname),owner,owner_realname) | eval sort_name=lower(owner_realname) | sort -sort,+sort_name | fields owner, owner_realname, sort | dedup owner",earliest_time:"",status_buckets:0,cancelOnUnload:!0,latest_time:"+0s",app:d.getCurrentApp(),auto_cancel:90,preview:!0,runWhenTimeIsUndefined:!1},{tokens:!0}),new j({label:b("Security Domain").t(),id:"domain_filter",choices:[{label:"All",value:"*"}],selectFirstChoice:!1,labelField:"security_domain_label","default":"*",valueField:"security_domain",value:"$form.security_domain_form$",managerid:"search3",showClearButton:!0,el:c("#domain_filter")},{tokens:!0}).render());F.on("change",function(a){i.handleValueChange(F)});var G=(new e({id:"search3",search:"| `security_domains` | search is_expected=true",earliest_time:"",status_buckets:0,cancelOnUnload:!0,latest_time:"+0s",app:d.getCurrentApp(),auto_cancel:90,preview:!0,runWhenTimeIsUndefined:!1},{tokens:!0}),new k({label:b("Name").t(),id:"rule_filter","default":"",suffix:'"',prefix:'rule_name="',value:"$form.rule_name$",el:c("#rule_filter")},{tokens:!0}).render());G.on("change",function(a){i.handleValueChange(G)});var H=new k({label:b("Search").t(),id:"srch_filter","default":"",value:"$form.srch$",el:c("#srch_filter")},{tokens:!0}).render();H.on("change",function(a){i.handleValueChange(H)});var I=new j({label:b("Tag").t(),id:"tags_filter",value:"$form.tag$",el:c("#tags_filter"),allowCustomValues:!0,delimiter:" AND ",valuePrefix:'tag="',valueSuffix:'"',prefix:"(",suffix:")",choices:[{label:"All",value:"*"}]},{tokens:!0}).render();I.on("change",function(a){i.handleValueChange(I)});var J=(new l({label:b("Time").t(),managerid:"id-main-search",id:"time_filter","default":{latest_time:"now",earliest_time:"-24h@h"},earliest_time:"$earliest$",latest_time:"$latest$",el:c("#time_filter")},{tokens:!0}).render(),[{value:"critical",label:"critical:0"},{value:"high",label:"high:0"},{value:"medium",label:"medium:0"},{value:"low",label:"low:0"},{value:"informational",label:"informational:0"}]),K=new o({label:b("Urgency").t(),id:"urgency_buttongroup",managerid:"id-post-process",labelField:"new_urgency_label",valueField:"new_urgency_value","default":"",value:"$form.new_urgency_count_form$",el:c("#button-group")},{tokens:!0}).render();K.on("change",function(a){i.handleValueChange(K)});var L=null,M=null,N=null,O=null;z.on("search:start",function(){console.log("main search started..."),L=a.Components.getInstance("id-main-search"),M=L.data("events")}),A.on("search:start",function(){console.log("post process started..."),N=a.Components.getInstance("id-post-process"),O=N.data("results")}),z.on("search:done",function(){console.log("main search done!")}),A.on("search:progress",function(){console.log("post process progress",O.data())}),A.on("search:done",function(){console.log("post process done!"),console.log("post process hasData()?",O.hasData()),console.log("post process results",O.data("results")),console.log("main search hasData()? ",M.hasData()),M.hasData()||O.hasData()?(a.Components.getInstance("urgency_buttongroup").settings.set("choices",void 0),console.log("removed null choices")):(a.Components.getInstance("urgency_buttongroup").settings.set("choices",J),console.log("added null choices"))});var P=a.Components.get("submitted");P.on("change:new_urgency_count_form",function(){P.has("new_urgency_count_form")&&s(P.get("new_urgency_count_form"))}),P.has("new_urgency_count_form")&&s(P.get("new_urgency_count_form")),P.on("change:status_form",function(){P.has("status_form")?r(P.get("status_form"),"status"):(D.val(["*"]),r("*","status"))}),P.on("change:owner_form",function(){P.has("owner_form")?r(P.get("owner_form"),"owner"):(E.val(["*"]),r("*","owner"))}),P.on("change:tag",function(){P.has("tag")||P.set("tag"," ")}),P.set("tag"," "),P.on("change:security_domain_form",function(){P.has("security_domain_form")?r(P.get("security_domain_form"),"security_domain"):(F.val(["*"]),r("*","security_domain"))}),P.has("status_form")&&r(P.get("status_form"),"status"),P.has("owner_form")&&r(P.get("owner_form"),"owner"),P.has("security_domain_form")&&r(P.get("security_domain_form"),"security_domain");var Q=new m({id:"submit",el:c("#ir_submit_btn")},{tokens:!0}).render();Q.on("submit",function(){q()}),(!v.has("earliest")&&!v.has("latest")||"0"===v.get("earliest")&&""===v.get("latest"))&&v.set({earliest:"-24h@h",latest:"now"}),q(),t=!1,c("body>div.preload").removeClass("preload"),c("title").text(b("Incident Review").t()),c(".dropdown-toggle-search-mode").addClass("disabled")});