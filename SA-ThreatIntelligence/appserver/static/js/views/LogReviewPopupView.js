"use strict";require.config({paths:{text:"../app/SA-Utils/js/lib/text"}}),define(["underscore","splunkjs/mvc","jquery","splunk.util","splunkjs/mvc/utils","sa-utils/js/util/Utils","splunkjs/mvc/simplesplunkview","splunkjs/mvc/simpleform/input/dropdown","splunkjs/mvc/dropdownview","splunkjs/mvc/searchmanager","app-ess/js/views/CreateNewInvestigationView","app-ess/js/util/InvestigativeCanvas","text!sa-threatintelligence/js/templates/LogReviewPopup.html","css!sa-threatintelligence/css/LogReviewPopup.css","sa-utils/js/util/Console"],function(a,b,c,d,e,f,g,h,i,j,k,l,m){var n=g.extend({className:"LogReviewPopupView",events:{"click #editAllSelected":"showLogReviewDialogSelected","click #editAll":"showLogReviewDialogAllMatching","click #addToInvestigation":"showInvestigationDialog","click #create_new_investigation":"createNewInvestigation","click #selectAll":"selectAll","click #unSelectAll":"unSelectAll","click .save":"save","click #inv_save":"saveToInvestigation","change #comment_textarea":"validate","keyup #comment_textarea":"validate","change #status-control-group":"validate","change #urgency-control-group":"validate","change #owner-control-group":"validate","click #back":"goBackForm"},defaults:{checkbox_el:null,managerid:null,show_select_unselect_all:!0,rule_uids_fx:null},initialize:function(){this.options=a.extend({},this.defaults,this.options),this.rule_uids_fx=this.options.rule_uids_fx,this.checkbox_el=this.options.checkbox_el,this.show_select_unselect_all=this.options.show_select_unselect_all,this.selected=this.options.selected,null!==this.options.managerid?this.search=b.Components.get(this.options.managerid):this.search=null,null!==this.search&&this.search.on("search:done",function(){this.updateResultInfo()}.bind(this)),this.result_count=null,this.notable_info=null,this.set_editing_only_selected=!1},showSaving:function(b){b?(c("#save",this.$el).text(a("Saving...").t()),c("#save",this.$el).attr("disabled","true"),c("#cancel",this.$el).attr("disabled","true")):(c("#save",this.$el).text(a("Save changes").t()),c("#save",this.$el).removeAttr("disabled"),c("#cancel",this.$el).removeAttr("disabled"))},updateResultInfo:function(){if(this.search){var b=this.search.get("data");if(b&&b.isDone&&(this.result_count=b.eventCount,this.result_count>0))return c("#editAll",this.$el).text(d.sprintf(a("Edit All %d Matching Events").t(),this.result_count)),void(null!==this.search.job&&(this.results=this.search.job.results()))}c("#editAll",this.$el).text(a("Edit All Matching Events").t())},selectAll:function(){null!==this.checkbox_el&&c("input:checkbox",this.checkbox_el).prop("checked",!0)},unSelectAll:function(){null!==this.checkbox_el&&c("input:checkbox",this.checkbox_el).prop("checked",!1)},getSelectedRuleUIDs:function(){var a=[];return null!==this.rule_uids_fx?a=this.rule_uids_fx():null!==this.checkbox_el&&c("input:checked",this.checkbox_el).each(function(){a.push(c(this).val())}),a},showLogReviewDialogSelected:function(){return this.getSelectedRuleUIDs().length<=0?this.showProblemDialog(a("Edit Events").t(),a("You must select at least one notable event").t()):(this.setEditingOnlySelected(!0),this.showLogReviewDialog()),!1},showProblemDialog:function(a,b){c("#problem_title",this.$el).text(a),c("#problem_message",this.$el).text(b),c("#logReviewPopupProblemModal",this.$el).modal()},setEditingOnlySelected:function(a){this.set_editing_only_selected=a},showLogReviewDialogAllMatching:function(){return this.setEditingOnlySelected(!1),this.showLogReviewDialog(),!1},showLogReviewDialog:function(){if(!this.isReady())return!1;this.hideErrorMessage(),this.showSaving(!1);var b=this.result_count;this.set_editing_only_selected?(b=this.getSelectedRuleUIDs().length,b>1?(c("#info_text",this.$el).text(d.sprintf(a("You are editing %d selected events").t(),b)),c("#info_message",this.$el).show()):c("#info_message",this.$el).hide()):b>1?(c("#info_text",this.$el).text(d.sprintf(a("You are editing all events matching the search (%d events)").t(),b)),c("#info_message",this.$el).show()):c("#info_message",this.$el).hide(),c("#logReviewPopupModal",this.$el).modal()},showInvestigationDialog:function(){if(!this.isReady())return!1;if(this.getSelectedRuleUIDs().length<=0)this.showProblemDialog(a("Edit Events").t(),a("You must select at least one notable event").t());else{var e=b.Components.get("investigations_input");e.settings.set("selectFirstChoice",!0),e.manager.startSearch(),this.showActionSuccessfulContent(!1);var f=this.getSelectedRuleUIDs().length;c("#investigation_info_text",this.$el).text(d.sprintf(a("You are adding %d incidents to the selected investigation below").t(),f)),c("#investigation_info_message",this.$el).show(),c("#investigationPopupModal",this.$el).modal("show")}return!1},goBackForm:function(){this.showActionSuccessfulContent(!1)},showActionSuccessfulContent:function(a){"undefined"==typeof a&&(a=!0),a?(c(".show_on_success").show(),c(".show_when_editing").hide()):(c(".show_on_success").hide(),c(".show_when_editing").show())},isReady:function(){var b=a("Edit Events").t();if(!this.search)return this.showProblemDialog(b,a("The search has not returned any results to modify").t()),!1;var c=this.search.get("data");return c?c.isRealTimeSearch&&!c.isDone?(this.showProblemDialog(b,a("The search is running in real-time and was not finalized; please finalize the search before attempting to edit the events").t()),!1):c&&c.isDone?!c||!c.isDone||0!==c.eventCount||(this.showProblemDialog(b,a("The search has not returned any results to modify").t()),!1):(this.showProblemDialog(b,a("The search is not yet done; please wait for the search to complete or finalize it to continue").t()),!1):(this.showProblemDialog(b,a("The search has not returned any results to modify yet").t()),!1)},performValidate:function(a,b,d,e){return e(b)?(c(".help-inline",a).hide(),c(a).removeClass("error"),0):(c(".help-inline",a).show().text(d),c(a).addClass("error"),1)},isNotEmpty:function(a){return void 0!==a&&0!==a.length},validate:function(){var e=0,f=this.notable_info.comment_length_required,g=c("textarea[name='comment']").val().trim().length;if(f>0){var h=f-g;h<0&&(h=0),c("#help-block").text(d.sprintf(a("A comment of length %(token_required)d characters is required (%(token_needed)d more characters needed)").t(),{token_required:f,token_needed:h}))}e+=this.performValidate(c("#comment-control-group"),g,d.sprintf(a("A comment of length %d must be provided").t(),f),function(a){return a>=f});var i=!1;return(this.isNotEmpty(b.Components.get("log_review_statuses").val())||this.isNotEmpty(b.Components.get("log_review_urgencies").val())||this.isNotEmpty(b.Components.get("log_review_owners").val()))&&(i=!0),i||0!==g||e++,0===e?c("#logReviewPopupModal #save",this.$el).removeClass("disabled"):c("#logReviewPopupModal #save",this.$el).addClass("disabled"),0===e},refreshResults:function(){this.search&&this.search.startSearch(),console.log("Restarting search")},clearFormValues:function(){b.Components.get("log_review_statuses").val(""),b.Components.get("log_review_urgencies").val(""),b.Components.get("log_review_owners").val(""),c("textarea[name='comment']",this.$el).val("")},saveStatusChanges:function(){var e=this.getSelectedRuleUIDs(),f={};if(f.output_mode="json",f.status=b.Components.get("log_review_statuses").val(),f.urgency=b.Components.get("log_review_urgencies").val(),f.newOwner=b.Components.get("log_review_owners").val(),f.comment=c("textarea[name='comment']",this.$el).val(),this.set_editing_only_selected&&(f.ruleUIDs=e),this.search){var g=this.search.get("data");f.searchID=g.sid}var h=d.make_url("/splunkd/__raw/services/notable_update");c.ajax({url:h,type:"POST",data:f,timeout:12e4,success:function(b){if(void 0!==b&&b.isOk===!1)this.showErrorMessage(d.sprintf(a("Incident review settings could not be saved: %s").t(),b.message));else{if(!b.success){var e=a("The changes to the notable events could not be saved").t();return b.hasOwnProperty("message")&&(e=b.message),void this.showErrorMessage(e)}b.failure_count>0&&0===b.success_count?this.showErrorMessage(d.sprintf(a("%d events could not be updated").t(),b.failure_count)):b.failure_count>0?this.showErrorMessage(d.sprintf(a("%(token_failure)d events could not be updated though %(token_success)d had been updated").t(),{token_failure:b.failure_count,token_success:b.success_count})):this.showSuccessMessage(d.sprintf(a("%d events successfully updated").t(),b.success_count)),this.clearFormValues(),c("#logReviewPopupModal",this.$el).modal("hide"),this.selected.reset(),this.refreshResults()}}.bind(this),error:function(b){403===b.status?this.showErrorMessage(a("Event status could not be updated due to insufficient permissions").t()):b.hasOwnProperty("responseJSON")&&b.responseJSON.hasOwnProperty("messages")&&b.responseJSON.messages.length>0?this.showErrorMessage(b.responseJSON.messages[0].text):this.showErrorMessage(a("Notable events could not be updated").t())}.bind(this),complete:function(){this.showSaving(!1)}.bind(this)})},showErrorMessage:function(a){c("#error_text",this.$el).text(a),c("#error_message",this.$el).show(),console.warn(a)},hideErrorMessage:function(){c("#error_message",this.$el).hide()},showSuccessMessage:function(a){console.info(a)},save:function(){this.hideErrorMessage(),this.validate()&&(this.showSaving(!0),this.saveStatusChanges())},saveToInvestigation:function(){var d=a("Error").t();if(this.results){for(var e=JSON.parse(this.results.responseText),f=this.getSelectedRuleUIDs(),g=e.fields,h=e.rows,i=g.indexOf("event_id"),j=b.Components.get("investigations_input").val(),k=[],m=0;m<h.length;m++)f.indexOf(h[m][i])>=0&&k.push(this.buildEntryRecord(j,g,h[m]));var n=a("There was an issue saving the selected notables to the Investigation").t();c.ajax({url:l.routes.create.canvas_entries,type:"POST",data:{records:JSON.stringify(k)},success:function(a){a?this.showActionSuccessfulContent(!0):(c("#investigationPopupModal").modal("hide"),this.showProblemDialog(d,n))}.bind(this),error:function(){c("#investigationPopupModal").modal("hide"),this.showProblemDialog(d,n)}.bind(this)})}else c("#investigationPopupModal").modal("hide"),this.showProblemDialog(d,a("There are no results available to save to an investigation").t())},buildEntryRecord:function(b,c,e){for(var f={canvas_id:b,data:{type:"splunk_event.notable",content:{}},description:"",title:d.sprintf(a("Notable Event (Host: %(token_host)s | Sourcetype: %(token_source_type)s)").t(),{token_host:e[c.indexOf("orig_host")]||"",token_source_type:e[c.indexOf("sourcetype")]}),start_time:new Date(e[c.indexOf("_time")]).getTime()/1e3,associations:[]},g=0;g<e.length;g++)e[g]&&(f.data[c[g]]=e[g]);return f.data=JSON.stringify(f.data),l.buildCanvasEntryRecord(f)},createNewInvestigation:function(){c("#investigationPopupModal",this.$el).modal("hide"),this.createNewInvestigationView.showModal()},_render:function(){var d=this,g=Splunk.util.getConfigValue("USERNAME");this.$el.html(a.template(m,{owners:this.notable_info.users,statuses:this.notable_info.statuses,urgencies:this.notable_info.urgencies,comment_length_required:this.notable_info.comment_length_required,show_select_unselect_all:this.show_select_unselect_all,urgency_override_allowed:this.notable_info.urgency_override_allowed}));var l=new h({id:"log_review_owners",selectFirstChoice:!1,"default":"",showClearButton:!0,el:c("#log_review_owners_input",this.$el)},{tokens:!0});l.render(),l.settings.set("choices",this.notable_info.users),this.notable_info.users.forEach(function(a){a.value===g&&c("#owner-set-current",d.$el).show().on("click",function(){l.val(g),d.validate()})});var n=new h({id:"log_review_urgencies",selectFirstChoice:!1,"default":"",showClearButton:!0,el:c("#log_review_urgencies_input",this.$el)},{tokens:!0});n.render(),n.settings.set("choices",this.notable_info.urgencies);var o=new h({id:"log_review_statuses",selectFirstChoice:!1,"default":"",showClearButton:!0,el:c("#log_review_statuses_input",this.$el)},{tokens:!0});o.render();for(var p=[],q=0;q<this.notable_info.statuses.length;q++)this.notable_info.statuses[q].disabled||p.push(this.notable_info.statuses[q]);o.settings.set("choices",p);var r=btoa(g),s=(new j({id:"investigation_search",search:"| inputlookup investigative_canvas_lookup | where isnotnull('collaborators."+g+".has_write') OR owner=\""+g+"\" OR isnotnull('collaborators."+r+".has_write') | rename _key as key | eval canvas = title | fields key, canvas | sort + canvas",app:e.getCurrentApp()},{tokens:!0,tokenNamespace:"submitted"}),new i({id:"investigations_input",selectFirstChoice:!0,showClearButton:!0,labelField:"canvas",valueField:"key",managerid:"investigation_search",el:c("#investigations",this.$el)},{tokens:!0}));return s.render(),this.createNewInvestigationView=new k({el:c("#new_investigation_modal"),saveCallback:function(c){if(c.success){var d=b.Components.get("investigations_input");d.settings.set("selectFirstChoice",!1),d.manager.startSearch(),d.val(c.investigation_id)}else this.showProblemDialog(a("Error").t(),c.message)}.bind(this),onHideCallback:function(){c("#investigationPopupModal").modal("show")}}),this.createNewInvestigationView.render(),this.updateResultInfo(),c.when(f.hasCapability("edit_timeline"),f.hasCapability("admin_all_objects")).then(function(a,b){(a||b)&&(c("#create_new_investigation").attr("disabled",!1),c("#inv_save").attr("disabled",!1))}),this},render:function(){var a=d.make_url("/custom/SA-ThreatIntelligence/notable_info/all");c.ajax({url:a,type:"GET",cache:!1,success:function(a,b,c){return void 0!==a&&a.isOk===!1?window.alert(a.message):void 0===a||""===a||a.preview||void 0===a||200!=c.status||(this.notable_info=a),this._render()}.bind(this)})}});return n});