"use strict";require.config({paths:{text:"../app/SA-Utils/js/lib/text","jquery.validationEngine-en":"../app/SA-ThreatIntelligence/scripts/jquery.validationEngine-en","jquery.validationEngine":"../app/SA-ThreatIntelligence/scripts/jquery.validationEngine","ui.dropdownchecklist":"../app/SA-ThreatIntelligence/scripts/ui.dropdownchecklist-1.5-min"},shim:{"jquery.validationEngine-en":{deps:["jquery"],exports:"jQuery.fn.validationEngine-en"},"jquery.validationEngine":{deps:["jquery","jquery.validationEngine-en"],exports:"jQuery.fn.validationEgine"},"ui.dropdownchecklist":{deps:["jquery","jquery.ui.core","jquery.ui.widget"]}}}),define(["underscore","backbone","jquery","util/splunkd_utils","sa-threatintelligence/js/models/NotableEventStatus","sa-threatintelligence/js/collections/NotableEventStatuses","text!sa-threatintelligence/js/templates/NotableEventStatusEditor.html","util/general_utils","jquery.validationEngine-en","jquery.validationEngine","ui.dropdownchecklist","css!sa-threatintelligence/stylesheets/validationEngine.jquery.css","css!sa-threatintelligence/stylesheets/ui.dropdownchecklist.standalone.css"],function(a,b,c,d,e,f,g){return b.View.extend({template:a.template(g),initialize:function(){},events:{change:"clear_error",input:"clear_error","click #checkbox-is_default":"toggle_place_holder","click #cancel_button":"cancel_button","click #save_button":"save_button"},toggle_place_holder:function(){this.$("#checkbox-is_default").is(":checked")?(this.$("#item-is_enabled_placeholder").show(),this.$("#item-is_enabled").hide(),this.$("#item-is_end_placeholder").show(),this.$("#item-is_end").hide()):(this.$("#item-is_enabled_placeholder").hide(),this.$("#item-is_enabled").show(),this.$("#item-is_end_placeholder").hide(),c("#item-is_end").show())},show_error:function(a){this.reset_button(),this.$("#editerror p").text(a),this.$("#editerror").show()},clear_error:function(){this.$("#editerror").hide("slow")},reset_button:function(){this.$("#save_button").text("Save")},save_button:function(){try{var b=this.$("#eaiform"),c=b.serializeArray(),d=a.find(c,function(a){return"label"===a.name}).value,e=this.tmplvars.notable_statuses;if(b.validationEngine("validate")===!1)return!1;var f=void 0===a.find(e,function(a){return a.label===d});if(a.isUndefined(this.model.get("nsid"))&&!f){var g="Notable event status label is not unique.             Please change the label to be unique.";return this.show_error(g),!1}this.$("#save_button").text("Saving..."),this.trigger("save",c)}catch(h){console.log(h),console.log(h.stack)}return!1},cancel_button:function(){return this.trigger("cancel"),!1},check_statuses:function(a){a.filter(":selected:not(:disabled)").length>0?a.filter(":disabled").attr("selected","true"):a.filter(":disabled").removeAttr("selected")},make_dropdown:function(a){var b=this.$(".status_"+a),c=this;this.$("#combobox_status_"+a).dropdownchecklist({icon:{},emptyText:'<span class="noneSelected">No roles selected</span>',width:450,onComplete:function(){c.check_statuses(b)}})},remake_dropdown:function(a){this.$("#combobox_status_"+a).dropdownchecklist("destroy"),this.make_dropdown(a)},select_all:function(a){var b=this.$(".status_"+a);b.length>0&&(b.attr("selected","true"),this.check_statuses(b)),this.remake_dropdown(a)},unselect_all:function(a){var b=this.$(".status_"+a);b.length>0&&(b.filter(":not(:disabled)").removeAttr("selected"),this.check_statuses(b)),this.remake_dropdown(a)},_modeldata:function(){var b=this.model,c=b.get("nsid"),d=b.get("roles"),f=b.get("notable_statuses"),g=(b.get("transitions"),b.get("user").capabilities),h=a.indexOf(g,"edit_reviewstatuses")>-1,i={},j=a.isUndefined(c)?/transition_reviewstatus-NA_to_(\d+)/:new RegExp("transition_reviewstatus-"+c+"_to_(\\d+)"),k=f.map(function(b){var c=a.extend({},b.entry.toJSON(),b.entry.content.toJSON());return c["default"]=Splunk.util.normalizeBoolean(c["default"]),c.disabled=Splunk.util.normalizeBoolean(c.disabled),c.end=Splunk.util.normalizeBoolean(c.end),i[c.name]={name:c.name,roles:{},imported_roles:{}},c}),l=a.find(k,function(a){return a.name===c})||{name:"NA","default":!1,disabled:!1,end:!1},m=f.find(function(a){return a.entry.get("name")===c});a.isUndefined(m)&&(m=new e.NEStatus,f.add(m,{silent:!0}),c=void 0);var n=d.map(function(b){var c,d=a.extend({},b.entry.toJSON(),b.entry.content.toJSON());return a.each(d.capabilities,function(a){var b=a.match(j);null!==b&&(c=b[1],i[c]&&(i[c].roles[d.name]=!0))}),a.each(d.imported_capabilities,function(a){var b=a.match(j);null!==b&&(c=b[1],i[c]&&(i[c].imported_roles[d.name]=!0))}),d});this.tmplvars={app:b.get("app"),insufficient_permissions:!h,shc_enabled:b.get("shc_enabled"),capabilities:g,notable_statuses:k,roles:n,transition_map:i,notable_status:l}},render:function(){var b=this;return this._modeldata(),this.$el.html(this.template({params:this.tmplvars})),this.$("#eaiform").validationEngine(),a.each(this.tmplvars.notable_statuses,function(a){var c=a.name,d=b.$("#status_"+c+"_select"),e=b.$("#status_"+c+"_unselect");d.length>0&&d.on("click",function(){return b.select_all(c),!1}),e.length>0&&e.on("click",function(){return b.unselect_all(c),!1}),b.make_dropdown(c)}),this}})});