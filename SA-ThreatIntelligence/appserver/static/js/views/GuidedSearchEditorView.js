"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a};require.config({paths:{text:"../app/SA-Utils/js/lib/text"}}),define(["underscore","backbone","splunkjs/mvc","splunkjs/mvc/utils","splunkjs/mvc/tokenutils","jquery","splunkjs/mvc/simplesplunkview","text!sa-threatintelligence/js/templates/GuidedSearchEditor.html","sa-threatintelligence/js/views/SearchAggregateView","sa-utils/js/util/FormUtils","splunkjs/mvc/simpleform/input/dropdown","splunkjs/mvc/simpleform/input/text","splunkjs/mvc/simpleform/input/multiselect","splunkjs/mvc/simpleform/input/checkboxgroup","css!sa-threatintelligence/css/GuidedSearchEditor.css","sa-utils/js/util/Console"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){var o=g.extend({className:"GuidedSearchEditorView",defaults:{search_spec:null},events:{"click .btn-prev":"gotoPrevPage","click .btn-next":"gotoNextPage","click .btn-finalize":"finalizeSearch","click .aggregate-new":"newAggregate"},initialize:function(){this.apps=null,this.options=a.extend({},this.defaults,this.options),options=this.options||{},this.search_spec=options.search_spec,this.page_state=0,this.page_states={string_search_to_be_replaced_page:{state_id:0,initial_state:!0,element_id:"#string_search_to_be_replaced_page"},data_model_selection_page:{state_id:1,element_id:"#data_model_selection_page"},time_selection_page:{state_id:2,element_id:"#time_selection_page"},event_filter_page:{state_id:3,element_id:"#event_filter_page"},aggregate_list_page:{state_id:4,element_id:"#aggregate_list_page",next_state_id:6},aggregate_edit_page:{state_id:5,element_id:"#aggregate_edit_page"},split_by_selection_page:{state_id:6,element_id:"#split_by_selection_page"},split_by_alias_page:{state_id:7,element_id:"#split_by_alias_page"},match_logic_selection_page:{state_id:8,element_id:"#match_logic_selection_page"},finalize_search_page:{state_id:9,element_id:"#finalize_search_page",final_state:!0}},this.search_string=null,this.search_parses=null,this.data_models=null,this.time_presets=null,this.available_fields=null,this.suppress_fields=null,this.search_aggregate_views={},this.listenTo(b,"search_aggregate:edit",this.editAggregate.bind(this)),this.listenTo(b,"search_aggregate:remove",this.removeAggregate.bind(this)),this.editing_aggregate=null,this.split_by_aliases={},this.split_by_span=""},getPropertyIfAvailable:function(a,b,c){return a.hasOwnProperty(b)?a[b]:c},applySearchTimes:function(a){if(null!==this.time_presets&&""!==a&&void 0!==a){for(var b=null,d=null,e=0;e<this.time_presets.length;e++)if(this.time_presets[e].name==a){b=this.time_presets[e].content.earliest_time,d=this.time_presets[e].content.latest_time,""!==d&&void 0!==d||(d="now");break}c.Components.get("start_time_input").val(b),c.Components.get("end_time_input").val(d)}},isSearchSpecVersionSupported:function(a){if(null!==a&&""!==a)return void 0===a.version||"1.0"==a.version},loadSearchSpec:function(a,b,d,e){if(null===a||""===a||!a.hasOwnProperty("searches"))return!1;if(!this.isSearchSpecVersionSupported(a))return this.search_spec=a,!0;a.searches[0].hasOwnProperty("inputlookup")?(a.searches[0].hasOwnProperty("earliest")&&(b=a.searches[0].earliest),a.searches[0].hasOwnProperty("latest")&&(d=a.searches[0].latest)):(b||(b=""),d||(d="")),c.Components.get("start_time_input").val(b),c.Components.get("end_time_input").val(d),this.suppress_fields=e,a.searches[0].hasOwnProperty("datamodel")&&(c.Components.getInstance("sources_dropdown").val("data_model"),c.Components.get("models_dropdown").val(a.searches[0].datamodel)),a.searches[0].hasOwnProperty("object")&&c.Components.get("objects_dropdown").val(a.searches[0].object),!a.searches[0].hasOwnProperty("summariesonly")||"0"!==a.searches[0].summariesonly&&0!==a.searches[0].summariesonly?c.Components.get("summaries_only_checkbox").val("summaries_only"):c.Components.get("summaries_only_checkbox").val(null),a.searches[0].hasOwnProperty("inputlookup")&&(c.Components.getInstance("sources_dropdown").val("input_lookup"),c.Components.get("lookups_dropdown").val(a.searches[0].inputlookup.lookupName),a.searches[0].inputlookup.hasOwnProperty("timeField")&&c.Components.getInstance("lookup_time_field_dropdown").val(a.searches[0].inputlookup.timeField));var f=[];this.split_by_aliases={};for(var g=0;g<this.getPropertyIfAvailable(a.searches[0],"splitby",[]).length;g++)f.push(a.searches[0].splitby[g].attribute),this.split_by_aliases[a.searches[0].splitby[g].attribute]=a.searches[0].splitby[g].alias,"_time"===a.searches[0].splitby[g].attribute&&(a.searches[0].splitby[g].hasOwnProperty("span")?this.split_by_span=a.searches[0].splitby[g].span:this.split_by_span="");return c.Components.get("split_by_dropdown").val(f),c.Components.get("span_time_bucket_input").val(this.split_by_span),null!==this.getPropertyIfAvailable(a.searches[0],"resultFilter",null)&&(c.Components.get("attributes_post_aggregate_dropdown").val(a.searches[0].resultFilter.field),c.Components.get("comparator_dropdown").val(a.searches[0].resultFilter.comparator),c.Components.get("operand_input").val(a.searches[0].resultFilter.value)),this.getPropertyIfAvailable(a.searches[0],"aggregates",[]).length>0&&this.renderAggregateListPage(a.searches[0].aggregates),c.Components.get("event_filter_input").val(this.getPropertyIfAvailable(a.searches[0],"eventFilter","")),this.updateEventFilterSearchDescription(),this.search_spec=a,!0},gotoPrevPage:function(){var a=this.getPageState();if(null!==a)if(a.hasOwnProperty("previous_state_id"))this.changePage(a.previous_state_id,!1);else{if(a.hasOwnProperty("initial_state")===!0||a.initial_state===!0)return;this.changePage(a.state_id-1,!1)}},hideWarning:function(){f("#warning-message",this.$el).hide()},showWarning:function(a){f("#warning-message-text",this.$el).text(a),f("#warning-message",this.$el).show()},extractDataModelObjectName:function(a){var b=/[^.]*[.]([^.]+)/i,c=b.exec(a);return null===c?a:b.exec(a)[1]},validateDataModelSelection:function(){this.hideWarning();var a=c.Components.getInstance("sources_dropdown").val(),b=c.Components.getInstance("lookups_dropdown").val(),d=c.Components.get("models_dropdown").val(),e=c.Components.get("objects_dropdown").val();if("data_model"==a){if(!d)return this.showWarning("Please select a data model"),!1;if(!e)return this.showWarning("Please select an object"),!1}else if(!b)return this.showWarning("Please select a lookup file"),!1;return!0},validateAggregateSelection:function(){this.hideWarning();var a=c.Components.get("functions_dropdown").val(),b=c.Components.get("attributes_dropdown").val();return a?!("count"!=a&&!b)||(this.showWarning("Please select an attribute"),!1):(this.showWarning("Please select a function"),!1)},validateTimeRangeSelection:function(){this.hideWarning();var a=c.Components.get("start_time_input").val(),b=c.Components.get("end_time_input").val();return"input_lookup"==c.Components.getInstance("sources_dropdown").val()&&!c.Components.getInstance("lookup_time_field_dropdown").val()||(a?!!b||(this.showWarning("Please define an end-time"),!1):(this.showWarning("Please define a start-time"),!1))},showOrHideAggregatesTable:function(){0===this.aggregatesCount()?f("#aggregates-list",this.$el).hide():f("#aggregates-list",this.$el).show()},validateFilterSelection:function(){this.hideWarning();var a=c.Components.get("attributes_post_aggregate_dropdown").val(),b=c.Components.get("comparator_dropdown").val(),d=c.Components.get("operand_input").val();if("*"!==a&&(a||b||d)){if(!b)return this.showWarning("Please select an operation"),!1;if(!a)return this.showWarning("Please select an attribute"),!1;if(!d)return this.showWarning("Please define a value to filter on"),!1}return!0},validateSpanSelection:function(){if(f("#bucket-time-input",this.$el).is(":hidden"))return!0;var a=c.Components.get("span_time_bucket_input").val(),b=/^([0-9]+)([a-z]+)$/i,d=b.exec(a);return null===d||0===d.length?(this.showWarning("Please define a valid span"),!1):(units=d[2],valid_units={s:"seconds",sec:"second",secs:"seconds",second:"second",seconds:"seconds",m:"minutes",min:"minutes",minute:"minute",minutes:"minutes",h:"hours",hr:"hour",hrs:"hours",hour:"hour",hours:"hours",d:"days",day:"day",days:"days",w:"weeks",week:"week",weeks:"weeks",mon:"months",month:"month",months:"months",q:"quarter",qtr:"quarter",qtrs:"quarter",quarter:"quarter",quarters:"quarters",y:"year",yr:"year",yrs:"years",year:"year",years:"years"},void 0!==valid_units[units]||(this.showWarning("The units provided for the time span are invalid"),!1))},aggregatesCount:function(){var a=0;for(var b in this.search_aggregate_views)this.search_aggregate_views.hasOwnProperty(b)&&a++;return a},changePage:function(a,b){if(this.hideWarning(),this.page_state===this.page_states.data_model_selection_page.state_id&&b){if(!this.validateDataModelSelection())return}else if(this.page_state===this.page_states.match_logic_selection_page.state_id&&b){if(!this.validateFilterSelection())return}else if(this.page_state!==this.page_states.match_logic_selection_page.state_id||b||0!==this.aggregatesCount())if(this.page_state!==this.page_states.match_logic_selection_page.state_id||b||0===this.aggregatesCount()||0!==c.Components.get("split_by_dropdown").val().length)if(this.page_state!==this.page_states.split_by_selection_page.state_id||b){if(this.page_state===this.page_states.event_filter_page.state_id&&b){if(this.updateEventFilterSearchDescription(),!this.search_parses)return}else if(this.page_state===this.page_states.aggregate_edit_page.state_id&&b){if(!this.validateAggregateSelection())return;this.updateOrCreateAggregate(),a=this.page_states.aggregate_list_page.state_id}else if(this.page_state===this.page_states.aggregate_list_page.state_id&&b&&0===this.aggregatesCount()&&a!=this.page_states.aggregate_edit_page.state_id)a=this.page_states.match_logic_selection_page.state_id;else if(this.page_state===this.page_states.split_by_selection_page.state_id&&b&&0===c.Components.get("split_by_dropdown").val().length&&a!=this.page_states.aggregate_edit_page.state_id)a=this.page_states.match_logic_selection_page.state_id;else if(this.page_state===this.page_states.time_selection_page.state_id&&b){if(!this.validateTimeRangeSelection())return}else if(this.page_state===this.page_states.split_by_alias_page.state_id&&b&&!this.validateSpanSelection())return}else a=this.page_states.aggregate_list_page.state_id;else a=this.page_states.split_by_selection_page.state_id;else a=this.page_states.aggregate_list_page.state_id;if(a===this.page_states.finalize_search_page.state_id&&this.renderSearchDescription("#search-description"),a===this.page_states.aggregate_list_page.state_id&&this.updateAvailableFieldsList("attributes_dropdown",!1,!1),a===this.page_states.split_by_selection_page.state_id){this.updateAvailableFieldsList("split_by_dropdown",!1,!1,!1);for(var d=c.Components.get("split_by_dropdown").val(),e=[],g=0;g<d.length;g++)f.inArray(d[g],this.available_fields)>=0&&e.push(d[g]);c.Components.getInstance("split_by_dropdown").val(e)}a===this.page_states.split_by_alias_page.state_id&&this.renderSplitByAliases(),this.page_state===this.page_states.split_by_alias_page.state_id&&this.persistSplitByAliases(),a===this.page_states.match_logic_selection_page.state_id&&this.updateAvailableFieldsList("attributes_post_aggregate_dropdown",!0,!0),a===this.page_states.event_filter_page.state_id&&this.updateEventFilterSearchDescription(),a===this.page_states.time_selection_page.state_id&&this.updateAvailableFieldsList("lookup_time_field_dropdown",!1,!1,!1),f(".step",this.$el).addClass("inactive"),f(".step-"+a,this.$el).removeClass("inactive");for(var h in this.page_states)f(this.page_states[h].element_id,this.$el).hide();var i=this.getPageState(),j=this.getPageState(a);return j.hasOwnProperty("final_state")&&j.final_state?(f(".btn-finalize",this.$el).show(),f(".btn-next",this.$el).hide()):(f(".btn-finalize",this.$el).hide(),f(".btn-next",this.$el).show()),j.hasOwnProperty("initial_state")&&j.initial_state?f(".btn-prev",this.$el).prop("disabled",!0):f(".btn-prev",this.$el).prop("disabled",!1),i.state_id===a?void f(j.element_id,this.$el).show():(this.slideInPanel(f(i.element_id,this.$el),f(j.element_id,this.$el),b),void(this.page_state=a))},setDataModelsList:function(a){this.data_models=a;for(var b=[],d=0;d<a.length;d++)b.push({label:a[d].name,value:a[d].name});c.Components.getInstance("models_dropdown").settings.set("choices",b),this.updateObjectsList()},getDataModelsList:function(b){"undefined"==typeof b&&(b=!0),f.ajax({url:Splunk.util.make_url("/custom/SA-ThreatIntelligence/customsearchbuilder/get_data_models"),type:"GET",async:b,success:function(a,b,c){this.setDataModelsList(a)}.bind(this),error:function(b,c,d){alert(a("Unable to get the list of data-models").t())}})},getTimePresets:function(){"undefined"==typeof async&&(async=!0),f.ajax({url:Splunk.util.make_url("/splunkd/__raw/services/data/ui/times?output_mode=json"),type:"GET",success:function(a,b,c){this.setTimePresetsList(a.entry)}.bind(this),error:function(b,c,d){alert(a("Unable to get the list of data-models").t())}})},setTimePresetsList:function(a){this.time_presets=a;var b=[],d=a.filter(function(a){return!!a.content.earliest_time}).sort(function(a,c){return a.content.sub_menu===c.content.sub_menu?a.content.order-c.content.order:(b.indexOf(a.content.sub_menu)===-1&&b.push(a.content.sub_menu),b.indexOf(c.content.sub_menu)===-1&&b.push(c.content.sub_menu),b=b.sort(),b.indexOf(c.content.sub_menu)-b.indexOf(a.content.sub_menu))}).map(function(a){return{label:a.content.label,value:a.name}});c.Components.getInstance("time_preset_dropdown").settings.set("choices",d),this.updateObjectsList()},syncTimePreset:function(a,b){if(null!==this.time_presets){for(var d=0;d<this.time_presets.length;d++)if(this.time_presets[d].content.earliest_time==a&&this.time_presets[d].content.latest_time==b)return void c.Components.get("time_preset_dropdown").val(this.time_presets[d].name);c.Components.get("time_preset_dropdown").val("")}},updateAvailableFieldsList:function(b,c,d,e,g){"undefined"==typeof g&&(g=this.getSearchSpec(c,d,!0,!0)),"undefined"==typeof e&&(e=!0);var h={search_spec:JSON.stringify(g)};f.ajax({url:Splunk.util.make_url("/custom/SA-ThreatIntelligence/customsearchbuilder/get_available_fields"),type:"GET",data:h,async:e,success:function(a,c,d){a.hasOwnProperty("success")&&a.success?this.setAvailableFields(a.available_fields,b):(alert(a.message),console.error(a.message))}.bind(this),error:function(b,c,d){alert(a("Unable to retrieve the available fields").t())}})},populateLookupsList:function(){var b={count:"-1",output_mode:"json"};f.ajax({url:Splunk.util.make_url("/splunkd/__raw/services/data/transforms/lookups"),type:"GET",data:b,async:!0,success:function(a,b,d){for(var e=[],f=0;f<a.entry.length;f++)e.push({label:a.entry[f].name,value:a.entry[f].name});c.Components.getInstance("lookups_dropdown").settings.set("choices",e)}.bind(this),error:function(b,c,d){alert(a("Unable to get the lookups list").t())}})},setAvailableFields:function(a,b){this.available_fields=a;var d=c.Components.getInstance(b);if(null===a)return void d.settings.set("choices",void 0);for(var e=[],f=0;f<a.length;f++)e.push({value:a[f],label:a[f]});d.settings.set("choices",e)},getSearchFromJSON:function(b,c){"undefined"==typeof c&&(c=!1);var d={search_spec:JSON.stringify(b),routine:"makeCorrelationSearch"},e=null;return f.ajax({url:Splunk.util.make_url("/custom/SA-ThreatIntelligence/customsearchbuilder/make_search_from_spec"),type:"GET",data:d,async:!1,success:function(a,b,c){a.hasOwnProperty("success")&&a.success?e={raw_search:a.raw_search,parses:a.parses}:alert(a.message)},error:function(b,c,d){alert(a("Unable to make a search from the specification").t())}}),c?e:null===e?null:e.raw_search},getPageState:function(a){"undefined"==typeof a&&(a=this.page_state);var b=null;for(var c in this.page_states)if(this.page_states[c].state_id===a){b=this.page_states[c];break}return b},gotoNextPage:function(){var a=this.getPageState();if(null!==a)if(a.hasOwnProperty("next_state_id"))this.changePage(a.next_state_id,!0);else{if(a.hasOwnProperty("final_state")&&a.final_state)return;this.changePage(a.state_id+1,!0)}},updateOrCreateAggregate:function(){var a=c.Components.get("functions_dropdown").val(),b=c.Components.get("attributes_dropdown").val(),d=c.Components.get("aggregate_alias").val();return!a||!b&&"count"!==a?void console.warn("Not enough information provided to make the aggregate"):(d||(d=null),void(null===this.editing_aggregate?this.makeAggregate(this.aggregatesCount(),a,b,d):(this.search_aggregate_views[this.editing_aggregate].fx=a,this.search_aggregate_views[this.editing_aggregate].attribute=b,this.search_aggregate_views[this.editing_aggregate].alias=d,this.search_aggregate_views[this.editing_aggregate].render())))},newAggregate:function(){this.editing_aggregate=null,c.Components.get("functions_dropdown").val(void 0),c.Components.get("attributes_dropdown").val(void 0),c.Components.get("aggregate_alias").val(""),this.changePage(this.page_states.aggregate_edit_page.state_id,!0)},modifySplitByAlias:function(b,c){alert(a("Editing split-by").t())},renderSplitByAliases:function(){f("#split-by-alias-list > tbody",this.$el).empty();for(var b='<tr><td><%- attribute %></td><td><input class="split-by-alias" name="alias" data-attr="<%- attribute %>" value="<%- alias %>"></input></td></tr>',d=c.Components.get("split_by_dropdown").val(),e=null,g=!1,h=0;h<d.length;h++)e=this.split_by_aliases[d[h]],e||(e=""),"_time"===d[h]&&(g=!0),f(a.template(b,{alias:e,attribute:d[h],identifier:d[h]})).appendTo(f("#split-by-alias-list > tbody",this.$el));g?f(".time-bucket",this.$el).show():f(".time-bucket",this.$el).hide()},persistSplitByAliases:function(){for(var a=null,b=0;b<f(".split-by-alias").length;b++)a=f(f(".split-by-alias")[b]),this.split_by_aliases[a.attr("data-attr")]=a.val();return this.split_by_aliases},editAggregate:function(a,b,d,e){this.editing_aggregate=a,c.Components.get("functions_dropdown").val(b),c.Components.get("attributes_dropdown").val(d),c.Components.get("aggregate_alias").val(e),this.changePage(this.page_states.aggregate_edit_page.state_id,!0)},removeAggregate:function(a){this.search_aggregate_views[a].remove(),delete this.search_aggregate_views[a],this.showOrHideAggregatesTable()},finalizeSearch:function(){this.search_spec=this.getSearchSpec(!0,!0,!0,!1),this.search_string=this.getSearchFromJSON(this.search_spec,!1),b.trigger("guided-mode-search-updated-event",this.search_string,this.search_spec,c.Components.get("start_time_input").val(),c.Components.get("end_time_input").val())},getSearchString:function(a,b,c,d){return"undefined"==typeof a&&(a=this.getSearchFromJSON(a,!1)),d?(a["alert.suppress.fields"]=d,a["alert.suppress"]=1):(delete a["alert.suppress.fields"],delete a["alert.suppress"]),!a.searches[0].latest&&c&&(a.searches[0].latest=c),!a.searches[0].earliest&&b&&(a.searches[0].earliest=b),this.getSearchFromJSON(a,!1)},getAliasNameForAggregate:function(a,b){return a+"("+this.getAliasNameForSplitBy(b)+")"},getAliasNameForSplitBy:function(a){var b=/([^.]+[.])*([^.]+)/i,c=b.exec(a);return c?c[2]:a},getSearchSpec:function(a,b,d,e){"undefined"==typeof a&&(a=!0),"undefined"==typeof b&&(b=!0),"undefined"==typeof d&&(d=!0),"undefined"==typeof e&&(e=!1);var f=c.Components.getInstance("sources_dropdown").val(),g=c.Components.getInstance("lookups_dropdown").val(),h=c.Components.get("objects_dropdown").val(),i=c.Components.get("models_dropdown").val(),j=c.Components.get("summaries_only_checkbox").val().length>=1?"1":"0",k=c.Components.get("start_time_input").val(),l=c.Components.get("end_time_input").val(),m=(c.Components.get("functions_dropdown").val(),c.Components.get("attributes_dropdown").val(),c.Components.get("aggregate_alias").val(),c.Components.get("attributes_post_aggregate_dropdown").val()),n=c.Components.get("split_by_dropdown").val(),o=c.Components.get("operand_input").val(),p=c.Components.get("comparator_dropdown").val(),q=c.Components.get("event_filter_input").val(),r=c.Components.get("span_time_bucket_input").val(),s=c.Components.getInstance("lookup_time_field_dropdown").val(),t={};if("data_model"==f?(t.datamodel=i,t.object=h,t.summariesonly=j):(t.inputlookup={lookupName:g},s&&(t.inputlookup.timeField=s)),("data_model"==f||s)&&(k&&k.length>0&&(t.earliest=k),l&&l.length>0&&(t.latest=l)),this.suppress_fields?(t["alert.suppress.fields"]=this.suppress_fields,t["alert.suppress"]=1):t["alert.suppress"]=0,a===!0&&this.aggregatesCount()>0){t.aggregates=[];var u={};for(var v in this.search_aggregate_views)u={"function":this.search_aggregate_views[v].fx,attribute:this.search_aggregate_views[v].attribute},this.search_aggregate_views[v].alias&&(u.alias=this.search_aggregate_views[v].alias),t.aggregates.push(u)}if(q&&(t.eventFilter=q),d&&m&&o&&p&&(t.resultFilter={field:m,comparator:p,value:o}),this.aggregatesCount()>0&&b&&n.length>0){for(var w=[],x="",y=0;y<n.length;y++){x=this.split_by_aliases[n[y]],""!==x&&void 0!==x||(x=this.getAliasNameForSplitBy(n[y]));var z={attribute:n[y],alias:x};"_time"===n[y]&&(z.span=r),w.push(z)}t.splitby=w}return e?t:{searches:[t],version:"1.0"}},renderSearchDescription:function(a,b){"undefined"==typeof b&&(b=this.getSearchSpec(!0,!0,!0,!1));var c=this.getSearchFromJSON(b,!0);c&&(this.search_string=c.raw_search,this.search_parses=c.parses,f(a,this.$el).html(this.getSearchDescription(b,this.search_string,this.search_parses)))},slideInPanel:function(a,b,c){var d=200,e={height:a.height()+"px"},f={height:b.height()+"px",left:"0px",position:"relative"};a.hide(),b.show(),c?b.css({left:a.width()+"px",position:"relative"}):b.css({left:-1*a.width()+"px",position:"relative"}),b.css(e).animate(f,d)},getSearchDescription:function(b,c,d){var e=this.clone(b);e.search_string=c,e.parses=d;var g=f("#search-description-template",this.$el).text();return a.template(g,e)},renderAggregateEditPage:function(){var a=(new k({id:"functions_dropdown",choices:[{value:"avg",label:"avg"},{value:"count",label:"count"},{value:"dc",label:"dc"},{value:"min",label:"min"},{value:"median",label:"median"},{value:"max",label:"max"},{value:"stdev",label:"stdev"},{value:"sum",label:"sum"},{value:"values",label:"values"},{value:"earliest",label:"earliest"},{value:"latest",label:"latest"},{value:"estdc",label:"estdc"},{value:"estdc_error",label:"estdc_error"},{value:"first",label:"first"},{value:"last",label:"last"},{value:"list",label:"list"},{value:"mean",label:"mean"},{value:"mode",label:"mode"},{value:"per_day",label:"per_day"},{value:"per_hour",label:"per_hour"},{value:"per_minute",label:"per_minute"},{value:"per_second",label:"per_second"},{value:"range",label:"range"},{value:"stdevp",label:"stdevp"},{value:"sumsq",label:"sumsq"},{value:"var",label:"var"},{value:"varp",label:"varp"}],selectFirstChoice:!1,showClearButton:!0,el:f("#functions-dropdown")},{tokens:!0}).render(),new k({id:"attributes_dropdown",choices:[],selectFirstChoice:!1,"default":"",valueField:"attribute_id",labelField:"attribute",showClearButton:!0,el:f("#attributes-dropdown")},{tokens:!0}).render(),new l({id:"aggregate_alias",searchWhenChanged:!1,el:f("#aggregate-alias-input")},{tokens:!0}).render());a.on("change",function(b){j.handleValueChange(a)})},renderMatchLogicSelectionPage:function(){var a=(new k({id:"attributes_post_aggregate_dropdown",choices:[],selectFirstChoice:!1,"default":"",valueField:"attribute_id",labelField:"attribute",value:"$form.attribute_post_aggregate$",showClearButton:!0,el:f("#attributes-post-aggregate-dropdown")},{tokens:!0}).render(),new k({id:"comparator_dropdown",choices:[{value:">",label:"Greater than"},{value:">=",label:"Greater than or equal to"},{value:"<",label:"Less than"},{value:"<=",label:"Less than or equal to"},{value:"=",label:"Equal to"},{value:"!=",label:"Not equal to"}],selectFirstChoice:!1,value:"$form.comparator$",showClearButton:!0,el:f("#comparator-dropdown")},{tokens:!0}).render(),new l({id:"operand_input",searchWhenChanged:!1,value:"$form.operand$",el:f("#operand-input")},{tokens:!0}).render());a.on("change",function(b){j.handleValueChange(a)})},clone:function(a){if(null===a||"object"!=("undefined"==typeof a?"undefined":_typeof(a)))return a;var b=a.constructor();for(var c in a)a.hasOwnProperty(c)&&(b[c]=this.clone(a[c]));return b},renderGroupBySelectionPage:function(){var a=new m({id:"split_by_dropdown",valueField:"attribute_id",labelField:"attribute",value:"$form.split_by$",el:f("#split-by-dropdown")},{tokens:!0}).render();a.on("change",function(b){j.handleValueChange(a)});var b=new l({id:"span_time_bucket_input",searchWhenChanged:!1,value:"$form.time_span$",el:f("#bucket-time-input")},{tokens:!0}).render();b.on("change",function(a){j.handleValueChange(b)}.bind(this))},updateEventFilterSearchDescription:function(){this.renderSearchDescription("#search-description-event-filter",this.getSearchSpec(!1,!1,!1,!1))},renderEventFilterPage:function(){var b=new l({id:"event_filter_input",searchWhenChanged:!1,value:"$form.eventfilter$",el:f("#event-filter-input")},{tokens:!0}).render();f("#event-filter-input input").keyup(a.debounce(function(){f("#event-filter-input input").change()}.bind(this),300)),b.on("change",function(a){j.handleValueChange(b),("data_model"==c.Components.getInstance("sources_dropdown").val()&&c.Components.get("models_dropdown").val()&&c.Components.get("objects_dropdown").val()||"input_lookup"==c.Components.getInstance("sources_dropdown").val()&&c.Components.get("lookups_dropdown").val())&&this.updateEventFilterSearchDescription()}.bind(this))},toggleTimeInputs:function(){"input_lookup"!=c.Components.getInstance("sources_dropdown").val()||c.Components.getInstance("lookup_time_field_dropdown").val()?(f("#start-time-input").show(),f("#end-time-input").show()):(f("#start-time-input").hide(),f("#end-time-input").hide())},renderTimeRangeSelectionPage:function(){var a=new k({id:"lookup_time_field_dropdown",searchWhenChanged:!1,selectFirstChoice:!1,value:"$form.timeField$",showClearButton:!0,el:f("#lookup-time-field-dropdown")},{tokens:!0}).render();a.on("change",function(b){j.handleValueChange(a),this.toggleTimeInputs()}.bind(this));var b=new l({id:"start_time_input",searchWhenChanged:!1,value:"$form.startTime$",el:f("#start-time-input")},{tokens:!0}).render();b.on("change",function(a){j.handleValueChange(b),this.syncTimePreset(a,c.Components.get("end_time_input").val())}.bind(this));var d=new l({id:"end_time_input",searchWhenChanged:!1,value:"$form.endTime$",el:f("#end-time-input")},{tokens:!0}).render();d.on("change",function(a){j.handleValueChange(d),this.syncTimePreset(c.Components.get("start_time_input").val(),a)}.bind(this));var e=new k({id:"time_preset_dropdown",searchWhenChanged:!1,selectFirstChoice:!1,value:"$form.timePreset$",showClearButton:!0,el:f("#time-preset-dropdown")},{tokens:!0}).render();e.on("change",function(a){j.handleValueChange(e),this.applySearchTimes(a)}.bind(this)),this.getTimePresets()},updateObjectsList:function(){if(null!==this.data_models){var a=c.Components.get("models_dropdown").val(),b=null;if(!a)return void c.Components.getInstance("objects_dropdown").settings.set("choices",[]);for(var d=0;d<this.data_models.length;d++)if(this.data_models[d].name==a){b=this.data_models[d];break}var e=[];for(d=0;d<b.objects.length;d++)e.push({label:b.objects[d],value:b.objects[d]});c.Components.getInstance("objects_dropdown").settings.set("choices",e)}},makeAggregate:function(b,c,d,e){var g=f("#aggregates-list > tbody",this.$el);g.append(a.template('<tr id="aggregate-<%- identifier %>"></tr>',{identifier:b}));var h=f("#aggregate-"+String(b),this.$el),j=new i({el:h,identifier:b,fx:c,attribute:d,alias:e});this.search_aggregate_views[b]=j,j.render(),this.showOrHideAggregatesTable()},renderAggregateListPage:function(a){f("#aggregates-list > tbody",this.$el).html(""),this.search_aggregate_views={};for(var b=0;b<a.length;b++)this.makeAggregate(b,a[b]["function"],a[b].attribute,this.getPropertyIfAvailable(a[b],"alias",null));this.showOrHideAggregatesTable()},renderDataModelSelectionPage:function(){var a=new k({id:"sources_dropdown",choices:["Data model","Lookup file"],selectFirstChoice:!1,value:"$form.source",showClearButton:!1,el:f("#data-source-dropdown")},{tokens:!0}).render();a.on("change",function(b){j.handleValueChange(a),this.toggleTimeInputs();var c="data_model"==a.val();f("#lookup-name-dropdown",this.$el).toggle(!c),f("#lookup-time-field-dropdown",this.$el).toggle(!c),f("#models-dropdown",this.$el).toggle(c),f("#objects-dropdown",this.$el).toggle(c),f("#summaries-only-checkbox",this.$el).toggle(c),f("#summaries-only-checkbox-help",this.$el).toggle(c)}.bind(this)),a.settings.set("choices",[{value:"data_model",label:"Data model"},{value:"input_lookup",label:"Lookup file"}]),a.val("data_model");var b=(new n({id:"summaries_only_checkbox",choices:[{label:"Summaries-only",value:"summaries_only"}],el:f("#summaries-only-checkbox")},{tokens:!0}).render(),new k({id:"lookups_dropdown",choices:[],selectFirstChoice:!1,value:"$form.lookup_name$",showClearButton:!1,el:f("#lookup-name-dropdown")},{tokens:!0}).render());b.on("change",function(a){j.handleValueChange(b)});var c=new k({id:"models_dropdown",choices:[],selectFirstChoice:!1,valueField:"model_id",labelField:"model",value:"$form.dm$",showClearButton:!1,el:f("#models-dropdown")},{tokens:!0}).render();c.on("change",function(a){j.handleValueChange(c),this.updateObjectsList()}.bind(this));var d=new k({id:"objects_dropdown",choices:[],selectFirstChoice:!1,valueField:"object",labelField:"object",value:"$form.object$",managerid:"objects_search",showClearButton:!1,el:f("#objects-dropdown")},{tokens:!0}).render();d.on("change",function(a){j.handleValueChange(d)}),this.populateLookupsList()},render:function(){this.$el.html(h),this.renderDataModelSelectionPage(),this.renderEventFilterPage(),this.renderGroupBySelectionPage(),this.renderMatchLogicSelectionPage(),this.renderAggregateEditPage(),this.renderTimeRangeSelectionPage(),this.getDataModelsList(),this.showOrHideAggregatesTable()},show:function(){if(null!==this.search_spec&&!this.isSearchSpecVersionSupported(this.search_spec))return void f("#searchSpecNotSupportedModal",this.$el).modal();var a=this.page_states.string_search_to_be_replaced_page.state_id;this.changePage(a,!1),f("#guidedSearchModal",this.$el).modal()}});return o});