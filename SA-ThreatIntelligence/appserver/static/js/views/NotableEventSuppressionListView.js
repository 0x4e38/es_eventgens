"use strict";require.config({paths:{datatables:"../app/SA-Utils/js/lib/DataTables/js/jquery.dataTables",text:"../app/SA-Utils/js/lib/text"}}),define(["underscore","backbone","jquery","datatables","sa-threatintelligence/js/collections/NotableEventSuppressions","sa-threatintelligence/js/models/NotableEventSuppression","sa-threatintelligence/js/views/NotableEventSuppressionEditorModalView","sa-utils/js/util/Utils","text!sa-threatintelligence/js/templates/NotableEventSuppressionList.html","css!sa-utils/js/lib/DataTables/css/jquery.dataTables.css","css!sa-utils/js/lib/DataTables/css/dataTables.bootstrap.css","css!sa-utils/css/SplunkDataTables.css"],function(a,b,c,d,e,f,g,h,i){var j=b.View.extend({className:"NotableEventSuppressionListView",events:{"click .supp_link":"editSuppression","click .supp_toggle":"toggleSuppression"},initialize:function(){this.has_edit_capability=!1,this.suppressions=new e,this.edit_modal=new g,this.edit_modal.on("saved",this.updateTable,this)},newSuppression:function(){this.edit_modal.openModal()},editSuppression:function(a){var b=c(a.currentTarget,this.$el).data("id"),d=this.suppressions.at(b),e=d.entry.get("name");this.edit_modal.openModal(e)},toggleSuppression:function(b){var d=c(b.currentTarget,this.$el),e=d.parent(),f=d.data("id"),g=this.suppressions.at(f),h="1"===g.entry.content.get("disabled")?"0":"1";"1"===h?e.html(a("Disabling...").t()):e.html(a("Enabling...").t()),g.entry.content.set("disabled",h),g.save({},{success:function(){"1"===h?e.html('<a href="#" class="supp_toggle" data-id="'+f+'"> '+a("Enable").t()+"</a> | "+a("Disabled").t()):e.html(a("Enabled").t()+' | <a href="#" class="supp_toggle" data-id="'+f+'"> '+a("Disable").t()+" </a>")}.bind(this),error:function(){this.error_message.text(a("Failed to change suppression status").t()),this.error_modal.modal("show"),"0"===h?e.html('<a href="#" class="supp_toggle" data-id="'+f+'"> '+a("Enable").t()+"</a> | "+a("Disabled").t()):e.html(a("Enabled").t()+' | <a href="#" class="supp_toggle" data-id="'+f+'"> '+a("Disable").t()+" </a>")}.bind(this)})},generateName:function(b,c){var d=b.entry.get("name").replace(/^notable_suppression-/,"");return this.has_edit_capability?'<a href="#" class="supp_link" data-id="'+c+'">'+a.escape(d)+"</a>":d},generateStatus:function(b,c){return"1"===b.entry.content.get("disabled")?this.has_edit_capability?'<a href="#" class="supp_toggle" data-id="'+c+'"> '+a("Enable").t()+"</a> | "+a("Disabled").t():a("Disabled").t():this.has_edit_capability?a("Enabled").t()+' | <a href="#" class="supp_toggle" data-id="'+c+'"> '+a("Disable").t()+" </a>":a("Enabled").t()},generateRow:function(b,c){var d=b.entry.content.toJSON(),e=d.search,f=this.generateName(b,c),g=/\s+_time\s*>=?\s*(\d+)/,h=/\s+_time\s*<=?\s*(\d+)/;return ms=e.match(g),me=e.match(h),start=null!==ms?new Date(1e3*parseInt(ms[1],10)).toString():"",end=null!==me?new Date(1e3*parseInt(me[1],10)).toString():"",status=this.generateStatus(b,c),[f,a.escape(d.description),start,end,status]},renderTable:function(){var b=[];this.suppressions.each(function(a,c){b.push(this.generateRow(a,c))}.bind(this)),c("#suppression_table",this.$el).html('<table cellpadding="0" cellspacing="0" border="0" class="table table-striped display" id="ntable"></table>'),c("#ntable",this.$el).dataTable({aaData:b,iDisplayLength:25,aoColumns:[{sTitle:a("Label").t()},{sTitle:a("Description").t()},{sTitle:a("Start Time").t()},{sTitle:a("Expiration Time").t()},{sTitle:a("Status").t()}]})},updateTable:function(){c("#suppression_table").html(a("Fetching Suppressions...").t()),c("#new_suppression").hide(),this.suppressions.fetch({success:function(){c("#new_suppression").show(),this.renderTable()}.bind(this),error:function(){this.error_message.text(a("Failed to fetch suppressions").t()),this.error_modal.modal("show")}.bind(this)})},render:function(){var b=this;return this.$el.html(a.template(i)),this.error_message=c("#supp_list_error_message",this.$el),this.error_modal=c("#supp_list_error_modal",this.$el),c.when(h.hasCapability("edit_suppressions")).then(function(d){b.has_edit_capability=d,b.suppressions.fetch({success:function(){if(this.has_edit_capability){var b='<a href="#" class="btn btn-primary pull-right" data-dismiss="modal" role="button" id="new_suppression"><%- _("Create New Suppression").t() %></a>';c(".dashboard-header h2").append(a.template(b)),c("#new_suppression").click(function(){this.newSuppression()}.bind(this)),this.$el.append(this.edit_modal.render().$el)}this.renderTable()}.bind(b),error:function(){this.error_message.text(a("Failed to fetch suppressions").t()),this.error_modal.modal("show")}.bind(b)})}),this}});return j});