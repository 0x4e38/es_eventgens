"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a};require.config({paths:{text:"../app/SA-Utils/js/lib/text"},shim:{"sa-threatintelligence/contrib/tagmanager/tagmanager":{deps:["jquery"]}}}),define(["underscore","backbone","splunkjs/mvc","splunkjs/mvc/utils","sa-utils/js/util/Utils","jquery","splunkjs/mvc/simplesplunkview","text!sa-threatintelligence/js/templates/CorrelationSearchEditor.html","sa-threatintelligence/js/views/GuidedSearchEditorView","sa-threatintelligence/js/components/response/ModularAlertManager","sa-threatintelligence/contrib/tagmanager/tagmanager","css!sa-threatintelligence/contrib/tagmanager/tagmanager.css","css!sa-threatintelligence/css/CorrelationSearchEditor.css","sa-utils/js/util/Console"],function(a,b,c,d,e,f,g,h,i,j){var k=g.extend({className:"CorrelationSearchEditorView",defaults:{list_link:null,list_link_title:"Back to list",default_app:"SplunkEnterpriseSecuritySuite",search_name:null,redirect_to_list_on_save:!0},initialize:function(){this.apps=null,this.search_names=null,this.options=a.extend({},this.defaults,this.options),options=this.options||{},this.list_link=options.list_link,this.list_link_title=options.list_link_title,this.redirect_to_list_on_save=options.redirect_to_list_on_save,this.search_name=null,this.fetched_search=null,this.correlation_search_meta_info=null,this.notable_info=null,this.guided_mode_dialog=null,this.search_string=null,this.search_spec=null,this.using_search_spec=!1,this.listenTo(b,"guided-mode-search-updated-event",function(a,b,c,d){this.updateSearchInformation(a,b,c,d,!0)}.bind(this));var c=60,d=60*c,e=24*d,f=7*e,g=30*e,h=365*e;this.durations=[["y",h],["d",e],["h",d],["y",h],["mon",g],["w",f],["s",1]]},events:{"click #save":"save","click #cancel":"redirectToList",'change input[name="start_time"]':"toggleCronSchedule",'change input[name="end_time"]':"toggleCronSchedule","change input":"validate","change select":"validate","change textarea":"validate","click #show-guided-search-editor":"openGuidedSearchEditor","click #change-to-manual-mode":"changeToManualMode"},updateSearchInformation:function(a,b,c,d,e){this.search_string=a,this.search_spec=b,this.using_search_spec=e,f('textarea[name="search"]',this.$el).val(a),void 0!==c&&f('input[name="start_time"]',this.$el).val(c),void 0!==d&&f('input[name="end_time"]',this.$el).val(d),this.validate(),e?f("#change-to-manual-mode",this.$el).show():f("#change-to-manual-mode",this.$el).hide(),f('textarea[name="search"]',this.$el).val(a).prop("disabled",e)},changeToManualMode:function(){return!this.disable_links&&(this.updateSearchInformation(this.search_string,this.search_spec,void 0,void 0,!1),!0)},getGroupBys:function(){var a=f("input[name=hidden-group_by]",this.$el).val();return a?a=a.split(","):""===a&&(a=null),null===a&&f("input[name=duration]",this.$el).val().length>0&&(a=["const_dedup_id"]),a},openGuidedSearchEditor:function(){if(this.disable_links)return!1;if(null===this.guided_mode_dialog&&(this.guided_mode_dialog=new i({el:f("#guided-mode-dialog-placeholder",this.$el)}),this.guided_mode_dialog.render()),null!==this.search_spec&&""!==this.search_spec){var a=this.getGroupBys();this.guided_mode_dialog.loadSearchSpec(this.search_spec,f('input[name="start_time"]',this.$el).val(),f('input[name="end_time"]',this.$el).val(),a)}return this.guided_mode_dialog.show(),!1},isRealtime:function(){return this.isTimeRT(f('input[name="start_time"]',this.$el).val())||this.isTimeRT(f("input[name='end_time']",this.$el).val())},toggleCronSchedule:function(){var a=f('input[name="cron_schedule"]',this.$el);this.isRealtime()?(a.val("*/5 * * * *"),a.prop("disabled",!0)):a.prop("disabled",!1),f.when(e.hasCapability("edit_correlationsearches")).then(function(b){b||a.prop("disabled",!0)})},toggleSelectors:function(a,b){var c=this;b.map(function(b){a?f(b,c.$el).show():f(b,c.$el).hide()})},semanticallyCorrectDuration:function(a){var b=/^([0-9]+)\s*([hsmdyonw]+)$/,c=/^([0-9]+)\s*$/,d=b.exec(a);return d?a:(number_match=c.exec(a),number_match?a+"s":"")},convertSecondsToDuration:function(a){var b=null;if(null===a||0===a.length)return"";if("$info_min_time$"===a||"$info_max_time$"===a)return a;for(var c=0;c<this.durations.length;c++)if(b=this.durations[c][1],a%b===0)return(a/b).toString()+this.durations[c][0];return a.toString()+"s"},refreshSearchString:function(){null===this.guided_mode_dialog&&(this.guided_mode_dialog=new i({el:f("#guided-mode-dialog-placeholder",this.$el)}));var a=this.guided_mode_dialog.getSearchString(this.search_spec,f('input[name="start_time"]',this.$el).val(),f('input[name="end_time"]',this.$el).val(),this.getGroupBys());f("textarea[name=search]",this.$el).val(a)},convertTimeToReadable:function(a){var b=/([0-9]+)\s?([a-z]?)/i,c=0,d="",e=b.exec(a);if(null===e||0===e.length)return null;if(c=parseInt(e[1],10),d=e[2],valid_units={s:"seconds",sec:"second",secs:"seconds",second:"second",seconds:"seconds",m:"minutes",min:"minutes",minute:"minute",minutes:"minutes",h:"hours",hr:"hour",hrs:"hours",hour:"hour",hours:"hours",d:"days",day:"day",days:"days",w:"weeks",week:"week",weeks:"weeks",mon:"months",month:"month",months:"months",q:"quarter",qtr:"quarter",qtrs:"quarter",quarter:"quarter",quarters:"quarters",y:"year",yr:"year",yrs:"years",year:"year",years:"years"},valid_units[d])return[c.toString()+d,c.toString()+" "+valid_units[d]];throw"Units invalid"},save:function(){var b=this;f.when(e.hasCapability("edit_correlationsearches")).then(function(c){if(c&&(f("#failure_message",b.$el).hide(),b.validate())){var d=null===b.search_name,e={};e.output_mode="json",e.cron_schedule=f("input[name=cron-schedule]",b.$el).val(),e.search=f("textarea[name=search]",b.$el).val(),b.using_search_spec?e.search_spec=JSON.stringify(b.search_spec):e.search_spec="",e.name=f("input[name=name]",b.$el).val(),e.start_time=f("input[name=start_time]",b.$el).val(),e.end_time=f("input[name=end_time]",b.$el).val(),e.description=f("input[name=description]",b.$el).val(),e.cron_schedule=f("input[name=cron_schedule]",b.$el).val(),e.realtime_schedule="1"===f("select[name=realtime_schedule_isenabled]",b.$el).val(),e.duration=f("input[name=duration]",b.$el).val(),e.group_by=f("input[name=hidden-group_by]",b.$el).val(),d?e.namespace=f("select[name=namespace]",b.$el).val():(e.sid=b.fetched_search.name,e.domain=b.fetched_search.content.security_domain),e=a.extend(e,b.alertManager.getConfig());var g=Splunk.util.make_url("/custom/SA-ThreatIntelligence/correlation_searches/update_or_create_search");b.showSaving(!0),b.redirect_to_list_on_save&&b.list_link&&(b.disable_links=!0),d&&(search_name=e.name),f.ajax({url:g,type:"POST",data:e,async:!0,success:function(a){void 0===a||a.isOk!==!1&&a.success!==!1?(d&&(b.search_name=a.sid,f('input[name="name"]',b.$el).prop("disabled",!0)),f("#success_message",b.$el).show(),b.redirect_to_list_on_save&&b.list_link?setTimeout(function(){b.redirectToList()},3e3):b.disable_links=!1):(f("#error_text",b.$el).text("Search could not be updated: "+a.message),f("#failure_message",b.$el).show())},error:function(a){a.responseJSON.messages.length>0?f("#error_text",b.$el).text(a.responseJSON.messages[0].text):f("#error_text",b.$el).text("Search could not be updated"),f("#failure_message",b.$el).show(),b.disable_links=!1},complete:function(a,c){b.showSaving(!1)}})}})},redirectToList:function(){this.list_link&&(document.location=this.list_link)},valueOrDefault:function(a,b){return void 0===("undefined"==typeof a?"undefined":_typeof(a))||void 0===a||null===a||""===a?b:a},showSaving:function(a){a?(f("#save",this.$el).text("Saving..."),f("#save",this.$el).attr("disabled","true")):(f("#save",this.$el).text("Save"),f("#save",this.$el).removeAttr("disabled"))},fetchSearch:function(a){var b=this,c=f.Deferred(),d=null,e={output_mode:"json",search:a},g=Splunk.util.make_full_url("/custom/SA-ThreatIntelligence/correlation_searches/get_search",e);return f.ajax({url:g,type:"GET",async:!0,success:function(a){void 0!==a&&a.isOk===!1?c.reject(Error("Search could not be obtained: "+a.message)):(d=a.entry[0],b.fetched_search=d,c.resolve(d))}}),c},validateField:function(a,b,c,d,e){return d(b)?(f(".help-inline",a).hide(),f(a).removeClass(e),0):(f(".help-inline",a).show().text(c),f(a).addClass(e),1)},validateFieldError:function(a,b,c,d){return this.validateField(a,b,c,d,"error")},validateFieldInfo:function(a,b,c,d){return this.validateField(a,b,c,d,"info")},validate:function(){var a=this,b=null===this.search_name,c=0;if(b){var d=0;d+=this.validateFieldError(f("#search-name-control-group",this.$el),f("input[name=name]",this.$el).val(),"Cannot be empty",function(a){return 0!==a.length}),0===d&&(d+=this.validateFieldError(f("#search-name-control-group",this.$el),f("input[name=name]",this.$el).val(),"Search with that name already exists",function(b){return a.search_names.indexOf(b)===-1})),c+=d}return b&&(c+=this.validateFieldError(f("#namespace-control-group",this.$el),f("select[name=namespace]",this.$el).val(),"Cannot be empty",function(a){return 0!==a.length})),c+=this.validateFieldError(f("#search-control-group",this.$el),f("textarea[name=search]",this.$el).val(),"Cannot be empty",function(a){return 0!==a.length}),c+=this.validateFieldError(f("#cron-schedule-control-group",this.$el),f("input[name=cron_schedule]",this.$el).val(),"Cannot be empty",function(a){return 0!==a.length}),c+=this.validateFieldError(f("#duration-control-group",this.$el),f("input[name=duration]",this.$el).val(),"Cannot be empty if group-by fields are provided",function(b){return void 0!==f("input[name=hidden-group_by]",a.$el).val()&&(!(f("input[name=hidden-group_by]",a.$el).val().length>0)||0!==b.length)}),0===c},getNamedArrayFromSearch:function(a){var b={search_name:a.name,namespace:a.acl.app,owner:a.acl.owner,domain:a.content.security_domain,start_time:a.content["dispatch.earliest_time"],end_time:a.content["dispatch.latest_time"],search:a.content.savedsearch,search_spec:a.content.search,description:a.content.description,cron_schedule:a.content.cron_schedule,realtime_schedule_isenabled:a.content.realtime_schedule,severity:a.content.severity,next_steps:a.content.next_steps||'{"version":1, "data":""}',recommended_actions:a.content.recommended_actions||"",default_status:a.content.default_status,default_owner:a.content.default_owner,drilldown_search:a.content.drilldown_search,drilldown_name:a.content.drilldown_name,drilldown_earliest_offset:this.convertSecondsToDuration(a.content.drilldown_earliest_offset),drilldown_latest_offset:this.convertSecondsToDuration(a.content.drilldown_latest_offset),duration:a.content["alert.suppress.period"],group_by:a.content["alert.suppress.fields"],rule_title:a.content.rule_title,rule_description:a.content.rule_description,name:a.content.rule_name,alerts:{}};return Object.keys(a.content).filter(function(a){return 0===a.indexOf("action.")}).map(function(c){b.alerts[c]=a.content[c]}),b.duration&&"const_dedup_id"==b.group_by&&(b.group_by=""),b},isTimeRT:function(a){return a.indexOf("rt")>=0},getCorrelationSearchInfo:function(){var a=this,b=f.Deferred();if(this.correlation_search_meta_info)return b.resolve(this.correlation_search_meta_info),b;var c=Splunk.util.make_url("/custom/SA-ThreatIntelligence/correlation_searches/all_info");return f.ajax({url:c,type:"GET",cache:!1,async:!0,success:function(c,d,e){void 0!==c&&c.isOk===!1?(alert(c.message),b.reject(Error("Correlation Search Info could not be obtained: "+c.message))):void 0===c||""===c||c.preview||void 0===c||200!=e.status||(a.correlation_search_meta_info=c,b.resolve(c))},error:function(a,c,d){b.reject(Error("Correlation Search Info could not be obtained: "+c))}}),b},getNotableInfo:function(){var a=this,b=f.Deferred();if(this.notable_info)return b.resolve(this.notable_info),b;var c=Splunk.util.make_url("/custom/SA-ThreatIntelligence/notable_info/all");return f.ajax({url:c,type:"GET",cache:!1,async:!0,success:function(c,d,e){void 0!==c&&c.isOk===!1?alert(c.message):void 0===c||""===c||c.preview||void 0===c||200!=e.status||(a.notable_info=c),b.resolve(a.notable_info)}}),b},getContent:function(){var a=this,b=f.Deferred(),c=null;null!==this.search_name?c=this.search_name:(c=e.getURLParameter("search"),c||(c=e.getURLParameter("name")),this.search_name=c);var d=null;return null!==c?this.fetchSearch(c).done(function(c){d=a.getNamedArrayFromSearch(c),d.is_new=!1,b.resolve(d)}):(d={search_name:"",namespace:this.options.default_app,domain:"",start_time:"",end_time:"",search:"",search_spec:"",description:"",cron_schedule:"",realtime_schedule_isenabled:!0,severity:"",next_steps:'{"version":1, "data":""}',recommended_actions:"",default_status:"",default_owner:"",drilldown_search:"",drilldown_name:"",drilldown_earliest_offset:"",drilldown_latest_offset:"",duration:"",group_by:"",rule_title:"",rule_description:"",name:"",alerts:{}},d.is_new=!0,b.resolve(d)),b},render:function(){var b=this;return f.when(this.getNotableInfo(),e.getSearchNames(),this.getContent(),this.getCorrelationSearchInfo(),e.getImportedApps(void 0,"disabled=false"),e.getManagedLookup("security_domain_lookup"),e.hasCapability("edit_correlationsearches")).done(function(c,d,e,g,i,k,l){b.search_names=d,e.list_link=b.list_link,e.list_link_title=b.list_link_title,e.can_edit=l,e.domains=k.content["eai:data"].split(/,|\n/).filter(function(a,b,c){return 1!==b&&b%6===1&&"true"===c[b+3]}),e.namespaces=i,e.severities=g.severities,e.owners=c.users,e.statuses=c.statuses,e.urgencies=c.urgencies,e.semanticallyCorrectDuration=b.semanticallyCorrectDuration,b.$el.html(a.template(h,e)),b.toggleCronSchedule(),f('input[name="group_by"]',b.$el).tagsManager({delimiters:[44,9,13],prefilled:e.group_by.split(",")}),e.can_edit||f(".tm-tag-remove").text("");var m=!1,n=null;if(e.search_spec.length>0)try{n=f.parseJSON(e.search_spec),m=n.hasOwnProperty("searches")}catch(o){m=!1}e.search_spec&&m&&b.updateSearchInformation(e.search,n,void 0,void 0,m),b.alertManager=new j({recommended_actions:[],show_recom_act_chkbox:!1,el:f("#actions-control-group > .controls",b.$el)}),f.when(b.alertManager.render()).then(function(b){var c=b.getCustomkeys(),d={};c.forEach(function(a){var b=a.split(".");"action"===b[0]&&4===b.length&&(d[a]=e[b[3]])}),d=a.extend(d,e.alerts),b.setConfig(d)})}),this}});return k});