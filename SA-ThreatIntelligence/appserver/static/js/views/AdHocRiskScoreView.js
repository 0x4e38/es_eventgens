"use strict";require.config({paths:{text:"../app/SA-Utils/js/lib/text"}}),define(["underscore","backbone","splunkjs/mvc","jquery","sa-utils/js/util/Utils","splunkjs/mvc/simplesplunkview","sa-utils/js/util/FormUtils","splunkjs/mvc/simpleform/input/dropdown","splunkjs/mvc/simpleform/input/text","splunkjs/mvc/searchmanager","text!sa-threatintelligence/js/templates/AdHocRiskScoreDialog.html","sa-utils/js/util/Console"],function(a,b,c,d,e,f,g,h,i,j,k){var l=f.extend({className:"AdHocRiskScoreView",defaults:{search_managers:[]},events:{"click #create-adhoc-risk":"openAdHocRiskDialog","click .btn-save":"saveAdHocEntry"},initialize:function(){this.options=a.extend({},this.defaults,this.options),this.search_managers=this.options.search_managers.slice(0)},showSaving:function(a){a?(d("#save",this.$el).text("Saving..."),d("#cancel",this.$el).attr("disabled","true")):(d("#save",this.$el).text("Save"),d("#cancel",this.$el).attr("disabled","false"))},hideWarning:function(){d("#warning-message",this.$el).hide()},showWarning:function(a){d("#warning-message-text",this.$el).text(a),d("#warning-message",this.$el).show()},parseIntIfValid:function(a){var b=/^[-]?\d+$/;return b.test(a)?parseInt(a,10):NaN},validate:function(){return this.parseIntIfValid(c.Components.get("risk_score").val())?""===c.Components.get("risk_object").val()?(this.showWarning("The risk object must be defined"),!1):""===c.Components.get("risk_object_type").val()?(this.showWarning("The risk object type must be selected"),!1):""!==c.Components.get("risk_description").val()||(this.showWarning("The risk description must be provided"),!1):(this.showWarning("The risk score must be a valid integer"),!1)},makeContentBody:function(a){var b="\n==##~~##~~  1E8N3D4E6V5E7N2T9 ~~##~~##==\n";for(var c in a)b=b+c+'="'+a[c]+'", ';return b},clearForm:function(){this.hideWarning(),c.Components.get("risk_description").val(""),c.Components.get("risk_score").val(""),c.Components.get("risk_object").val(""),c.Components.get("risk_object_type").val("")},kickSearches:function(){if(this.search_managers)if("[object Array]"===Object.prototype.toString.call(this.search_managers))for(var a=0;a<this.search_managers.length;a++)this.search_managers[a].startSearch();else this.search_managers.startSearch()},makeModAlertParamValue:function(a){var b=a;return b=b.replace(/"/g,'\\"'),'"'+b+'"'},saveAdHocEntry:function(){var a=this;if(this.validate()){var b={action_name:"risk",search:"| makeresults | eval risk_object = "+this.makeModAlertParamValue(c.Components.get("risk_object").val())+" | eval description = "+this.makeModAlertParamValue(c.Components.get("risk_description").val()),"action.risk.param._risk_score":c.Components.get("risk_score").val(),"action.risk.param._risk_object":"","action.risk.param._risk_object_type":this.makeModAlertParamValue(c.Components.get("risk_object_type").val())},e=Splunk.util.make_url("/splunkd/__raw/services/alerts/modaction_adhoc");this.showSaving(!0),jQuery.ajax({url:e,type:"POST",data:b,success:function(b){d("#adHocRiskScoreModal",a.$el).modal("hide"),a.clearForm(),a.kickSearches()},complete:function(b,c){a.showSaving(!1)}})}},openAdHocRiskDialog:function(){d("#adHocRiskScoreModal",this.$el).modal()},render:function(){var a=this;this.$el.html(k),d.when(e.hasCapability("edit_tcp")).then(function(b){b&&d("#create-adhoc-risk-holder",a.$el).show()});new j({autostart:!0,id:"risk_object_type_search",earliest_time:"-24h",latest_time:"now",search:"| `risk_object_types`"},{tokens:!0}),new h({id:"risk_object_type",selectFirstChoice:!1,value:"$form.risk_object_type$",managerid:"risk_object_type_search",valueField:"risk_object_type",labelField:"risk_object_type",showClearButton:!1,el:d("#risk-object-type",this.$el)},{tokens:!0}).render(),new i({id:"risk_object",searchWhenChanged:!1,value:"$form.risk_object$",el:d("#risk-object",this.$el)},{tokens:!0}).render(),new i({id:"risk_score",searchWhenChanged:!1,value:"$form.risk_score$",el:d("#risk-score",this.$el)},{tokens:!0}).render(),new i({id:"risk_description",searchWhenChanged:!1,value:"$form.risk_description$",el:d("#risk-description",this.$el)},{tokens:!0}).render();this.clearForm()}});return l});