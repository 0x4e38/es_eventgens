
###### Correlation Searches ######
## per SPL-98457 - moving "| table" in front of ppf lookup
[Threat - Threat List Activity - Rule]
action.email.sendresults            = 0
action.risk                         = 1
## risk_object_type, risk_object, and risk_score set via search language
## they are also set below for UI consistency
action.risk.param._risk_object      = src
action.risk.param._risk_object_type = system
action.risk.param._risk_score       = 40
action.notable                      = 1
## action.summary_index._name present for migration purposes
action.summary_index._name          = notable
alert.digest_mode                   = 1
alert.suppress                      = 1
alert.suppress.fields               = threat_match_field,threat_match_value
alert.suppress.period               = 86300s
alert.track                         = false
cron_schedule                       = 10 * * * *
disabled                            = True
dispatch.earliest_time              = -65m@m
dispatch.latest_time                = -5m@m
enableSched                         = 1
is_visible                          = false
request.ui_dispatch_app             = SplunkEnterpriseSecuritySuite
search                              = | datamodel Threat_Intelligence Threat_Activity search | `drop_dm_object_name("Threat_Activity")` | dedup threat_match_field,threat_match_value | `get_event_id` | table _raw,event_id,source,src,dest,threat*,weight | rename weight as record_weight | `per_panel_filter("ppf_threat_activity","threat_match_field,threat_match_value")` | `get_threat_attribution(threat_key)` | rename source_* as threat_source_*,description as threat_description | eval risk_score=case(isnum(record_weight), record_weight, isnum(weight), weight, 1=1, null())  | fields - *time | eval risk_object_type=case(threat_match_field="query" OR threat_match_field=="src" OR threat_match_field=="dest","system",threat_match_field=="src_user" OR threat_match_field=="user","user",1=1,"other") | eval risk_object=threat_match_value

###### Key Indicator Searches ######
[Threat Activity - Unique Categories]
action.email.reportServerEnabled              = 0
alert.track                                   = 0
action.keyindicator                           = 1
action.keyindicator.title                     = Threat Categories
action.keyindicator.subtitle                  = Unique Count
action.keyindicator.value                     = current_count
action.keyindicator.threshold                 = 
action.keyindicator.delta                     = delta
action.keyindicator.invert                    = false
action.keyindicator.group.0.name              = threat_activity
action.keyindicator.group.0.order             = 2
dispatch.earliest_time                        = -48h@h
dispatch.latest_time                          = now
display.general.enablePreview                 = 1
display.general.timeRangePicker.show          = false
display.general.type                          = visualizations
display.statistics.rowNumbers                 = 0
display.statistics.wrap                       = 0
display.visualizations.charting.drilldown     = all
display.visualizations.singlevalue.underLabel = Unique Threat Categories
display.visualizations.show                   = 1
display.visualizations.type                   = singlevalue
request.ui_dispatch_app                       = SplunkEnterpriseSecuritySuite
search                                        = | tstats `summariesonly` count from datamodel=Threat_Intelligence.Threat_Activity where earliest=-24h@h latest=+0s by Threat_Activity.threat_key | `drop_dm_object_name("Threat_Activity")` | `get_threat_attribution(threat_key)` | stats dc(threat_category) as current_count | appendcols [| tstats `summariesonly` count from datamodel=Threat_Intelligence.Threat_Activity where earliest=-48h@h latest=-24h@h by Threat_Activity.threat_key | `drop_dm_object_name("Threat_Activity")` | `get_threat_attribution(threat_key)` | stats dc(threat_category) as historical_count] | `get_delta`

[Threat Activity - Unique Collections]
action.email.reportServerEnabled              = 0
alert.track                                   = 0
action.keyindicator                           = 1
action.keyindicator.title                     = Threat Collections
action.keyindicator.subtitle                  = Unique Count
action.keyindicator.value                     = current_count
action.keyindicator.threshold                 = 
action.keyindicator.delta                     = delta
action.keyindicator.invert                    = false
action.keyindicator.group.0.name              = threat_activity
action.keyindicator.group.0.order             = 1
dispatch.earliest_time                        = -48h@h
dispatch.latest_time                          = now
display.general.enablePreview                 = 1
display.general.timeRangePicker.show          = false
display.general.type                          = visualizations
display.statistics.rowNumbers                 = 0
display.statistics.wrap                       = 0
display.visualizations.charting.drilldown     = all
display.visualizations.singlevalue.underLabel = Unique Threat Collections
display.visualizations.show                   = 1
display.visualizations.type                   = singlevalue
request.ui_dispatch_app                       = SplunkEnterpriseSecuritySuite
search                                        = | tstats `summariesonly` estdc(Threat_Activity.threat_collection) as current_count from datamodel=Threat_Intelligence.Threat_Activity where earliest=-24h@h latest=+0s | appendcols [| tstats `summariesonly` estdc(Threat_Activity.threat_collection) as historical_count from datamodel=Threat_Intelligence.Threat_Activity where earliest=-48h@h latest=-24h@h] | `get_delta`

[Threat Activity - Unique Matches]
action.email.reportServerEnabled              = 0
alert.track                                   = 0
action.keyindicator                           = 1
action.keyindicator.title                     = Threat Matches
action.keyindicator.subtitle                  = Unique Count
action.keyindicator.value                     = current_count
action.keyindicator.threshold                 = 
action.keyindicator.delta                     = delta
action.keyindicator.invert                    = false
action.keyindicator.group.0.name              = threat_activity
action.keyindicator.group.0.order             = 0
dispatch.earliest_time                        = -48h@h
dispatch.latest_time                          = now
display.general.enablePreview                 = 1
display.general.timeRangePicker.show          = false
display.general.type                          = visualizations
display.statistics.rowNumbers                 = 0
display.statistics.wrap                       = 0
display.visualizations.charting.drilldown     = all
display.visualizations.singlevalue.underLabel = Unique Threat Matches
display.visualizations.show                   = 1
display.visualizations.type                   = singlevalue
request.ui_dispatch_app                       = SplunkEnterpriseSecuritySuite
search                                        = | tstats `summariesonly` count from datamodel=Threat_Intelligence.Threat_Activity where earliest=-24h@h latest=+0s by Threat_Activity.threat_match_field,Threat_Activity.threat_match_value | stats count as current_count | appendcols [| tstats `summariesonly` count from datamodel=Threat_Intelligence.Threat_Activity where earliest=-48h@h latest=-24h@h by Threat_Activity.threat_match_field,Threat_Activity.threat_match_value | stats count as historical_count] | `get_delta`

[Threat Activity - Unique Sources]
action.email.reportServerEnabled              = 0
alert.track                                   = 0
action.keyindicator                           = 1
action.keyindicator.title                     = Threat Sources
action.keyindicator.subtitle                  = Unique Count
action.keyindicator.value                     = current_count
action.keyindicator.threshold                 = 
action.keyindicator.delta                     = delta
action.keyindicator.invert                    = false
action.keyindicator.group.0.name              = threat_activity
action.keyindicator.group.0.order             = 3
dispatch.earliest_time                        = -48h@h
dispatch.latest_time                          = now
display.general.enablePreview                 = 1
display.general.timeRangePicker.show          = false
display.general.type                          = visualizations
display.statistics.rowNumbers                 = 0
display.statistics.wrap                       = 0
display.visualizations.charting.drilldown     = all
display.visualizations.singlevalue.underLabel = Unique Threat Sources
display.visualizations.show                   = 1
display.visualizations.type                   = singlevalue
request.ui_dispatch_app                       = SplunkEnterpriseSecuritySuite
search                                        = | tstats `summariesonly` estdc(Threat_Activity.threat_key) as current_count from datamodel=Threat_Intelligence.Threat_Activity where earliest=-24h@h latest=+0s | appendcols [| tstats `summariesonly` estdc(Threat_Activity.threat_key) as historical_count from datamodel=Threat_Intelligence.Threat_Activity where earliest=-48h@h latest=-24h@h] | `get_delta`

[Threat Activity - Total Count]
action.email.reportServerEnabled              = 0
alert.track                                   = 0
action.keyindicator                           = 1
action.keyindicator.title                     = Threat Activity
action.keyindicator.subtitle                  = Total Count
action.keyindicator.value                     = current_count
action.keyindicator.threshold                 = 
action.keyindicator.delta                     = delta
action.keyindicator.invert                    = false
action.keyindicator.group.0.name              = threat_activity
action.keyindicator.group.0.order             = 4
dispatch.earliest_time                        = -48h@h
dispatch.latest_time                          = now
display.general.enablePreview                 = 1
display.general.timeRangePicker.show          = false
display.general.type                          = visualizations
display.statistics.rowNumbers                 = 0
display.statistics.wrap                       = 0
display.visualizations.charting.drilldown     = all
display.visualizations.singlevalue.underLabel = Threat Activity Count
display.visualizations.show                   = 1
display.visualizations.type                   = singlevalue
request.ui_dispatch_app                       = SplunkEnterpriseSecuritySuite
search                                        = | tstats `summariesonly` count as current_count from datamodel=Threat_Intelligence.Threat_Activity where earliest=-24h@h latest=+0s | appendcols [| tstats `summariesonly` count as historical_count from datamodel=Threat_Intelligence.Threat_Activity where earliest=-48h@h latest=-24h@h] | `get_delta`

###### Lookup Generating Searches ######
[Threat - Threat Intelligence By Certificate Common Name - Lookup Gen]
action.threat_outputlookup             = 1
action.threat_outputlookup.collections = certificate_intel
enableSched                            = 0
is_visible                             = false
request.ui_dispatch_app                = SplunkEnterpriseSecuritySuite
search                                 = | `certificate_intel` | rex field=certificate_issuer "CN\s*=(?<_certificate_issuer_common_name>.*?)(?=[,;/]\s*(?:[A-Z]+|emailAddress)\s*=|$)" | rex field=certificate_subject "CN\s*=(?<_certificate_subject_common_name>.*?)(?=[,;/]\s*(?:[A-Z]+|emailAddress)\s*=|$)" | eval certificate_common_name=if(isnull(certificate_issuer_common_name),_certificate_issuer_common_name,certificate_issuer_common_name) | eval certificate_subject_common_name=if(isnull(certificate_subject_common_name),_certificate_subject_common_name,certificate_subject_common_name) | `mvappend_field(certificate_common_name,certificate_subject_common_name)` | `threatintel_outputlookup(certificate_common_name)`

[Threat - Threat Intelligence By Certificate Common Name Wildcard - Lookup Gen]
action.threat_outputlookup             = 1
action.threat_outputlookup.collections = certificate_intel
enableSched                            = 0
is_visible                             = false
request.ui_dispatch_app                = SplunkEnterpriseSecuritySuite
search                                 = | `certificate_intel` | rex field=certificate_issuer "CN\s*=(?<_certificate_issuer_common_name>.*?)(?=[,;/]\s*(?:[A-Z]+|emailAddress)\s*=|$)" | rex field=certificate_subject "CN\s*=(?<_certificate_subject_common_name>.*?)(?=[,;/]\s*(?:[A-Z]+|emailAddress)\s*=|$)" | eval certificate_common_name=if(isnull(certificate_issuer_common_name),_certificate_issuer_common_name,certificate_issuer_common_name) | eval certificate_subject_common_name=if(isnull(certificate_subject_common_name),_certificate_subject_common_name,certificate_subject_common_name) | `mvappend_field(certificate_common_name,certificate_subject_common_name)` | `threatintel_outputlookup_wildcard(certificate_common_name)`

[Threat - Threat Intelligence By Certificate Organization - Lookup Gen]
action.threat_outputlookup             = 1
action.threat_outputlookup.collections = certificate_intel
enableSched                            = 0
is_visible                             = false
request.ui_dispatch_app                = SplunkEnterpriseSecuritySuite
search                                 = | `certificate_intel` | rex field=certificate_issuer "O\s*=(?<_certificate_issuer_org>.*?)(?=[,;/]\s*(?:[A-Z]+|emailAddress)\s*=|$)" | rex field=certificate_subject "O\s*=(?<_certificate_subject_org>.*?)(?=[,;/]\s*(?:[A-Z]+|emailAddress)\s*=|$)" | eval certificate_organization=if(isnull(certificate_issuer_organization),_certificate_issuer_org,certificate_issuer_organization) | eval certificate_subject_organization=if(isnull(certificate_subject_organization),_certificate_subject_org,certificate_subject_organization) | `mvappend_field(certificate_organization,certificate_subject_organization)` | `threatintel_outputlookup(certificate_organization)`

[Threat - Threat Intelligence By Certificate Organization Wildcard - Lookup Gen]
action.threat_outputlookup             = 1
action.threat_outputlookup.collections = certificate_intel
enableSched                            = 0
is_visible                             = false
request.ui_dispatch_app                = SplunkEnterpriseSecuritySuite
search                                 = | `certificate_intel` | rex field=certificate_issuer "O\s*=(?<_certificate_issuer_org>.*?)(?=[,;/]\s*(?:[A-Z]+|emailAddress)\s*=|$)" | rex field=certificate_subject "O\s*=(?<_certificate_subject_org>.*?)(?=[,;/]\s*(?:[A-Z]+|emailAddress)\s*=|$)" | eval certificate_organization=if(isnull(certificate_issuer_organization),_certificate_issuer_org,certificate_issuer_organization) | eval certificate_subject_organization=if(isnull(certificate_subject_organization),_certificate_subject_org,certificate_subject_organization) | `mvappend_field(certificate_organization,certificate_subject_organization)` | `threatintel_outputlookup_wildcard(certificate_organization)`

[Threat - Threat Intelligence By Certificate Serial - Lookup Gen]
action.threat_outputlookup             = 1
action.threat_outputlookup.collections = certificate_intel
enableSched                            = 0
is_visible                             = false
request.ui_dispatch_app                = SplunkEnterpriseSecuritySuite
search                                 = | `certificate_intel` | `mvappend_field(certificate_serial_clean,certificate_serial_dec)` | rename certificate_serial_clean as certificate_serial | `threatintel_outputlookup(certificate_serial)`

[Threat - Threat Intelligence By Certificate Unit - Lookup Gen]
action.threat_outputlookup             = 1
action.threat_outputlookup.collections = certificate_intel
enableSched                            = 0
is_visible                             = false
request.ui_dispatch_app                = SplunkEnterpriseSecuritySuite
search                                 = | `certificate_intel` | rex field=certificate_issuer "OU\s*=(?<_certificate_issuer_unit>.*?)(?=[,;/]\s*(?:[A-Z]+|emailAddress)\s*=|$)" | rex field=certificate_subject "OU\s*=(?<_certificate_subject_unit>.*?)(?=[,;/]\s*(?:[A-Z]+|emailAddress)\s*=|$)" | eval certificate_unit=if(isnull(certificate_issuer_unit),_certificate_issuer_unit,certificate_issuer_unit) | eval certificate_subject_unit=if(isnull(certificate_subject_unit),_certificate_subject_unit,certificate_subject_unit) | `mvappend_field(certificate_unit,certificate_subject_unit)` | `threatintel_outputlookup(certificate_unit)`

[Threat - Threat Intelligence By Certificate Unit Wildcard - Lookup Gen]
action.threat_outputlookup             = 1
action.threat_outputlookup.collections = certificate_intel
enableSched                            = 0
is_visible                             = false
request.ui_dispatch_app                = SplunkEnterpriseSecuritySuite
search                                 = | `certificate_intel` | rex field=certificate_issuer "OU\s*=(?<_certificate_issuer_unit>.*?)(?=[,;/]\s*(?:[A-Z]+|emailAddress)\s*=|$)" | rex field=certificate_subject "OU\s*=(?<_certificate_subject_unit>.*?)(?=[,;/]\s*(?:[A-Z]+|emailAddress)\s*=|$)" | eval certificate_unit=if(isnull(certificate_issuer_unit),_certificate_issuer_unit,certificate_issuer_unit) | eval certificate_subject_unit=if(isnull(certificate_subject_unit),_certificate_subject_unit,certificate_subject_unit) | `mvappend_field(certificate_unit,certificate_subject_unit)` | `threatintel_outputlookup_wildcard(certificate_unit)`

[Threat - Threat Intelligence By CIDR - Lookup Gen]
action.threat_outputlookup             = 1
action.threat_outputlookup.collections = certificate_intel,email_intel,http_intel,ip_intel,process_intel
enableSched                            = 0
is_visible                             = false
request.ui_dispatch_app                = SplunkEnterpriseSecuritySuite
search                                 = | `certificate_intel` | `email_intel` | `http_intel` | `ip_intel` | `process_intel` | `mvappend_field(ip,embedded_ip)` | `mvappend_field(ip,src)` | `mvappend_field(ip,dest)` | `get_threat_download_status` | `threatintel_outputlookup_exclusions` | mvexpand ip | rename ip as cidr,_key as threat_collection_key | dedup cidr,threat_collection_key,threat_key | where isnotnull(cidr) AND match(cidr,"\/[0-9]{1,2}") | fillnull value="X" weight | table cidr,threat_collection,threat_collection_key,threat_key,weight | outputlookup threatintel_by_cidr | stats count

[Threat - Threat Intelligence By Domain - Lookup Gen]
action.threat_outputlookup             = 1
action.threat_outputlookup.collections = certificate_intel,email_intel,http_intel,ip_intel
enableSched                            = 0
is_visible                             = false
request.ui_dispatch_app                = SplunkEnterpriseSecuritySuite
search                                 = | `certificate_intel` | `email_intel` | `http_intel` | `ip_intel` | `mvappend_field(domain,embedded_domain)` | `threatintel_outputlookup(domain)`

[Threat - Threat Intelligence By Email - Lookup Gen]
action.threat_outputlookup             = 1
action.threat_outputlookup.collections = certificate_intel,email_intel
enableSched                            = 0
is_visible                             = false
request.ui_dispatch_app                = SplunkEnterpriseSecuritySuite
search                                 = | `certificate_intel` | rex field=certificate_issuer "(?:E|emailAddress)\s*=(?<_certificate_issuer_email>.*?)(?=[,;/]\s*(?:[A-Z]+|emailAddress)\s*=|$)" | rex field=certificate_subject "(?:E|emailAddress)\s*=(?<_certificate_subject_email>.*?)(?=[,;/]\s*(?:[A-Z]+|emailAddress)\s*=|$)" | eval certificate_issuer_email=if(isnull(certificate_issuer_email),_certificate_issuer_email,certificate_issuer_email) | eval certificate_subject_email=if(isnull(certificate_subject_email),_certificate_subject_email,certificate_subject_email) | `email_intel` | `mvappend_field(src_user,certificate_issuer_email)` | `mvappend_field(src_user,certificate_subject_email)` | rename src_user as email | `threatintel_outputlookup(email)`

[Threat - Threat Intelligence By Email Wildcard - Lookup Gen]
action.threat_outputlookup             = 1
action.threat_outputlookup.collections = certificate_intel,email_intel
enableSched                            = 0
is_visible                             = false
request.ui_dispatch_app                = SplunkEnterpriseSecuritySuite
search                                 = | `certificate_intel` | rex field=certificate_issuer "(?:E|emailAddress)\s*=(?<_certificate_issuer_email>.*?)(?=[,;/]\s*(?:[A-Z]+|emailAddress)\s*=|$)" | rex field=certificate_subject "(?:E|emailAddress)\s*=(?<_certificate_subject_email>.*?)(?=[,;/]\s*(?:[A-Z]+|emailAddress)\s*=|$)" | eval certificate_issuer_email=if(isnull(certificate_issuer_email),_certificate_issuer_email,certificate_issuer_email) | eval certificate_subject_email=if(isnull(certificate_subject_email),_certificate_subject_email,certificate_subject_email) | `email_intel` | `mvappend_field(src_user,certificate_issuer_email)` | `mvappend_field(src_user,certificate_subject_email)` | rename src_user as email | `threatintel_outputlookup_wildcard(email)`

[Threat - Threat Intelligence By Email Subject - Lookup Gen]
action.threat_outputlookup             = 1
action.threat_outputlookup.collections = email_intel
enableSched                            = 0
is_visible                             = false
request.ui_dispatch_app                = SplunkEnterpriseSecuritySuite
search                                 = | `email_intel` | `threatintel_outputlookup("subject","threatintel_by_email_subject")`

[Threat - Threat Intelligence By Email Subject Wildcard - Lookup Gen]
action.threat_outputlookup             = 1
action.threat_outputlookup.collections = email_intel
enableSched                            = 0
is_visible                             = false
request.ui_dispatch_app                = SplunkEnterpriseSecuritySuite
search                                 = | `email_intel` | `threatintel_outputlookup_wildcard("subject","threatintel_by_email_subject_wildcard")`

[Threat - Threat Intelligence By File Hash - Lookup Gen]
action.threat_outputlookup             = 1
action.threat_outputlookup.collections = certificate_intel,email_intel,file_intel,service_intel
enableSched                            = 0
is_visible                             = false
request.ui_dispatch_app                = SplunkEnterpriseSecuritySuite
search                                 = | `certificate_intel` | `email_intel` | `file_intel` | `service_intel` | `mvappend_field(file_hash,service_file_hash)` | `mvappend_field(file_hash,service_dll_file_hash)` | `threatintel_outputlookup(file_hash)`

[Threat - Threat Intelligence By File Name - Lookup Gen]
action.threat_outputlookup             = 1
action.threat_outputlookup.collections = certificate_intel,email_intel,file_intel,service_intel
enableSched                            = 0
is_visible                             = false
request.ui_dispatch_app                = SplunkEnterpriseSecuritySuite
search                                 = | `email_intel` | `file_intel` | `process_intel` | `mvappend_field(file_name,process_file_name)` | `threatintel_outputlookup(file_name)`

[Threat - Threat Intelligence By File Name Wildcard - Lookup Gen]
action.threat_outputlookup             = 1
action.threat_outputlookup.collections = certificate_intel,email_intel,file_intel,service_intel
enableSched                            = 0
is_visible                             = false
request.ui_dispatch_app                = SplunkEnterpriseSecuritySuite
search                                 = | `email_intel` | `file_intel` | `process_intel` | `mvappend_field(file_name,process_file_name)` | `threatintel_outputlookup_wildcard(file_name)`

[Threat - Threat Intelligence By HTTP User Agent - Lookup Gen]
action.threat_outputlookup             = 1
action.threat_outputlookup.collections = http_intel
enableSched                            = 0
is_visible                             = false
request.ui_dispatch_app                = SplunkEnterpriseSecuritySuite
search                                 = | `http_intel` | `threatintel_outputlookup(http_user_agent)`

[Threat - Threat Intelligence By HTTP User Agent Wildcard - Lookup Gen]
action.threat_outputlookup             = 1
action.threat_outputlookup.collections = http_intel
enableSched                            = 0
is_visible                             = false
request.ui_dispatch_app                = SplunkEnterpriseSecuritySuite
search                                 = | `http_intel` | `threatintel_outputlookup_wildcard(http_user_agent)`

[Threat - Threat Intelligence By Process - Lookup Gen]
action.threat_outputlookup             = 1
action.threat_outputlookup.collections = process_intel
enableSched                            = 0
is_visible                             = false
request.ui_dispatch_app                = SplunkEnterpriseSecuritySuite
search                                 = | `process_intel` | `threatintel_outputlookup(process)`

[Threat - Threat Intelligence By Process Wildcard - Lookup Gen]
action.threat_outputlookup             = 1
action.threat_outputlookup.collections = process_intel
enableSched                            = 0
is_visible                             = false
request.ui_dispatch_app                = SplunkEnterpriseSecuritySuite
search                                 = | `process_intel` | `threatintel_outputlookup_wildcard(process)`

[Threat - Threat Intelligence By Registry Path - Lookup Gen]
action.threat_outputlookup             = 1
action.threat_outputlookup.collections = registry_intel
enableSched                            = 0
is_visible                             = false
request.ui_dispatch_app                = SplunkEnterpriseSecuritySuite
search                                 = | `registry_intel` | `threatintel_outputlookup(registry_path)`

[Threat - Threat Intelligence By Registry Path Wildcard - Lookup Gen]
action.threat_outputlookup             = 1
action.threat_outputlookup.collections = registry_intel
enableSched                            = 0
is_visible                             = false
request.ui_dispatch_app                = SplunkEnterpriseSecuritySuite
search                                 = | `registry_intel` | `threatintel_outputlookup_wildcard(registry_path)`

[Threat - Threat Intelligence By Registry Value Name - Lookup Gen]
action.threat_outputlookup             = 1
action.threat_outputlookup.collections = registry_intel
enableSched                            = 0
is_visible                             = false
request.ui_dispatch_app                = SplunkEnterpriseSecuritySuite
search                                 = | `registry_intel` | `threatintel_outputlookup(registry_value_name)`

[Threat - Threat Intelligence By Registry Value Name Wildcard - Lookup Gen]
action.threat_outputlookup             = 1
action.threat_outputlookup.collections = registry_intel
enableSched                            = 0
is_visible                             = false
request.ui_dispatch_app                = SplunkEnterpriseSecuritySuite
search                                 = | `registry_intel` | `threatintel_outputlookup_wildcard(registry_value_name)`

[Threat - Threat Intelligence By Registry Value Text - Lookup Gen]
action.threat_outputlookup             = 1
action.threat_outputlookup.collections = registry_intel
enableSched                            = 0
is_visible                             = false
request.ui_dispatch_app                = SplunkEnterpriseSecuritySuite
search                                 = | `registry_intel` | `threatintel_outputlookup(registry_value_text)`

[Threat - Threat Intelligence By Registry Value Text Wildcard - Lookup Gen]
action.threat_outputlookup             = 1
action.threat_outputlookup.collections = registry_intel
enableSched                            = 0
is_visible                             = false
request.ui_dispatch_app                = SplunkEnterpriseSecuritySuite
search                                 = | `registry_intel` | `threatintel_outputlookup_wildcard(registry_value_text)`

[Threat - Threat Intelligence By Service - Lookup Gen]
action.threat_outputlookup             = 1
action.threat_outputlookup.collections = service_intel
enableSched                            = 0
is_visible                             = false
request.ui_dispatch_app                = SplunkEnterpriseSecuritySuite
search                                 = | `service_intel` | `threatintel_outputlookup(service)`

[Threat - Threat Intelligence By Service Wildcard - Lookup Gen]
action.threat_outputlookup             = 1
action.threat_outputlookup.collections = service_intel
enableSched                            = 0
is_visible                             = false
request.ui_dispatch_app                = SplunkEnterpriseSecuritySuite
search                                 = | `service_intel` | `threatintel_outputlookup_wildcard(service)`

[Threat - Threat Intelligence By System - Lookup Gen]
action.threat_outputlookup             = 1
action.threat_outputlookup.collections = certificate_intel,email_intel,http_intel,ip_intel,process_intel
enableSched                            = 0
is_visible                             = false
request.ui_dispatch_app                = SplunkEnterpriseSecuritySuite
search                                 = | `certificate_intel` | `email_intel` | `http_intel` | `ip_intel` | `process_intel` | `mvappend_field(ip,embedded_ip)` | `mvappend_field(ip,src)` | `mvappend_field(ip,dest)` | `get_threat_download_status` | `threatintel_outputlookup_exclusions` | mvexpand ip | rename ip as system,_key as threat_collection_key | dedup system,threat_collection_key,threat_key | where isnotnull(system) AND NOT match(system,"\/[0-9]{1,2}") | fillnull value="X" weight | table system,threat_collection,threat_collection_key,threat_key,weight | outputlookup threatintel_by_system | stats count

[Threat - Threat Intelligence By URL - Lookup Gen]
action.threat_outputlookup             = 1
action.threat_outputlookup.collections = http_intel
enableSched                            = 0
is_visible                             = false
request.ui_dispatch_app                = SplunkEnterpriseSecuritySuite
search                                 = | `http_intel` | `mvappend_field(url,http_referrer)` | `threatintel_outputlookup(url)`

[Threat - Threat Intelligence By URL Wildcard - Lookup Gen]
action.threat_outputlookup             = 1
action.threat_outputlookup.collections = http_intel
enableSched                            = 0
is_visible                             = false
request.ui_dispatch_app                = SplunkEnterpriseSecuritySuite
search                                 = | `http_intel` | `mvappend_field(url,http_referrer)` | `threatintel_outputlookup_wildcard(url)`

[Threat - Threat Intelligence By User - Lookup Gen]
action.threat_outputlookup             = 1
action.threat_outputlookup.collections = registry_intel,user_intel
enableSched                            = 0
is_visible                             = false
request.ui_dispatch_app                = SplunkEnterpriseSecuritySuite
search                                 = | `registry_intel` | `user_intel` | `threatintel_outputlookup(user)`

[Threat - Threat Intelligence By User Wildcard - Lookup Gen]
action.threat_outputlookup             = 1
action.threat_outputlookup.collections = registry_intel,user_intel
enableSched                            = 0
is_visible                             = false
request.ui_dispatch_app                = SplunkEnterpriseSecuritySuite
search                                 = | `registry_intel` | `user_intel` | `threatintel_outputlookup_wildcard(user)`

###### Threat Intelligence Retention #####
[Threat - Certificate Threat Intelligence Retention - Lookup Gen]
cron_schedule                        = 0 3 * * *
disabled                             = true
dispatch.latest_time                 = +0s
enableSched                          = true
is_visible                           = false
request.ui_dispatch_app              = SplunkEnterpriseSecuritySuite
schedule_window                      = 20
search                                 = | `filter_threatintel_collection("certificate_intel")`

[Threat - Email Threat Intelligence Retention - Lookup Gen]
cron_schedule                        = 5 3 * * *
disabled                             = true
dispatch.latest_time                 = +0s
enableSched                          = true
is_visible                           = false
request.ui_dispatch_app              = SplunkEnterpriseSecuritySuite
schedule_window                      = 20
search                                 = | `filter_threatintel_collection("email_intel")`

[Threat - File Threat Intelligence Retention - Lookup Gen]
cron_schedule                        = 10 3 * * *
disabled                             = true
dispatch.latest_time                 = +0s
enableSched                          = true
is_visible                           = false
request.ui_dispatch_app              = SplunkEnterpriseSecuritySuite
schedule_window                      = 20
search                                 = | `filter_threatintel_collection("file_intel")`

[Threat - HTTP Threat Intelligence Retention - Lookup Gen]
cron_schedule                        = 15 3 * * *
disabled                             = true
dispatch.latest_time                 = +0s
enableSched                          = true
is_visible                           = false
request.ui_dispatch_app              = SplunkEnterpriseSecuritySuite
schedule_window                      = 20
search                                 = | `filter_threatintel_collection("http_intel")`

[Threat - IP Intelligence Retention - Lookup Gen]
cron_schedule                        = 20 3 * * *
disabled                             = true
dispatch.latest_time                 = +0s
enableSched                          = true
is_visible                           = false
request.ui_dispatch_app              = SplunkEnterpriseSecuritySuite
schedule_window                      = 20
search                                 = | `filter_threatintel_collection("ip_intel")`

[Threat - Process Threat Intelligence Retention - Lookup Gen]
cron_schedule                        = 25 3 * * *
disabled                             = true
dispatch.latest_time                 = +0s
enableSched                          = true
is_visible                           = false
request.ui_dispatch_app              = SplunkEnterpriseSecuritySuite
schedule_window                      = 20
search                                 = | `filter_threatintel_collection("process_intel")`

[Threat - Registry Threat Intelligence Retention - Lookup Gen]
cron_schedule                        = 30 3 * * *
disabled                             = true
dispatch.latest_time                 = +0s
enableSched                          = true
is_visible                           = false
request.ui_dispatch_app              = SplunkEnterpriseSecuritySuite
schedule_window                      = 20
search                                 = | `filter_threatintel_collection("registry_intel")`

[Threat - Service Threat Intelligence Retention - Lookup Gen]
cron_schedule                        = 35 3 * * *
disabled                             = true
dispatch.latest_time                 = +0s
enableSched                          = true
is_visible                           = false
request.ui_dispatch_app              = SplunkEnterpriseSecuritySuite
schedule_window                      = 20
search                                 = | `filter_threatintel_collection("service_intel")`


###### Report Searches ######
[Threat Activity - Most Active Threats Collections] 
action.email.reportServerEnabled          = 0
alert.track                               = 0
dispatch.earliest_time                    = -24h@h
dispatch.latest_time                      = now
display.general.enablePreview             = 1
display.general.timeRangePicker.show      = true
display.general.type                      = statistics
display.statistics.drilldown              = row
display.statistics.rowNumbers             = 0
display.statistics.wrap                   = 0
display.visualizations.show               = 0
request.ui_dispatch_app                   = SplunkEnterpriseSecuritySuite
search                                    = | tstats `summariesonly` values(source) as search,values(Threat_Activity.threat_collection_key) as threat_collection_key,count from datamodel=Threat_Intelligence.Threat_Activity where NOT [| `ppf_subsearch_dm("ppf_threat_activity","threat_match_field,threat_match_value",now(),"Threat_Activity")`] by _time,Threat_Activity.threat_collection span=1h | `drop_dm_object_name("Threat_Activity")` | stats values(search) as search,sparkline(sum(count),1h) as sparkline,dc(threat_collection_key) as dc(artifacts),sum(count) as count by threat_collection | rex max_match=10 field=search "Threat\s*-\s*(?<friendly_search>.*)(?:\s*-\s*Threat\s+Gen)" | rename friendly_search as search | sort - count

[Threat Activity - Most Active Threat Sources] 
action.email.reportServerEnabled          = 0
alert.track                               = 0
dispatch.earliest_time                    = -24h@h
dispatch.latest_time                      = now
display.general.enablePreview             = 1
display.general.timeRangePicker.show      = true
display.general.type                      = statistics
display.statistics.drilldown              = row
display.statistics.rowNumbers             = 0
display.statistics.wrap                   = 0
display.visualizations.show               = 0
request.ui_dispatch_app                   = SplunkEnterpriseSecuritySuite
search                                    = | tstats `summariesonly` count from datamodel=Threat_Intelligence.Threat_Activity where NOT [| `ppf_subsearch_dm("ppf_threat_activity","threat_match_field,threat_match_value",now(),"Threat_Activity")`] by Threat_Activity.threat_key | `drop_dm_object_name("Threat_Activity")` | `get_threat_attribution("threat_key")` | stats sum(count) as count by threat_key,source_id,source_path,source_type | sort 100 - count

[Threat Activity - Systems Impacted By Multiple Threats]
action.email.reportServerEnabled          = 0
alert.track                               = 0
dispatch.earliest_time                    = -24h@h
dispatch.latest_time                      = now
display.general.enablePreview             = 1
display.general.timeRangePicker.show      = true
display.general.type                      = statistics
display.statistics.drilldown              = row
display.statistics.rowNumbers             = 0
display.statistics.wrap                   = 0
display.visualizations.show               = 0
request.ui_dispatch_app                   = SplunkEnterpriseSecuritySuite
search                                    = | tstats `summariesonly` values(Threat_Activity.src) as src,values(Threat_Activity.dest) as dest,count from datamodel=Threat_Intelligence.Threat_Activity where NOT [| `ppf_subsearch_dm("ppf_threat_activity","threat_match_field,threat_match_value",now(),"Threat_Activity")`] by Threat_Activity.threat_match_field,Threat_Activity.threat_match_value,Threat_Activity.threat_key | `drop_dm_object_name("Threat_Activity")` | eval src=if(threat_match_field=="src",null(),src) | eval dest=if(threat_match_field=="dest",null(),dest) | eval system=mvappend(src,NULL,dest) | stats dc(threat_key) as dc(threat) by system | search system!="...truncated..." system!="unknown" "dc(threat)">1 | sort 100 - dc(threat)

[Threat Activity - Threat Activity By Threat Category]
action.email.reportServerEnabled          = 0
alert.track                               = 0
dispatch.earliest_time                    = -24h@h
dispatch.latest_time                      = now
display.general.enablePreview             = 1
display.general.type                      = visualizations
display.statistics.rowNumbers             = 0
display.statistics.wrap                   = 0
display.visualizations.charting.chart     = bar
display.visualizations.charting.drilldown = all
display.visualizations.show               = 1
request.ui_dispatch_app                   = SplunkEnterpriseSecuritySuite
search                                    = | tstats `summariesonly` count from datamodel=Threat_Intelligence.Threat_Activity where NOT [| `ppf_subsearch_dm("ppf_threat_activity","threat_match_field,threat_match_value",now(),"Threat_Activity")`] by Threat_Activity.threat_key | `drop_dm_object_name("Threat_Activity")` | `get_threat_attribution(threat_key)` | stats sum(count) as count by threat_category | sort 10 - count

[Threat Activity - Threat Activity By Threat Group]
action.email.reportServerEnabled          = 0
alert.track                               = 0
dispatch.earliest_time                    = -24h@h
dispatch.latest_time                      = now
display.general.enablePreview             = 1
display.general.type                      = visualizations
display.statistics.rowNumbers             = 0
display.statistics.wrap                   = 0
display.visualizations.charting.chart     = bar
display.visualizations.charting.drilldown = all
display.visualizations.show               = 1
request.ui_dispatch_app                   = SplunkEnterpriseSecuritySuite
search                                    = | tstats `summariesonly` count from datamodel=Threat_Intelligence.Threat_Activity where NOT [| `ppf_subsearch_dm("ppf_threat_activity","threat_match_field,threat_match_value",now(),"Threat_Activity")`] by Threat_Activity.threat_key | `drop_dm_object_name("Threat_Activity")` | `get_threat_attribution(threat_key)` | stats sum(count) as count by threat_group | sort 10 - count

[Threat Activity - Threat Activity Details] 
action.email.reportServerEnabled          = 0
alert.track                               = 0
dispatch.earliest_time                    = -24h@h
dispatch.latest_time                      = now
display.general.enablePreview             = true
display.general.timeRangePicker.show      = true
display.general.type                      = statistics
display.statistics.drilldown              = row
display.statistics.rowNumbers             = 0
display.statistics.wrap                   = 0
display.visualizations.show               = 0
request.ui_dispatch_app                   = SplunkEnterpriseSecuritySuite
search                                    = | tstats `summariesonly` latest(_time) as _time,values(Threat_Activity.orig_sourcetype) as sourcetype,values(Threat_Activity.src) as src,values(Threat_Activity.dest) as dest from datamodel=Threat_Intelligence.Threat_Activity where NOT [| `ppf_subsearch_dm("ppf_threat_activity","threat_match_field,threat_match_value",now(),"Threat_Activity")`] by Threat_Activity.threat_collection,Threat_Activity.threat_match_field,Threat_Activity.threat_match_value,Threat_Activity.threat_key | `drop_dm_object_name("Threat_Activity")` | `get_threat_attribution("threat_key")` | `per_panel_filter("ppf_threat_activity","threat_match_field,threat_match_value")` | rename ppf_filter as filter | sort - filter,_time | table _time,threat_match_field,threat_match_value,filter,sourcetype,src,dest,threat_collection,threat_group,threat_category

[Threat Activity - Threat Activity Over Time] 
action.email.reportServerEnabled          = 0
alert.track                               = 0
dispatch.earliest_time                    = -24h@h
dispatch.latest_time                      = now
dispatchAs                                = user
display.general.enablePreview             = 1
display.general.timeRangePicker.show      = true
display.general.type                      = visualizations
display.statistics.rowNumbers             = 0
display.statistics.wrap                   = 0
display.visualizations.charting.chart     = line
display.visualizations.charting.chart.nullValueMode = zero
display.visualizations.charting.drilldown = all
display.visualizations.show               = 1
display.visualizations.type               = charting
request.ui_dispatch_app                   = SplunkEnterpriseSecuritySuite
search                                    = | `tstats` count from datamodel=Threat_Intelligence.Threat_Activity where NOT [| `ppf_subsearch_dm("ppf_threat_activity","threat_match_field,threat_match_value",now(),"Threat_Activity")`] by _time,Threat_Activity.threat_collection span=10m | timechart count by Threat_Activity.threat_collection | `drop_dm_object_name("Threat_Activity")`

[Threat Activity - Threats Impacting Multiple Systems]
action.email.reportServerEnabled          = 0
alert.track                               = 0
dispatch.earliest_time                    = -24h@h
dispatch.latest_time                      = now
display.general.enablePreview             = 1
display.general.timeRangePicker.show      = true
display.general.type                      = statistics
display.statistics.drilldown              = row
display.statistics.rowNumbers             = 0
display.statistics.wrap                   = 0
display.visualizations.show               = 0
request.ui_dispatch_app                   = SplunkEnterpriseSecuritySuite
search                                    = | tstats `summariesonly` values(Threat_Activity.src) as src,values(Threat_Activity.dest) as dest,count from datamodel=Threat_Intelligence.Threat_Activity where NOT [| `ppf_subsearch_dm("ppf_threat_activity","threat_match_field,threat_match_value",now(),"Threat_Activity")`] by Threat_Activity.threat_match_field,Threat_Activity.threat_match_value,Threat_Activity.threat_key | `drop_dm_object_name("Threat_Activity")` | `get_threat_attribution(threat_key)` | eval src=if(threat_match_field=="src",null(),src) | eval dest=if(threat_match_field=="dest",null(),dest) | eval system=mvappend(src,NULL,dest) | stats dc(system) by source_path | search "dc(system)">1 | sort 100 - dc(system)

###### Threat (Match) Generating Searches ######
[Threat - Certificate Common Name Matches - Threat Gen]
action.email.sendresults             = 0
alert.digest_mode                    = 1
alert.suppress                       = 1
alert.suppress.fields                = certificate_common_name,threat_collection_key
alert.suppress.period                = 86300s
action.threat_activity               = 1
action.threat_activity._threat_match = certificate_common_name
alert.track                          = false
cron_schedule                        = 0,30 * * * *
disabled                             = False
dispatch.earliest_time               = -45m@m
dispatch.latest_time                 = +0s
enableSched                          = True
is_visible                           = false
request.ui_dispatch_app              = SplunkEnterpriseSecuritySuite
search                               = | `tstats` values(sourcetype),values(All_Certificates.src),values(All_Certificates.dest) from datamodel=Certificates.All_Certificates by All_Certificates.SSL.ssl_issuer_common_name | eval certificate_common_name='All_Certificates.SSL.ssl_issuer_common_name' | eval threat_match_field="ssl_issuer_common_name" | `tstats` append=true values(sourcetype),values(All_Certificates.src),values(All_Certificates.dest) from datamodel=Certificates.All_Certificates by All_Certificates.SSL.ssl_subject_common_name | eval certificate_common_name=if(isnull(certificate_common_name),'All_Certificates.SSL.ssl_subject_common_name',certificate_common_name) | eval threat_match_field=if(isnull(threat_match_field),"ssl_subject_common_name",threat_match_field) | stats values(sourcetype) as sourcetype,values(All_Certificates.src) as src,values(All_Certificates.dest) as dest by certificate_common_name,threat_match_field | lookup update=true threatintel_by_certificate_common_name certificate_common_name OUTPUT | lookup update=true threatintel_by_certificate_common_name_wildcard certificate_common_name OUTPUTNEW | search threat_collection_key=* | `mvtruncate(src)` | `mvtruncate(dest)` | `zipexpand_threat_matches`

[Threat - Certificate Organization Matches - Threat Gen]
action.email.sendresults             = 0
alert.digest_mode                    = 1
alert.suppress                       = 1
alert.suppress.fields                = certificate_organization,threat_collection_key
alert.suppress.period                = 86300s
action.threat_activity               = 1
action.threat_activity._threat_match = certificate_organization
alert.track                          = false
cron_schedule                        = 5,35 * * * *
disabled                             = False
dispatch.earliest_time               = -45m@m
dispatch.latest_time                 = +0s
enableSched                          = True
is_visible                           = false
request.ui_dispatch_app              = SplunkEnterpriseSecuritySuite
search                               = | `tstats` values(sourcetype),values(All_Certificates.src),values(All_Certificates.dest) from datamodel=Certificates.All_Certificates by All_Certificates.SSL.ssl_issuer_organization | eval certificate_organization='All_Certificates.SSL.ssl_issuer_organization' | eval threat_match_field="ssl_issuer_organization" | `tstats` append=true values(sourcetype),values(All_Certificates.src),values(All_Certificates.dest) from datamodel=Certificates.All_Certificates by All_Certificates.SSL.ssl_subject_organization | eval certificate_organization=if(isnull(certificate_organization),'All_Certificates.SSL.ssl_subject_organization',certificate_organization) | eval threat_match_field=if(isnull(threat_match_field),"ssl_subject_organization",threat_match_field) | stats values(sourcetype) as sourcetype,values(All_Certificates.src) as src,values(All_Certificates.dest) as dest by certificate_organization,threat_match_field | lookup update=true threatintel_by_certificate_organization certificate_organization OUTPUT | lookup update=true threatintel_by_certificate_organization_wildcard certificate_organization OUTPUTNEW | search threat_collection_key=* | `mvtruncate(src)` | `mvtruncate(dest)` | `zipexpand_threat_matches`

[Threat - Certificate Serial Matches - Threat Gen]
action.email.sendresults             = 0
alert.digest_mode                    = 1
alert.suppress                       = 1
alert.suppress.fields                = certificate_serial,threat_collection_key
alert.suppress.period                = 86300s
action.threat_activity               = 1
action.threat_activity._threat_match = certificate_serial
alert.track                          = false
cron_schedule                        = 10,40 * * * *
disabled                             = False
dispatch.earliest_time               = -45m@m
dispatch.latest_time                 = +0s
enableSched                          = True
is_visible                           = false
request.ui_dispatch_app              = SplunkEnterpriseSecuritySuite
search                               = | tstats `summariesonly` values(sourcetype) as sourcetype,values(All_Certificates.src) as src,values(All_Certificates.dest) as dest from datamodel=Certificates.All_Certificates by All_Certificates.SSL.ssl_serial | rename All_Certificates.SSL.ssl_serial as certificate_serial | eval threat_match_value=certificate_serial | `get_certificate_serial` | lookup update=true threatintel_by_certificate_serial certificate_serial as certificate_serial_clean OUTPUT | search threat_collection_key=* | `mvtruncate(src)` | `mvtruncate(dest)` | `zipexpand_threat_matches`

[Threat - Certificate Unit Matches - Threat Gen]
action.email.sendresults             = 0
alert.digest_mode                    = 1
alert.suppress                       = 1
alert.suppress.fields                = certificate_unit,threat_collection_key
alert.suppress.period                = 86300s
action.threat_activity               = 1
action.threat_activity._threat_match = certificate_unit
alert.track                          = false
cron_schedule                        = 15,45 * * * *
disabled                             = False
dispatch.earliest_time               = -45m@m
dispatch.latest_time                 = +0s
enableSched                          = True
is_visible                           = false
request.ui_dispatch_app              = SplunkEnterpriseSecuritySuite
search                               = | `tstats` values(sourcetype),values(All_Certificates.src),values(All_Certificates.dest) from datamodel=Certificates.All_Certificates by All_Certificates.SSL.ssl_issuer_unit | eval certificate_unit='All_Certificates.SSL.ssl_issuer_unit' | eval threat_match_field="ssl_issuer_unit" | `tstats` append=true values(sourcetype),values(All_Certificates.src),values(All_Certificates.dest) from datamodel=Certificates.All_Certificates by All_Certificates.SSL.ssl_subject_unit | eval certificate_unit=if(isnull(certificate_unit),'All_Certificates.SSL.ssl_subject_unit',certificate_unit) | eval threat_match_field=if(isnull(threat_match_field),"ssl_subject_unit",threat_match_field) | stats values(sourcetype) as sourcetype,values(All_Certificates.src) as src,values(All_Certificates.dest) as dest by certificate_unit,threat_match_field | lookup update=true threatintel_by_certificate_unit certificate_unit OUTPUT | lookup update=true threatintel_by_certificate_unit_wildcard certificate_unit OUTPUTNEW | search threat_collection_key=* | `mvtruncate(src)` | `mvtruncate(dest)` | `zipexpand_threat_matches`

[Threat - Email Address Matches - Threat Gen]
action.email.sendresults             = 0
alert.digest_mode                    = 1
alert.suppress                       = 1
alert.suppress.fields                = email,threat_collection_key
alert.suppress.period                = 86300s
action.threat_activity               = 1
action.threat_activity._threat_match = email
alert.track                          = false
cron_schedule                        = 20,50 * * * *
disabled                             = False
dispatch.earliest_time               = -45m@m
dispatch.latest_time                 = +0s
enableSched                          = True
is_visible                           = false
request.ui_dispatch_app              = SplunkEnterpriseSecuritySuite
search                               = | `tstats` values(sourcetype),values(All_Certificates.src),values(All_Certificates.dest) from datamodel=Certificates.All_Certificates by All_Certificates.SSL.ssl_issuer_email | eval email='All_Certificates.SSL.ssl_issuer_email' | eval threat_match_field="ssl_issuer_email" | `tstats` append=true values(sourcetype),values(All_Certificates.src),values(All_Certificates.dest) from datamodel=Certificates.All_Certificates by All_Certificates.SSL.ssl_subject_email | eval email=if(isnull(email),'All_Certificates.SSL.ssl_subject_email',email) | eval threat_match_field=if(isnull(threat_match_field),"ssl_subject_email",threat_match_field) | `sistats_values_rename(All_Certificates.src,src)` | `sistats_values_rename(All_Certificates.dest,dest)` | `tstats` append=true values(sourcetype),values(All_Email.src),values(All_Email.dest) from datamodel=Email.All_Email by All_Email.src_user | eval email=if(isnull(email),'All_Email.src_user',email) | eval threat_match_field=if(isnull(threat_match_field),"src_user",threat_match_field) | `tstats` append=true values(sourcetype),values(All_Email.src),values(All_Email.dest) from datamodel=Email.All_Email by All_Email.recipient | eval email=if(isnull(email),'All_Email.recipient',email) | eval threat_match_field=if(isnull(threat_match_field),"recipient",threat_match_field) | `sistats_values_rename(All_Email.src,src)` | `sistats_values_rename(All_Email.dest,dest)` | stats values(sourcetype) as sourcetype,values(src) as src,values(dest) as dest by email,threat_match_field | extract cim_email_domain | `truncate_domain_dedup(email_domain,truncated_email_domain)` | lookup update=true threatintel_by_email email OUTPUT | lookup update=true threatintel_by_email_wildcard email OUTPUTNEW | lookup update=true threatintel_by_domain domain as email_domain OUTPUTNEW | lookup update=true threatintel_by_domain domain as truncated_email_domain OUTPUTNEW | search threat_collection_key=* | `mvtruncate(src)` | `mvtruncate(dest)` | `zipexpand_threat_matches` | table sourcetype,src,dest,email,threat*,weight

[Threat - Email Subject Matches - Threat Gen]
action.email.sendresults             = 0
alert.digest_mode                    = 1
alert.suppress                       = 1
alert.suppress.fields                = subject,threat_collection_key
alert.suppress.period                = 86300s
action.threat_activity               = 1
action.threat_activity._threat_match = subject
alert.track                          = false
cron_schedule                        = 25,55 * * * *
disabled                             = False
dispatch.earliest_time               = -45m@m
dispatch.latest_time                 = +0s
enableSched                          = True
is_visible                           = false
request.ui_dispatch_app              = SplunkEnterpriseSecuritySuite
search                               = | tstats `summariesonly` values(sourcetype) as sourcetype,values(All_Email.src) as src,values(All_Email.dest) as dest from datamodel=Email.All_Email by All_Email.subject | `drop_dm_object_name("All_Email")` | lookup update=true threatintel_by_email_subject subject OUTPUT | lookup update=true threatintel_by_email_subject_wildcard subject OUTPUTNEW | search threat_collection_key=* | `mvtruncate(src)` | `mvtruncate(dest)` | `zipexpand_threat_matches`

[Threat - File Hash Matches - Threat Gen]
action.email.sendresults             = 0
alert.digest_mode                    = 1
alert.suppress                       = 1
alert.suppress.fields                = file_hash,threat_collection_key
alert.suppress.period                = 86300s
action.threat_activity               = 1
action.threat_activity._threat_match = file_hash
alert.track                          = false
cron_schedule                        = 0,30 * * * *
disabled                             = False
dispatch.earliest_time               = -45m@m
dispatch.latest_time                 = +0s
enableSched                          = True
is_visible                           = false
request.ui_dispatch_app              = SplunkEnterpriseSecuritySuite
search                               = | `tstats` values(sourcetype),values(All_Certificates.src),values(All_Certificates.dest) from datamodel=Certificates.All_Certificates by All_Certificates.SSL.ssl_hash | eval file_hash='All_Certificates.SSL.ssl_hash' | eval threat_match_field="ssl_hash" | `sistats_values_rename(All_Certificates.src,src)` | `sistats_values_rename(All_Certificates.dest,dest)` | `tstats` append=true values(sourcetype),values(All_Changes.src),values(All_Changes.dest) from datamodel=Change_Analysis.All_Changes by All_Changes.Endpoint_Changes.Filesystem_Changes.file_hash | eval file_hash=if(isnull(file_hash),'All_Changes.Endpoint_Changes.Filesystem_Changes.file_hash',file_hash) | `sistats_values_rename(All_Changes.src,src)` | `sistats_values_rename(All_Changes.dest,dest)` | `tstats` append=true values(sourcetype),values(All_Email.src),values(All_Email.dest) from datamodel=Email.All_Email by All_Email.file_hash | eval file_hash=if(isnull(file_hash),'All_Email.file_hash',file_hash) | `sistats_values_rename(All_Email.src,src)` | `sistats_values_rename(All_Email.dest,dest)` | `tstats` append=true values(sourcetype),values(Malware_Attacks.src),values(Malware_Attacks.dest) from datamodel=Malware.Malware_Attacks by Malware_Attacks.file_hash | eval file_hash=if(isnull(file_hash),'Malware_Attacks.file_hash',file_hash) | `sistats_values_rename(Malware_Attacks.src,src)` | `sistats_values_rename(Malware_Attacks.dest,dest)` | `tstats` append=true values(sourcetype),values(Updates.src),values(Updates.dest) from datamodel=Updates.Updates by Updates.file_hash | eval file_hash=if(isnull(file_hash),'Updates.file_hash',file_hash) | eval threat_match_field=if(isnull(threat_match_field),"file_hash",threat_match_field) | `sistats_values_rename(Updates.src,src)` | `sistats_values_rename(Updates.dest,dest)` | stats values(sourcetype) as sourcetype,values(src) as src,values(dest) as dest by file_hash,threat_match_field | lookup update=true threatintel_by_file_hash file_hash OUTPUT | search threat_collection_key=* | `mvtruncate(src)` | `mvtruncate(dest)` | `zipexpand_threat_matches`

[Threat - File Name Matches - Threat Gen]
action.email.sendresults             = 0
alert.digest_mode                    = 1
alert.suppress                       = 1
alert.suppress.fields                = file_name,threat_collection_key
alert.suppress.period                = 86300s
action.threat_activity               = 1
action.threat_activity._threat_match = file_name
alert.track                          = false
cron_schedule                        = 5,35 * * * *
disabled                             = False
dispatch.earliest_time               = -45m@m
dispatch.latest_time                 = +0s
enableSched                          = True
is_visible                           = false
request.ui_dispatch_app              = SplunkEnterpriseSecuritySuite
search                               = | `tstats` values(sourcetype),values(All_Changes.src),values(All_Changes.dest) from datamodel=Change_Analysis.All_Changes by All_Changes.Endpoint_Changes.Filesystem_Changes.file_name | eval file_name=if(isnull(file_name),'All_Changes.Endpoint_Changes.Filesystem_Changes.file_name',file_name) | `sistats_values_rename(All_Changes.src,src)` | `sistats_values_rename(All_Changes.dest,dest)` | `tstats` append=true values(sourcetype),values(All_Email.src),values(All_Email.dest) from datamodel=Email.All_Email by All_Email.file_name | eval file_name=if(isnull(file_name),'All_Email.file_name',file_name) | `sistats_values_rename(All_Email.src,src)` | `sistats_values_rename(All_Email.dest,dest)` | `tstats` append=true values(sourcetype),values(Malware_Attacks.src),values(Malware_Attacks.dest) from datamodel=Malware.Malware_Attacks by Malware_Attacks.file_name | eval file_name=if(isnull(file_name),'Malware_Attacks.file_name',file_name) | `sistats_values_rename(Malware_Attacks.src,src)` | `sistats_values_rename(Malware_Attacks.dest,dest)` | `tstats` append=true values(sourcetype),values(Updates.src),values(Updates.dest) from datamodel=Updates.Updates by Updates.file_name | eval file_name=if(isnull(file_name),'Updates.file_name',file_name) | eval threat_match_field=if(isnull(threat_match_field),"file_name",threat_match_field) | `sistats_values_rename(Updates.src,src)` | `sistats_values_rename(Updates.dest,dest)` | stats values(sourcetype) as sourcetype,values(src) as src,values(dest) as dest by file_name,threat_match_field | lookup update=true threatintel_by_file_name file_name OUTPUT | lookup update=true threatintel_by_file_name_wildcard file_name OUTPUTNEW | search threat_collection_key=* | `mvtruncate(src)` | `mvtruncate(dest)` | `zipexpand_threat_matches`

[Threat - HTTP User Agent Matches - Threat Gen]
action.email.sendresults             = 0
alert.digest_mode                    = 1
alert.suppress                       = 1
alert.suppress.fields                = http_user_agent,threat_collection_key
alert.suppress.period                = 86300s
action.threat_activity               = 1
action.threat_activity._threat_match = http_user_agent
alert.track                          = false
cron_schedule                        = 10,40 * * * *
disabled                             = False
dispatch.earliest_time               = -45m@m
dispatch.latest_time                 = +0s
enableSched                          = True
is_visible                           = false
request.ui_dispatch_app              = SplunkEnterpriseSecuritySuite
search                               = | tstats `summariesonly` values(sourcetype) as sourcetype,values(Web.src) as src,values(Web.dest) as dest from datamodel=Web.Web by Web.http_user_agent | `drop_dm_object_name("Web")` | lookup update=true threatintel_by_http_user_agent http_user_agent OUTPUT | lookup update=true threatintel_by_http_user_agent_wildcard http_user_agent OUTPUTNEW | search threat_collection_key=* | `mvtruncate(src)` | `mvtruncate(dest)` | `zipexpand_threat_matches`

[Threat - Network Resolution Matches - Threat Gen]
action.email.sendresults             = 0
alert.digest_mode                    = 1
alert.suppress                       = 1
alert.suppress.fields                = query,answer,threat_collection_key
alert.suppress.period                = 86300s
action.threat_activity               = 1
## threat_match_field and threat_match_value set via eval
#action.threat_activity._threat_match =
alert.track                          = false
cron_schedule                        = 15,45 * * * *
disabled                             = False
dispatch.earliest_time               = -45m@m
dispatch.latest_time                 = +0s
enableSched                          = True
is_visible                           = false
request.ui_dispatch_app              = SplunkEnterpriseSecuritySuite
search                               = | `tstats` values(sourcetype),values(DNS.src),values(DNS.dest) from datamodel=Network_Resolution.DNS by DNS.query,DNS.answer | eval query='DNS.query' | eval answer='DNS.answer' | `tstats` append=true values(sourcetype) from datamodel=Domain_Analysis.All_Domains by All_Domains.domain,All_Domains.resolved_domain | eval query=if(isnull(query),'All_Domains.domain',query) | eval answer=if(isnull(answer),'All_Domains.resolved_domain',answer) | stats values(sourcetype) as sourcetype,values(DNS.src) as src,values(DNS.dest) as dest by query,answer | `threatintel_multilookup(query)` | `threatintel_multilookup(answer)` | search threat_collection_key=* | `mvtruncate(src)` | `mvtruncate(dest)` | `zipexpand_threat_matches` | table sourcetype,src,dest,query,answer,threat*,weight

[Threat - Process Matches - Threat Gen]
action.email.sendresults             = 0
alert.digest_mode                    = 1
alert.suppress                       = 1
alert.suppress.fields                = process,threat_collection_key
alert.suppress.period                = 86300s
action.threat_activity               = 1
action.threat_activity._threat_match = process
alert.track                          = false
cron_schedule                        = 20,50 * * * *
disabled                             = False
dispatch.earliest_time               = -45m@m
dispatch.latest_time                 = +0s
enableSched                          = True
is_visible                           = false
request.ui_dispatch_app              = SplunkEnterpriseSecuritySuite
search                               = | tstats `summariesonly` values(sourcetype) as sourcetype,values(All_Application_State.dest) as dest from datamodel=Application_State.All_Application_State by All_Application_State.process_name | rename All_Application_State.process_name as process | lookup update=true threatintel_by_process process OUTPUT | lookup update=true threatintel_by_process_wildcard process OUTPUTNEW | lookup update=true threatintel_by_file_name file_name as process OUTPUTNEW | lookup update=true threatintel_by_file_name_wildcard file_name as process OUTPUTNEW | search threat_collection_key=* | `mvtruncate(dest)` | `zipexpand_threat_matches`

[Threat - Registry Path Matches - Threat Gen]
action.email.sendresults             = 0
alert.digest_mode                    = 1
alert.suppress                       = 1
alert.suppress.fields                = registry_path,threat_collection_key
alert.suppress.period                = 86300s
action.threat_activity               = 1
action.threat_activity._threat_match = registry_path
alert.track                          = false
cron_schedule                        = 25,55 * * * *
disabled                             = False
dispatch.earliest_time               = -45m@m
dispatch.latest_time                 = +0s
enableSched                          = True
is_visible                           = false
request.ui_dispatch_app              = SplunkEnterpriseSecuritySuite
search                               = sourcetype=WinRegistry | stats values(sourcetype) as sourcetype,values(dest) as dest by registry_path | lookup update=true threatintel_by_registry_path registry_path OUTPUT | lookup update=true threatintel_by_registry_path_wildcard registry_path OUTPUTNEW | search threat_collection_key=* | `mvtruncate(dest)` | `zipexpand_threat_matches`

[Threat - Registry Value Name Matches - Threat Gen]
action.email.sendresults             = 0
alert.digest_mode                    = 1
alert.suppress                       = 1
alert.suppress.fields                = registry_value_name,threat_collection_key
alert.suppress.period                = 86300s
action.threat_activity               = 1
action.threat_activity._threat_match = registry_value_name
alert.track                          = false
cron_schedule                        = 0,30 * * * *
disabled                             = False
dispatch.earliest_time               = -45m@m
dispatch.latest_time                 = +0s
enableSched                          = True
is_visible                           = false
request.ui_dispatch_app              = SplunkEnterpriseSecuritySuite
search                               = sourcetype=WinRegistry | stats values(sourcetype) as sourcetype,values(dest) as dest by registry_value_data | lookup update=true threatintel_by_registry_value_name registry_value_name OUTPUT | lookup update=true threatintel_by_registry_value_name_wildcard registry_value_name OUTPUTNEW | search threat_collection_key=* | `mvtruncate(dest)` | `zipexpand_threat_matches`

[Threat - Registry Value Text Matches - Threat Gen]
action.email.sendresults             = 0
alert.digest_mode                    = 1
alert.suppress                       = 1
alert.suppress.fields                = registry_value_text,threat_collection_key
alert.suppress.period                = 86300s
action.threat_activity               = 1
action.threat_activity._threat_match = registry_value_text
alert.track                          = false
cron_schedule                        = 5,35 * * * *
disabled                             = False
dispatch.earliest_time               = -45m@m
dispatch.latest_time                 = +0s
enableSched                          = True
is_visible                           = false
request.ui_dispatch_app              = SplunkEnterpriseSecuritySuite
search                               = sourcetype=WinRegistry | stats values(sourcetype) as sourcetype,values(dest) as dest by registry_value_data | rename registry_value_data as registry_value_text | lookup update=true threatintel_by_registry_value_text registry_value_text OUTPUT | lookup update=true threatintel_by_registry_value_text_wildcard registry_value_text OUTPUTNEW | search threat_collection_key=* | `mvtruncate(dest)` | `zipexpand_threat_matches`

[Threat - Service Matches - Threat Gen]
action.email.sendresults             = 0
alert.digest_mode                    = 1
alert.suppress                       = 1
alert.suppress.fields                = service,threat_collection_key
alert.suppress.period                = 86300s
action.threat_activity               = 1
action.threat_activity._threat_match = service
alert.track                          = false
cron_schedule                        = 10,40 * * * *
disabled                             = False
dispatch.earliest_time               = -45m@m
dispatch.latest_time                 = +0s
enableSched                          = True
is_visible                           = false
request.ui_dispatch_app              = SplunkEnterpriseSecuritySuite
search                               = | tstats `summariesonly` values(sourcetype) as sourcetype,values(All_Application_State.dest) as dest from datamodel=Application_State.All_Application_State by All_Application_State.Services.service | rename All_Application_State.Services.service as service | lookup update=true threatintel_by_service service OUTPUT | lookup update=true threatintel_by_service_wildcard service OUTPUTNEW | search threat_collection_key=* | `mvtruncate(dest)` | `zipexpand_threat_matches`

[Threat - Source And Destination Matches - Threat Gen]
action.email.sendresults             = 0
alert.digest_mode                    = 1
alert.suppress                       = 1
alert.suppress.fields                = src,dest,threat_collection_key
alert.suppress.period                = 86300s
action.threat_activity               = 1
## threat_match_field and threat_match_value set via eval
#action.threat_activity._threat_match =
alert.track                          = false
cron_schedule                        = 15,45 * * * *
disabled                             = False
dispatch.earliest_time               = -45m@m
dispatch.latest_time                 = +0s
enableSched                          = True
is_visible                           = false
request.ui_dispatch_app              = SplunkEnterpriseSecuritySuite
search                               = | `src_dest_tstats("allowed")` | `threatintel_multilookup(src)` | `threatintel_multilookup(dest)` | search threat_collection_key=* | fields - count | `zipexpand_threat_matches` | fields sourcetype,src,dest,threat*,weight

[Threat - URL Matches - Threat Gen]
action.email.sendresults             = 0
alert.digest_mode                    = 1
alert.suppress                       = 1
alert.suppress.fields                = url,threat_collection_key
alert.suppress.period                = 86300s
action.threat_activity               = 1
action.threat_activity._threat_match = url
alert.track                          = false
cron_schedule                        = 20,50 * * * *
disabled                             = False
dispatch.earliest_time               = -45m@m
dispatch.latest_time                 = +0s
enableSched                          = True
is_visible                           = false
request.ui_dispatch_app              = SplunkEnterpriseSecuritySuite
search                               = | `tstats` values(sourcetype) as sourcetype,values(Web.src),values(Web.dest) from datamodel=Web.Web by Web.http_referrer | eval url='Web.http_referrer' | eval threat_match_field="http_referrer" | `tstats` append=true values(sourcetype) as sourcetype,values(Web.src),values(Web.dest) from datamodel=Web.Web by Web.url | eval url=if(isnull(url),'Web.url',url) | eval threat_match_field=if(isnull(threat_match_field),"url",threat_match_field) | stats values(sourcetype) as sourcetype,values(Web.src) as src,values(Web.dest) as dest by url,threat_match_field | extract domain_from_url | `threatintel_url_lookup(url)` | `threatintel_domain_lookup(url_domain)` | search threat_collection_key=* | `mvtruncate(src)` | `mvtruncate(dest)` | `zipexpand_threat_matches`

[Threat - User Matches - Threat Gen]
action.email.sendresults             = 0
alert.digest_mode                    = 1
alert.suppress                       = 1
alert.suppress.fields                = user,threat_collection_key
alert.suppress.period                = 86300s
action.threat_activity               = 1
action.threat_activity._threat_match = user
alert.track                          = false
cron_schedule                        = 25,55 * * * *
disabled                             = False
dispatch.earliest_time               = -45m@m
dispatch.latest_time                 = +0s
enableSched                          = True
is_visible                           = false
request.ui_dispatch_app              = SplunkEnterpriseSecuritySuite
search                               = | `tstats` values(sourcetype),values(Authentication.src),values(Authentication.dest) from datamodel=Authentication.Authentication by Authentication.src_user | eval user='Authentication.src_user' | eval threat_match_field="src_user" | `tstats` append=true values(sourcetype),values(Authentication.src),values(Authentication.dest) from datamodel=Authentication.Authentication by Authentication.user | eval user=if(isnull(user),'Authentication.user',user) | `sistats_values_rename(Authentication.src,src)` | `sistats_values_rename(Authentication.dest,dest)` | `tstats` append=true values(sourcetype),values(All_Inventory.src),values(All_Inventory.dest) from datamodel=Compute_Inventory.All_Inventory by All_Inventory.User.user | eval user=if(isnull(user),'All_Inventory.User.user',user) | eval threat_match_field=if(isnull(threat_match_field),"user",threat_match_field) | `sistats_values_rename(All_Inventory.src,src)` | `sistats_values_rename(All_Inventory.dest,dest)` | `tstats` append=true values(sourcetype),values(Web.src),values(Web.dest) from datamodel=Web.Web by Web.user | eval user=if(isnull(user),'Web.user',user) | `sistats_values_rename(Web.src,src)` | `sistats_values_rename(Web.dest,dest)` | stats values(sourcetype) as sourcetype,values(src) as src,values(dest) as dest by user,threat_match_field | lookup update=true threatintel_by_user user OUTPUT | lookup update=true threatintel_by_user_wildcard user OUTPUTNEW | search threat_collection_key=* | `mvtruncate(src)` | `mvtruncate(dest)` | `zipexpand_threat_matches`
